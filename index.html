<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vismaya Education Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .auth-container {
            max-width: 450px;
            margin: 100px auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }
        .auth-header { text-align: center; margin-bottom: 30px; }
        .auth-header h1 { color: #667eea; font-size: 2em; margin-bottom: 10px; }
        .auth-header p { color: #666; font-size: 0.95em; }
        .auth-form { display: flex; flex-direction: column; gap: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 8px; font-weight: 600; color: #333; }
        .form-group input { padding: 14px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em; transition: border-color 0.3s; }
        .form-group input:focus { outline: none; border-color: #667eea; }
        .form-group select { padding: 14px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em; transition: border-color 0.3s; }
        .auth-btn {
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 8px;
            font-size: 1.1em; font-weight: 600; cursor: pointer; transition: all 0.3s; margin-top: 10px;
        }
        .auth-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102,126,234,0.4); }
        .auth-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .auth-link { text-align: center; margin-top: 20px; color: #666; font-size: 0.9em; }
        .auth-link a { color: #667eea; text-decoration: none; font-weight: 600; cursor: pointer; }
        .auth-link a:hover { text-decoration: underline; }
        .error-message, .success-message { padding: 12px; border-radius: 8px; font-size: 0.9em; text-align: center; display: none; }
        .error-message { background: #f8d7da; color: #721c24; }
        .success-message { background: #d4edda; color: #155724; }
        .error-message.show, .success-message.show { display: block; }
        .logout-btn { background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .logout-btn:hover { background: #c82333; transform: translateY(-2px); }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 20px 30px;
            display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;
        }
        .header-content h1 { font-size: 1.8em; margin-bottom: 5px; }
        .header-content p { opacity: 0.9; font-size: 0.95em; }
        .user-info { text-align: right; }
        .user-info p { margin-bottom: 5px; opacity: 0.9; }
        .role-badge { display: inline-block; padding: 4px 12px; background: rgba(255,255,255,0.2); border-radius: 12px; font-size: 0.85em; margin-top: 5px; }
        .loading { text-align: center; padding: 20px; color: #667eea; font-size: 1.2em; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; padding: 30px; background: #f8f9fa; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; }
        .stat-card h3 { color: #667eea; font-size: 2em; margin-bottom: 5px; }
        .stat-card p { color: #666; font-size: 0.9em; }
        .tabs { display: flex; background: #f8f9fa; padding: 0 30px; border-bottom: 2px solid #e0e0e0; overflow-x: auto; }
        .tab { padding: 15px 25px; cursor: pointer; border: none; background: transparent; font-size: 0.95em; font-weight: 600; color: #666; transition: all 0.3s; border-bottom: 3px solid transparent; white-space: nowrap; }
        .tab.active { color: #667eea; border-bottom-color: #667eea; }
        .tab:hover { background: rgba(102,126,234,0.1); }
        .tab-content { display: none; padding: 30px; }
        .tab-content.active { display: block; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .btn { padding: 12px 30px; border: none; border-radius: 8px; font-size: 1em; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102,126,234,0.4); }
        .btn-whatsapp { background: #25D366; color: white; display: inline-flex; align-items: center; gap: 5px; }
        .btn-whatsapp:hover { background: #128C7E; transform: translateY(-2px); }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover:not(:disabled) { background: #218838; transform: translateY(-2px); }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-info:hover:not(:disabled) { background: #138496; transform: translateY(-2px); }
        .table-container { overflow-x: auto; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #e0e0e0; }
        th { background: #f8f9fa; font-weight: 600; color: #333; }
        tr:hover { background: #f8f9fa; }
        .badge { padding: 5px 10px; border-radius: 20px; font-size: 0.85em; font-weight: 600; }
        .badge-active { background: #d4edda; color: #155724; }
        .badge-inactive { background: #f8d7da; color: #721c24; }
        .badge-paid { background: #d4edda; color: #155724; }
        .badge-pending { background: #fff3cd; color: #856404; }
        .badge-new { background: #cce5ff; color: #004085; }
        .badge-followup { background: #fff3cd; color: #856404; }
        .badge-interested { background: #d4edda; color: #155724; }
        .badge-notinterested { background: #f8d7da; color: #721c24; }
        .badge-converted { background: #d1ecf1; color: #0c5460; }
        .search-box { padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em; width: 100%; max-width: 400px; margin-bottom: 20px; }
        .sort-controls { display: flex; gap: 10px; align-items: center; margin-bottom: 20px; flex-wrap: wrap; }
        .sort-controls label { font-weight: 600; color: #333; }
        .sort-controls select { padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95em; cursor: pointer; }
        .action-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { color: #667eea; }
        .close-btn { background: none; border: none; font-size: 1.5em; cursor: pointer; color: #666; }
        .receipt { border: 2px solid #667eea; padding: 20px; border-radius: 10px; margin-top: 20px; }
        .receipt-header { text-align: center; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 2px dashed #667eea; }
        .receipt-details { margin-bottom: 20px; }
        .receipt-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #e0e0e0; }
        .receipt-total { font-size: 1.3em; font-weight: 700; color: #667eea; }
        .readonly-notice { background: #fff3cd; color: #856404; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; font-weight: 600; }
        #loginPage, #signupPage, #resetPage { display: none; }
        #mainApp { display: none; }
        .inquiry-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .inquiry-stat { background: white; border-radius: 12px; padding: 18px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.08); border-top: 4px solid #667eea; }
        .inquiry-stat.new-color { border-top-color: #17a2b8; }
        .inquiry-stat.followup-color { border-top-color: #ffc107; }
        .inquiry-stat.interested-color { border-top-color: #28a745; }
        .inquiry-stat.notinterested-color { border-top-color: #dc3545; }
        .inquiry-stat.converted-color { border-top-color: #667eea; }
        .inquiry-stat h3 { font-size: 1.8em; font-weight: 700; margin-bottom: 4px; }
        .inquiry-stat p { font-size: 0.8em; color: #666; }
        .inquiry-stat.new-color h3 { color: #17a2b8; }
        .inquiry-stat.followup-color h3 { color: #ffc107; }
        .inquiry-stat.interested-color h3 { color: #28a745; }
        .inquiry-stat.notinterested-color h3 { color: #dc3545; }
        .inquiry-stat.converted-color h3 { color: #667eea; }
        .convert-modal-content { background: white; padding: 30px; border-radius: 15px; max-width: 700px; width: 95%; max-height: 90vh; overflow-y: auto; }
        .convert-notice { background: #d1ecf1; color: #0c5460; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-weight: 600; border-left: 4px solid #17a2b8; }
        .accounts-month-selector { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 25px; display: flex; align-items: center; gap: 20px; flex-wrap: wrap; }
        .accounts-month-selector label { font-weight: 600; color: #333; font-size: 1em; }
        .accounts-month-selector input[type="month"] { padding: 10px 15px; border: 2px solid #667eea; border-radius: 8px; font-size: 1em; color: #333; }
        .accounts-summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .accounts-card { padding: 25px 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); position: relative; overflow: hidden; }
        .accounts-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; }
        .accounts-card.income { background: #f0fff4; }
        .accounts-card.income::before { background: #28a745; }
        .accounts-card.expense-card { background: #fff5f5; }
        .accounts-card.expense-card::before { background: #dc3545; }
        .accounts-card.salary-card { background: #fff8f0; }
        .accounts-card.salary-card::before { background: #fd7e14; }
        .accounts-card.profit { background: #f0f4ff; }
        .accounts-card.profit::before { background: #667eea; }
        .accounts-card-icon { font-size: 2em; margin-bottom: 10px; }
        .accounts-card-label { font-size: 0.9em; color: #666; margin-bottom: 8px; font-weight: 500; }
        .accounts-card-value { font-size: 1.9em; font-weight: 700; }
        .accounts-card.income .accounts-card-value { color: #28a745; }
        .accounts-card.expense-card .accounts-card-value { color: #dc3545; }
        .accounts-card.salary-card .accounts-card-value { color: #fd7e14; }
        .accounts-card.profit .accounts-card-value { color: #667eea; }
        .accounts-breakdown { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 30px; }
        @media (max-width: 768px) { .accounts-breakdown { grid-template-columns: 1fr; } }
        .accounts-breakdown-card { background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); overflow: hidden; }
        .accounts-breakdown-header { padding: 15px 20px; font-weight: 700; font-size: 1em; color: white; }
        .accounts-breakdown-header.green { background: linear-gradient(135deg, #28a745, #20c997); }
        .accounts-breakdown-header.red { background: linear-gradient(135deg, #dc3545, #e83e8c); }
        .accounts-breakdown-header.orange { background: linear-gradient(135deg, #fd7e14, #ffc107); }
        .accounts-breakdown-body { padding: 10px 0; }
        .accounts-breakdown-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; border-bottom: 1px solid #f0f0f0; font-size: 0.92em; }
        .accounts-breakdown-row:last-child { border-bottom: none; }
        .accounts-breakdown-row:hover { background: #f8f9fa; }
        .accounts-breakdown-row .row-label { color: #444; }
        .accounts-breakdown-row .row-amount { font-weight: 600; }
        .accounts-breakdown-row .row-amount.green { color: #28a745; }
        .accounts-breakdown-row .row-amount.red { color: #dc3545; }
        .accounts-breakdown-row .row-amount.orange { color: #fd7e14; }
        .accounts-breakdown-empty { padding: 20px; text-align: center; color: #999; font-size: 0.9em; }
        .accounts-breakdown-total { display: flex; justify-content: space-between; align-items: center; padding: 14px 20px; background: #f8f9fa; font-weight: 700; font-size: 1em; border-top: 2px solid #e0e0e0; }
        .net-result-banner { border-radius: 12px; padding: 25px 30px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 30px; }
        .net-result-banner.profit-banner { background: linear-gradient(135deg, #28a745, #20c997); color: white; }
        .net-result-banner.loss-banner { background: linear-gradient(135deg, #dc3545, #e83e8c); color: white; }
        .net-result-banner .net-label { font-size: 1.1em; opacity: 0.9; }
        .net-result-banner .net-value { font-size: 2.2em; font-weight: 700; }
        .net-result-banner .net-formula { font-size: 0.9em; opacity: 0.8; margin-top: 4px; }
        .monthly-history-table th { background: #f8f9fa; }
        .monthly-history-table tr.profit-row td { background: #f0fff4; }
        .monthly-history-table tr.loss-row td { background: #fff5f5; }
        .reminder-info { font-size: 0.85em; color: #666; }
        .reminder-count { font-weight: 600; color: #667eea; }
        .reminder-date { font-size: 0.8em; color: #999; display: block; margin-top: 2px; }

        /* =============================================
           BATCH 2026 INQUIRY TAB STYLES
        ============================================= */
        .b26-header-banner {
            background: linear-gradient(135deg, #3a1c71 0%, #6b2d7f 60%, #d76d77 100%);
            border-radius: 16px;
            padding: 28px 30px;
            color: white;
            margin-bottom: 28px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .b26-header-banner h2 { font-size: 1.6em; margin-bottom: 6px; }
        .b26-header-banner p { opacity: 0.85; font-size: 0.92em; }
        .b26-tags { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
        .b26-tag { padding: 4px 14px; border-radius: 100px; font-size: 0.8em; font-weight: 600; }
        .b26-tag-10 { background: rgba(215,109,119,0.5); border: 1px solid rgba(215,109,119,0.8); }
        .b26-tag-12 { background: rgba(255,175,123,0.4); border: 1px solid rgba(255,175,123,0.8); }
        .b26-tag-batch { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); }
        .b26-stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 28px; }
        .b26-stat { background: white; border-radius: 12px; padding: 18px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.08); border-top: 4px solid #667eea; }
        .b26-stat.s10 { border-top-color: #d76d77; }
        .b26-stat.s12 { border-top-color: #ffaf7b; }
        .b26-stat.stotal { border-top-color: #3a1c71; }
        .b26-stat.snew { border-top-color: #17a2b8; }
        .b26-stat.sconv { border-top-color: #28a745; }
        .b26-stat h3 { font-size: 1.7em; font-weight: 700; margin-bottom: 4px; }
        .b26-stat p { font-size: 0.78em; color: #666; }
        .b26-stat.stotal h3 { color: #3a1c71; }
        .b26-stat.s10 h3 { color: #d76d77; }
        .b26-stat.s12 h3 { color: #d67a2b; }
        .b26-stat.snew h3 { color: #17a2b8; }
        .b26-stat.sconv h3 { color: #28a745; }

        .b26-form-card { background: #f8f9fa; border-radius: 14px; padding: 28px; margin-bottom: 28px; border: 1px solid #e8dff5; }
        .b26-section-title { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
        .b26-section-num { width: 28px; height: 28px; background: linear-gradient(135deg, #3a1c71, #d76d77); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8em; font-weight: 700; flex-shrink: 0; }
        .b26-section-name { font-size: 1em; font-weight: 700; color: #3a1c71; }
        .b26-form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; margin-bottom: 16px; }
        .b26-field { display: flex; flex-direction: column; gap: 6px; }
        .b26-field label { font-size: 0.8em; font-weight: 600; color: #7a6d8a; text-transform: uppercase; letter-spacing: 0.04em; }
        .b26-field label .req { color: #d76d77; }
        .b26-field input, .b26-field select, .b26-field textarea {
            padding: 11px 14px; border: 2px solid #e0d5f0; border-radius: 10px;
            font-size: 0.93em; color: #333; background: white; font-family: inherit;
            transition: border-color 0.2s; outline: none;
        }
        .b26-field input:focus, .b26-field select:focus, .b26-field textarea:focus { border-color: #d76d77; }
        .b26-field textarea { resize: vertical; min-height: 70px; }

        .b26-std-toggle { display: flex; gap: 12px; }
        .b26-std-btn {
            flex: 1; padding: 14px; border: 2px solid #e0d5f0; border-radius: 12px;
            cursor: pointer; text-align: center; transition: all 0.2s; background: white; user-select: none;
        }
        .b26-std-btn .icon { font-size: 1.5em; margin-bottom: 4px; }
        .b26-std-btn .title { font-weight: 700; font-size: 0.92em; color: #333; }
        .b26-std-btn .sub { font-size: 0.75em; color: #999; }
        .b26-std-btn.selected { border-color: #d76d77; background: linear-gradient(135deg, #fdf0f2, #f5f0ff); }
        .b26-std-btn.selected .title { color: #3a1c71; }

        .b26-radio-group { display: flex; flex-wrap: wrap; gap: 8px; }
        .b26-radio-opt {
            display: flex; align-items: center; gap: 7px; padding: 8px 14px;
            border: 2px solid #e0d5f0; border-radius: 100px; cursor: pointer;
            font-size: 0.87em; font-weight: 500; color: #666; background: white; user-select: none; transition: all 0.2s;
        }
        .b26-radio-opt:hover { border-color: #d76d77; }
        .b26-radio-opt input { display: none; }
        .b26-radio-opt.selected { border-color: #d76d77; background: #fdf0f2; color: #3a1c71; font-weight: 600; }

        .b26-check-group { display: flex; flex-wrap: wrap; gap: 8px; }
        .b26-check-opt {
            display: flex; align-items: center; gap: 7px; padding: 8px 14px;
            border: 2px solid #e0d5f0; border-radius: 100px; cursor: pointer;
            font-size: 0.87em; font-weight: 500; color: #666; background: white; user-select: none; transition: all 0.2s;
        }
        .b26-check-opt input { display: none; }
        .b26-check-opt.selected { border-color: #d76d77; background: #fdf0f2; color: #3a1c71; font-weight: 600; }

        .b26-subject-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 8px; }
        .b26-subject-card {
            padding: 10px 12px; border: 2px solid #e0d5f0; border-radius: 10px;
            cursor: pointer; display: flex; align-items: center; gap: 8px;
            background: white; user-select: none; transition: all 0.2s; font-size: 0.87em; font-weight: 500; color: #555;
        }
        .b26-subject-card.selected { border-color: #d76d77; background: #fdf0f2; color: #3a1c71; font-weight: 600; }

        .b26-conditional { display: none; }
        .b26-conditional.show { display: block; animation: b26fadeIn 0.3s ease; }
        @keyframes b26fadeIn { from { opacity:0; transform:translateY(-8px); } to { opacity:1; transform:translateY(0); } }

        .b26-table-badge { padding: 3px 10px; border-radius: 100px; font-size: 0.8em; font-weight: 600; display: inline-block; }
        .b26-badge-10 { background: #fde8ec; color: #a0283a; }
        .b26-badge-12 { background: #fff3e0; color: #8a4a00; }
        .b26-badge-new { background: #e0f4ff; color: #0a5275; }
        .b26-badge-contacted { background: #fff3cd; color: #856404; }
        .b26-badge-converted { background: #d4edda; color: #155724; }
        .b26-badge-notinterested { background: #f8d7da; color: #721c24; }

        .b26-filters { background: #f8f9fa; padding: 16px 20px; border-radius: 10px; margin-bottom: 18px; display: flex; gap: 14px; align-items: center; flex-wrap: wrap; }
        .b26-filters select, .b26-filters input[type="text"] {
            padding: 9px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.92em; outline: none;
        }

        .b26-detail-modal { background: white; padding: 30px; border-radius: 15px; max-width: 750px; width: 95%; max-height: 90vh; overflow-y: auto; }
        .b26-detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
        @media (max-width: 600px) { .b26-detail-grid { grid-template-columns: 1fr; } }
        .b26-detail-row { background: #f8f9fa; padding: 10px 14px; border-radius: 8px; }
        .b26-detail-row label { font-size: 0.75em; font-weight: 600; color: #999; text-transform: uppercase; display: block; margin-bottom: 3px; }
        .b26-detail-row span { font-size: 0.92em; color: #333; font-weight: 500; }

        @media print {
            body * { visibility: hidden; }
            .receipt, .receipt * { visibility: visible; }
            .receipt { position: absolute; left: 0; top: 0; }
        }
    </style>
</head>
<body>

<!-- Login Page -->
<div id="loginPage">
    <div class="auth-container">
        <div class="auth-header">
            <h1>üìö Vismaya Education</h1>
            <p>Fee Collection & Management System</p>
        </div>
        <div id="loginError" class="error-message"></div>
        <form id="loginForm" class="auth-form">
            <div class="form-group">
                <label>Email Address</label>
                <input type="email" id="loginEmail" required placeholder="Enter your email">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="loginPassword" required placeholder="Enter your password">
            </div>
            <button type="submit" class="auth-btn" id="loginBtn">Login</button>
        </form>
        <div class="auth-link"><a onclick="showPage('resetPage')">Forgot Password?</a></div>
        <div class="auth-link">Don't have an account? <a onclick="showPage('signupPage')">Sign Up</a></div>
    </div>
</div>

<!-- Signup Page -->
<div id="signupPage">
    <div class="auth-container">
        <div class="auth-header">
            <h1>üìö Create Account</h1>
            <p>Join Vismaya Education Dashboard</p>
        </div>
        <div id="signupError" class="error-message"></div>
        <div id="signupSuccess" class="success-message"></div>
        <form id="signupForm" class="auth-form">
            <div class="form-group"><label>Full Name</label><input type="text" id="signupName" required placeholder="Enter your name"></div>
            <div class="form-group"><label>Email Address</label><input type="email" id="signupEmail" required placeholder="Enter your email"></div>
            <div class="form-group"><label>Password</label><input type="password" id="signupPassword" required placeholder="Create a password (min 6 characters)"></div>
            <div class="form-group">
                <label>Role</label>
                <select id="signupRole" required>
                    <option value="">Select your role</option>
                    <option value="staff">Staff (Read Only)</option>
                    <option value="admin">Admin (Full Access)</option>
                </select>
            </div>
            <button type="submit" class="auth-btn" id="signupBtn">Create Account</button>
        </form>
        <div class="auth-link">Already have an account? <a onclick="showPage('loginPage')">Login</a></div>
    </div>
</div>

<!-- Password Reset Page -->
<div id="resetPage">
    <div class="auth-container">
        <div class="auth-header">
            <h1>üîí Reset Password</h1>
            <p>Enter your email to receive reset instructions</p>
        </div>
        <div id="resetError" class="error-message"></div>
        <div id="resetSuccess" class="success-message"></div>
        <form id="resetForm" class="auth-form">
            <div class="form-group"><label>Email Address</label><input type="email" id="resetEmail" required placeholder="Enter your email"></div>
            <button type="submit" class="auth-btn" id="resetBtn">Send Reset Link</button>
        </form>
        <div class="auth-link">Remember your password? <a onclick="showPage('loginPage')">Login</a></div>
    </div>
</div>

<!-- Main Application -->
<div id="mainApp">
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>üìö Vismaya Education Dashboard</h1>
                <p>Fee Collection & Management System</p>
            </div>
            <div class="user-info">
                <p>üë§ <span id="userName"></span></p>
                <p><span id="userEmail"></span></p>
                <span class="role-badge" id="userRole"></span>
                <div style="margin-top: 10px;">
                    <button class="logout-btn" onclick="logout()">Logout</button>
                </div>
            </div>
        </div>

        <div class="loading" id="loadingIndicator">‚è≥ Loading data from cloud...</div>

        <div id="mainContent" style="display: none;">
            <div id="staffNotice" class="readonly-notice" style="display: none;">
                üìñ You are logged in as STAFF with read-only access. Contact an admin for write permissions.
            </div>

            <div class="stats-grid">
                <div class="stat-card"><h3 id="totalStudents">0</h3><p>Total Students</p></div>
                <div class="stat-card"><h3 id="paidStudents">0</h3><p>Students Paid</p></div>
                <div class="stat-card"><h3 id="pendingStudents">0</h3><p>Students Pending</p></div>
                <div class="stat-card"><h3 id="totalCollected">‚Çπ0</h3><p>Collected This Month</p></div>
                <div class="stat-card"><h3 id="totalPending">‚Çπ0</h3><p>Pending Fees</p></div>
                <div class="stat-card"><h3 id="thisMonth">‚Çπ0</h3><p>Total Expected (This Month)</p></div>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="switchTab('students', this)">Students</button>
                <button class="tab" onclick="switchTab('fees', this)">Fee Collection</button>
                <button class="tab" onclick="switchTab('teachers', this)">Teachers</button>
                <button class="tab" onclick="switchTab('expenses', this)">Expenses</button>
                <button class="tab" onclick="switchTab('accounts', this)">Accounts</button>
                <button class="tab" onclick="switchTab('inquiries', this)">üîç Inquiry</button>
                <button class="tab" onclick="switchTab('batch2026', this)">üéì Batch 2026</button>
                <button class="tab" onclick="switchTab('reports', this)">Reports</button>
            </div>

            <!-- Students Tab -->
            <div id="students" class="tab-content active">
                <div id="studentFormSection">
                    <h2 style="margin-bottom: 20px;">Add Students</h2>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 30px;">
                        <h3 style="margin-bottom: 15px; color: #667eea;">üì§ Bulk Upload from Excel</h3>
                        <p style="margin-bottom: 15px; color: #666;">Upload an Excel file (.xlsx or .xls) to add multiple students at once.</p>
                        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                            <input type="file" id="excelFile" accept=".xlsx,.xls" style="padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                            <button type="button" class="btn btn-success" onclick="uploadExcel()">Upload & Import</button>
                            <button type="button" class="btn btn-primary" onclick="downloadTemplate()">üì• Download Template</button>
                        </div>
                        <div id="uploadStatus" style="margin-top: 15px; padding: 10px; border-radius: 5px; display: none;"></div>
                    </div>
                    <h3 style="margin-bottom: 20px;">‚ûï Add Single Student</h3>
                    <form id="studentForm">
                        <div class="form-grid">
                            <div class="form-group"><label>Student Name *</label><input type="text" id="studentName" required></div>
                            <div class="form-group"><label>Roll Number *</label><input type="text" id="rollNumber" required></div>
                            <div class="form-group">
                                <label>Class *</label>
                                <select id="course" required>
                                    <option value="">Select Class</option>
                                    <option>Class 1</option><option>Class 2</option><option>Class 3</option><option>Class 4</option>
                                    <option>Class 5</option><option>Class 6</option><option>Class 7</option><option>Class 8</option>
                                    <option>Class 9</option><option>Class 10</option><option>Class 11</option><option>Class 12</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Syllabus (Optional)</label>
                                <select id="syllabus">
                                    <option value="">Select Syllabus</option>
                                    <option value="CBSE">CBSE</option>
                                    <option value="Matric">Matric</option>
                                </select>
                            </div>
                            <div class="form-group"><label>Phone Number *</label><input type="tel" id="phoneNumber" required></div>
                            <div class="form-group"><label>Monthly Fee (‚Çπ) *</label><input type="number" id="monthlyFee" required></div>
                            <div class="form-group"><label>Admission Date (Optional)</label><input type="date" id="admissionDate"></div>
                            <div class="form-group">
                                <label>Status *</label>
                                <select id="studentStatus" required>
                                    <option value="">Select Status</option>
                                    <option value="Active">Active</option>
                                    <option value="Inactive">Inactive</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Student</button>
                    </form>
                </div>
                <h2 style="margin-top: 40px; margin-bottom: 20px;">All Students</h2>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                    <div style="flex: 1; min-width: 250px;">
                        <input type="text" class="search-box" placeholder="Search by name or roll number..." id="studentSearch" style="margin-bottom: 0; max-width: 100%;">
                    </div>
                    <div class="sort-controls">
                        <label>Sort By:</label>
                        <select id="sortField" onchange="updateStudentTable()">
                            <option value="rollNumber">Roll Number</option>
                            <option value="name">Name</option>
                            <option value="course">Class</option>
                            <option value="monthlyFee">Fee Amount</option>
                            <option value="status">Status</option>
                        </select>
                        <select id="sortOrder" onchange="updateStudentTable()">
                            <option value="asc">Ascending</option>
                            <option value="desc">Descending</option>
                        </select>
                    </div>
                    <button class="btn btn-success" onclick="exportStudentsToExcel()" style="padding: 10px 20px;">üì• Export to Excel</button>
                    <button class="btn btn-whatsapp" onclick="sendBulkWhatsAppReminders()" style="padding: 10px 20px;">üì± Send Reminders</button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Roll No.</th><th>Name</th><th>Class</th><th>Syllabus</th><th>Phone</th>
                                <th>Monthly Fee</th><th>Status</th><th>Fee Status</th><th>Reminders</th>
                                <th id="actionsHeader">Actions</th><th id="whatsappHeader">WhatsApp</th>
                            </tr>
                        </thead>
                        <tbody id="studentTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Fee Collection Tab -->
            <div id="fees" class="tab-content">
                <div id="feeFormSection">
                    <h2 style="margin-bottom: 20px;">Collect Fee</h2>
                    <div class="form-grid">
                        <div class="form-group"><label>Select Student *</label><select id="feeStudent" required><option value="">Choose student...</option></select></div>
                        <div class="form-group"><label>Fee Month *</label><input type="month" id="feeMonth" required></div>
                        <div class="form-group"><label>Amount (‚Çπ) *</label><input type="number" id="feeAmount" required></div>
                        <div class="form-group">
                            <label>Payment Method *</label>
                            <select id="paymentMethod" required>
                                <option value="">Select method...</option>
                                <option value="Cash">Cash</option><option value="UPI">UPI</option>
                                <option value="Card">Card</option><option value="Bank Transfer">Bank Transfer</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="collectFee()">Collect Fee</button>
                </div>
                <h2 style="margin-top: 40px; margin-bottom: 20px;">üìä Paid Students Report</h2>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 30px;">
                    <div class="form-grid" style="margin-bottom: 20px;">
                        <div class="form-group"><label>Select Month</label><input type="month" id="paidReportMonth"></div>
                        <div class="form-group">
                            <label>Filter by Class</label>
                            <select id="paidReportClass">
                                <option value="">All Classes</option>
                                <option>Class 1</option><option>Class 2</option><option>Class 3</option><option>Class 4</option>
                                <option>Class 5</option><option>Class 6</option><option>Class 7</option><option>Class 8</option>
                                <option>Class 9</option><option>Class 10</option><option>Class 11</option><option>Class 12</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Filter by Payment Method</label>
                            <select id="paidReportMethod">
                                <option value="">All Methods</option>
                                <option value="Cash">Cash</option><option value="UPI">UPI</option>
                                <option value="Card">Card</option><option value="Bank Transfer">Bank Transfer</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="generatePaidStudentsReport()">Generate Report</button>
                        <button class="btn btn-success" onclick="exportPaidStudentsReport()" style="display: none;" id="exportPaidReportBtn">üì• Export Report to Excel</button>
                    </div>
                </div>
                <div id="paidReportSummary" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px; color: #667eea;">Report Summary</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;"><p style="color: #666; font-size: 0.9em; margin-bottom: 5px;">Total Paid Students</p><p style="font-size: 1.8em; font-weight: 700; color: #28a745;" id="paidReportCount">0</p></div>
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;"><p style="color: #666; font-size: 0.9em; margin-bottom: 5px;">Total Amount Collected</p><p style="font-size: 1.8em; font-weight: 700; color: #667eea;" id="paidReportTotal">‚Çπ0</p></div>
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;"><p style="color: #666; font-size: 0.9em; margin-bottom: 5px;">Average Fee</p><p style="font-size: 1.8em; font-weight: 700; color: #764ba2;" id="paidReportAverage">‚Çπ0</p></div>
                    </div>
                </div>
                <div id="paidStudentsTableContainer" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="color: #667eea;">Students Who Paid Fees</h3>
                        <input type="text" class="search-box" placeholder="Search..." id="paidStudentsSearch" onkeyup="filterPaidStudentsTable()" style="margin-bottom: 0; max-width: 300px;">
                    </div>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>S.No</th><th>Roll No.</th><th>Student Name</th><th>Class</th><th>Phone</th><th>Amount Paid</th><th>Payment Date</th><th>Payment Method</th><th>Receipt No.</th></tr></thead>
                            <tbody id="paidStudentsTableBody"></tbody>
                        </table>
                    </div>
                </div>
                <h2 style="margin-top: 40px; margin-bottom: 20px;">Recent Payments (Last 20)</h2>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                    <div class="sort-controls">
                        <label>Sort By:</label>
                        <select id="paymentSortField" onchange="updatePaymentTable()">
                            <option value="date">Recent First</option><option value="rollNumber">Roll Number</option>
                            <option value="studentName">Student Name</option><option value="amount">Amount</option>
                        </select>
                        <select id="paymentSortOrder" onchange="updatePaymentTable()">
                            <option value="desc">Descending</option><option value="asc">Ascending</option>
                        </select>
                    </div>
                    <button class="btn btn-success" onclick="exportRecentPaymentsToExcel()" style="padding: 10px 20px;">üì• Export to Excel</button>
                </div>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Receipt No.</th><th>Date</th><th>Roll No.</th><th>Student</th><th>Month</th><th>Amount</th><th>Method</th><th id="paymentActionsHeader">Actions</th></tr></thead>
                        <tbody id="paymentTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Teachers Tab -->
            <div id="teachers" class="tab-content">
                <div id="teacherFormSection">
                    <h2 style="margin-bottom: 20px;">üë®‚Äçüè´ Add Teacher</h2>
                    <form id="teacherForm">
                        <div class="form-grid">
                            <div class="form-group"><label>Teacher Name *</label><input type="text" id="teacherName" required></div>
                            <div class="form-group"><label>Employee ID *</label><input type="text" id="employeeId" required></div>
                            <div class="form-group"><label>Subject/Specialization</label><input type="text" id="teacherSubject" placeholder="e.g., Mathematics, Science"></div>
                            <div class="form-group"><label>Phone Number *</label><input type="tel" id="teacherPhone" required></div>
                            <div class="form-group"><label>Email (Optional)</label><input type="email" id="teacherEmail"></div>
                            <div class="form-group"><label>Monthly Salary (‚Çπ) *</label><input type="number" id="teacherSalary" required></div>
                            <div class="form-group"><label>Joining Date</label><input type="date" id="teacherJoiningDate"></div>
                            <div class="form-group">
                                <label>Status *</label>
                                <select id="teacherStatus" required>
                                    <option value="">Select Status</option><option value="Active">Active</option><option value="Inactive">Inactive</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Teacher</button>
                    </form>
                </div>
                <h2 style="margin-top: 40px; margin-bottom: 20px;">All Teachers</h2>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                    <input type="text" class="search-box" placeholder="Search by name or employee ID..." id="teacherSearch" style="margin-bottom: 0; max-width: 400px;">
                    <button class="btn btn-success" onclick="exportTeachersToExcel()" style="padding: 10px 20px;">üì• Export to Excel</button>
                </div>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Employee ID</th><th>Name</th><th>Subject</th><th>Phone</th><th>Email</th><th>Monthly Salary</th><th>Joining Date</th><th>Status</th><th id="teacherActionsHeader">Actions</th></tr></thead>
                        <tbody id="teacherTableBody"></tbody>
                    </table>
                </div>
                <div id="salaryFormSection" style="margin-top: 40px;">
                    <h2 style="margin-bottom: 20px;">üí∞ Pay Salary</h2>
                    <div class="form-grid">
                        <div class="form-group"><label>Select Teacher *</label><select id="salaryTeacher" required><option value="">Choose teacher...</option></select></div>
                        <div class="form-group"><label>Salary Month *</label><input type="month" id="salaryMonth" required></div>
                        <div class="form-group"><label>Amount (‚Çπ) *</label><input type="number" id="salaryAmount" required></div>
                        <div class="form-group">
                            <label>Payment Method *</label>
                            <select id="salaryPaymentMethod" required>
                                <option value="">Select method...</option>
                                <option value="Cash">Cash</option><option value="Bank Transfer">Bank Transfer</option>
                                <option value="UPI">UPI</option><option value="Cheque">Cheque</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="paySalary()">Pay Salary</button>
                </div>
                <h2 style="margin-top: 40px; margin-bottom: 20px;">Recent Salary Payments</h2>
                <div style="display: flex; justify-content: flex-end; margin-bottom: 15px;">
                    <button class="btn btn-success" onclick="exportSalaryPaymentsToExcel()" style="padding: 10px 20px;">üì• Export to Excel</button>
                </div>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Receipt No.</th><th>Date</th><th>Employee ID</th><th>Teacher Name</th><th>Month</th><th>Amount</th><th>Method</th><th id="salaryActionsHeader">Actions</th></tr></thead>
                        <tbody id="salaryTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Expenses Tab -->
            <div id="expenses" class="tab-content">
                <div id="expenseFormSection">
                    <h2 style="margin-bottom: 20px;">üíµ Add Expense</h2>
                    <form id="expenseForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Expense Type *</label>
                                <select id="expenseType" required>
                                    <option value="">Select Type</option>
                                    <option value="Rent">Rent</option><option value="Electricity">Electricity</option>
                                    <option value="Water">Water</option><option value="Internet">Internet</option>
                                    <option value="Maintenance">Maintenance</option><option value="Supplies">Supplies</option>
                                    <option value="Transportation">Transportation</option><option value="Marketing">Marketing</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group"><label>Description *</label><input type="text" id="expenseDescription" required placeholder="e.g., Monthly center rent"></div>
                            <div class="form-group"><label>Amount (‚Çπ) *</label><input type="number" id="expenseAmount" required></div>
                            <div class="form-group"><label>Expense Date *</label><input type="date" id="expenseDate" required></div>
                            <div class="form-group">
                                <label>Payment Method *</label>
                                <select id="expensePaymentMethod" required>
                                    <option value="">Select method...</option>
                                    <option value="Cash">Cash</option><option value="Bank Transfer">Bank Transfer</option>
                                    <option value="UPI">UPI</option><option value="Cheque">Cheque</option><option value="Card">Card</option>
                                </select>
                            </div>
                            <div class="form-group"><label>Paid To</label><input type="text" id="expensePaidTo" placeholder="e.g., Landlord name, Vendor name"></div>
                            <div class="form-group"><label>For Month (Optional)</label><input type="month" id="expenseForMonth"></div>
                            <div class="form-group"><label>Notes (Optional)</label><input type="text" id="expenseNotes" placeholder="Additional details"></div>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Expense</button>
                    </form>
                </div>
                <h2 style="margin-top: 40px; margin-bottom: 20px;">All Expenses</h2>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <div class="form-grid" style="margin-bottom: 0;">
                        <div class="form-group">
                            <label>Filter by Type</label>
                            <select id="expenseFilterType" onchange="updateExpenseTable()">
                                <option value="">All Types</option>
                                <option value="Rent">Rent</option><option value="Electricity">Electricity</option>
                                <option value="Water">Water</option><option value="Internet">Internet</option>
                                <option value="Maintenance">Maintenance</option><option value="Supplies">Supplies</option>
                                <option value="Transportation">Transportation</option><option value="Marketing">Marketing</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group"><label>Filter by Month</label><input type="month" id="expenseFilterMonth" onchange="updateExpenseTable()"></div>
                        <div class="form-group" style="display: flex; align-items: flex-end;">
                            <button class="btn btn-primary" onclick="clearExpenseFilters()" style="width: 100%;">Clear Filters</button>
                        </div>
                    </div>
                </div>
                <div id="expenseSummary" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px; color: #667eea;">Expense Summary</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;"><p style="color: #666; font-size: 0.9em; margin-bottom: 5px;">Total Expenses</p><p style="font-size: 1.8em; font-weight: 700; color: #dc3545;" id="totalExpenses">‚Çπ0</p></div>
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;"><p style="color: #666; font-size: 0.9em; margin-bottom: 5px;">This Month</p><p style="font-size: 1.8em; font-weight: 700; color: #ffc107;" id="thisMonthExpenses">‚Çπ0</p></div>
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;"><p style="color: #666; font-size: 0.9em; margin-bottom: 5px;">Count</p><p style="font-size: 1.8em; font-weight: 700; color: #667eea;" id="expenseCount">0</p></div>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                    <input type="text" class="search-box" placeholder="Search expenses..." id="expenseSearch" style="margin-bottom: 0; max-width: 400px;">
                    <button class="btn btn-success" onclick="exportExpensesToExcel()" style="padding: 10px 20px;">üì• Export to Excel</button>
                </div>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Date</th><th>Type</th><th>Description</th><th>Amount</th><th>For Month</th><th>Paid To</th><th>Method</th><th>Notes</th><th id="expenseActionsHeader">Actions</th></tr></thead>
                        <tbody id="expenseTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Accounts Tab -->
            <div id="accounts" class="tab-content">
                <h2 style="margin-bottom: 5px;">üìí Accounts Overview</h2>
                <p style="color: #666; margin-bottom: 25px;">Monthly income vs expenses breakdown</p>
                <div class="accounts-month-selector">
                    <label>üìÖ Select Month:</label>
                    <input type="month" id="accountsMonth">
                    <button class="btn btn-primary" onclick="generateAccountsSummary()">View Summary</button>
                    <button class="btn btn-success" onclick="exportAccountsToExcel()" id="exportAccountsBtn" style="display:none;">üì• Export to Excel</button>
                </div>
                <div id="netResultBanner" style="display:none;"></div>
                <div class="accounts-summary-grid" id="accountsSummaryGrid" style="display:none;">
                    <div class="accounts-card income"><div class="accounts-card-icon">üí∞</div><div class="accounts-card-label">Total Fees Collected</div><div class="accounts-card-value" id="accTotalFees">‚Çπ0</div></div>
                    <div class="accounts-card salary-card"><div class="accounts-card-icon">üë®‚Äçüè´</div><div class="accounts-card-label">Salary Paid</div><div class="accounts-card-value" id="accTotalSalary">‚Çπ0</div></div>
                    <div class="accounts-card expense-card"><div class="accounts-card-icon">üè¢</div><div class="accounts-card-label">Other Expenses</div><div class="accounts-card-value" id="accTotalExpenses">‚Çπ0</div></div>
                    <div class="accounts-card expense-card"><div class="accounts-card-icon">üìä</div><div class="accounts-card-label">Total Expenditure</div><div class="accounts-card-value" id="accTotalExpenditure">‚Çπ0</div></div>
                </div>
                <div class="accounts-breakdown" id="accountsBreakdown" style="display:none;">
                    <div class="accounts-breakdown-card">
                        <div class="accounts-breakdown-header green">üí∞ Fee Collections</div>
                        <div class="accounts-breakdown-body" id="feeBreakdownBody"></div>
                        <div class="accounts-breakdown-total"><span>Total Collected</span><span id="feeBreakdownTotal" style="color:#28a745;">‚Çπ0</span></div>
                    </div>
                    <div class="accounts-breakdown-card">
                        <div class="accounts-breakdown-header red">üè¢ Expenses</div>
                        <div class="accounts-breakdown-body" id="expenseBreakdownBody"></div>
                        <div class="accounts-breakdown-total"><span>Total Expenses</span><span id="expenseBreakdownTotal" style="color:#dc3545;">‚Çπ0</span></div>
                    </div>
                    <div class="accounts-breakdown-card">
                        <div class="accounts-breakdown-header orange">üë®‚Äçüè´ Salary Payments</div>
                        <div class="accounts-breakdown-body" id="salaryBreakdownBody"></div>
                        <div class="accounts-breakdown-total"><span>Total Salary</span><span id="salaryBreakdownTotal" style="color:#fd7e14;">‚Çπ0</span></div>
                    </div>
                    <div class="accounts-breakdown-card">
                        <div class="accounts-breakdown-header red">üìÇ Expense by Category</div>
                        <div class="accounts-breakdown-body" id="categoryBreakdownBody"></div>
                        <div class="accounts-breakdown-total"><span>Total</span><span id="categoryBreakdownTotal" style="color:#dc3545;">‚Çπ0</span></div>
                    </div>
                </div>
                <div id="monthlyHistorySection" style="display:none;">
                    <h3 style="color:#667eea; margin-bottom:15px;">üìÖ Month-wise History (All Months)</h3>
                    <div class="table-container">
                        <table class="monthly-history-table">
                            <thead><tr><th>Month</th><th>Fees Collected</th><th>Salary Paid</th><th>Other Expenses</th><th>Total Expenditure</th><th>Net Profit / Loss</th></tr></thead>
                            <tbody id="monthlyHistoryBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Inquiry Tab -->
            <div id="inquiries" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 25px; flex-wrap: wrap; gap: 15px;">
                    <div>
                        <h2 style="margin-bottom: 5px;">üîç Inquiry Management</h2>
                        <p style="color: #666;">Track potential students and convert them when they're ready to join</p>
                    </div>
                    <button class="btn btn-success" onclick="exportInquiriesToExcel()" style="padding: 10px 20px;">üì• Export to Excel</button>
                </div>
                <div class="inquiry-stats" id="inquiryStats">
                    <div class="inquiry-stat"><h3 id="inqTotal">0</h3><p>Total Inquiries</p></div>
                    <div class="inquiry-stat new-color"><h3 id="inqNew">0</h3><p>New</p></div>
                    <div class="inquiry-stat followup-color"><h3 id="inqFollowup">0</h3><p>Follow Up</p></div>
                    <div class="inquiry-stat interested-color"><h3 id="inqInterested">0</h3><p>Interested</p></div>
                    <div class="inquiry-stat notinterested-color"><h3 id="inqNotInterested">0</h3><p>Not Interested</p></div>
                    <div class="inquiry-stat converted-color"><h3 id="inqConverted">0</h3><p>Converted</p></div>
                </div>
                <div id="inquiryFormSection" style="background: #f8f9fa; padding: 25px; border-radius: 12px; margin-bottom: 30px;">
                    <h3 style="margin-bottom: 20px; color: #667eea;">‚ûï Add New Inquiry</h3>
                    <form id="inquiryForm">
                        <div class="form-grid">
                            <div class="form-group"><label>Student/Parent Name *</label><input type="text" id="inqName" required placeholder="Full name"></div>
                            <div class="form-group"><label>Phone Number *</label><input type="tel" id="inqPhone" required placeholder="Contact number"></div>
                            <div class="form-group"><label>Alternate Phone</label><input type="tel" id="inqAltPhone" placeholder="Alternate number (optional)"></div>
                            <div class="form-group">
                                <label>Interested Class *</label>
                                <select id="inqClass" required>
                                    <option value="">Select Class</option>
                                    <option>Class 1</option><option>Class 2</option><option>Class 3</option><option>Class 4</option>
                                    <option>Class 5</option><option>Class 6</option><option>Class 7</option><option>Class 8</option>
                                    <option>Class 9</option><option>Class 10</option><option>Class 11</option><option>Class 12</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Syllabus Preference</label>
                                <select id="inqSyllabus">
                                    <option value="">Not Sure</option>
                                    <option value="CBSE">CBSE</option>
                                    <option value="Matric">Matric</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Source</label>
                                <select id="inqSource">
                                    <option value="">Select Source</option>
                                    <option value="Walk-in">Walk-in</option><option value="Phone Call">Phone Call</option>
                                    <option value="WhatsApp">WhatsApp</option><option value="Referral">Referral</option>
                                    <option value="Social Media">Social Media</option><option value="Advertisement">Advertisement</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group"><label>Inquiry Date *</label><input type="date" id="inqDate" required></div>
                            <div class="form-group">
                                <label>Status *</label>
                                <select id="inqStatus" required>
                                    <option value="New">New</option><option value="Follow Up">Follow Up</option>
                                    <option value="Interested">Interested</option><option value="Not Interested">Not Interested</option>
                                </select>
                            </div>
                            <div class="form-group"><label>Follow Up Date</label><input type="date" id="inqFollowUpDate"></div>
                            <div class="form-group"><label>Expected Fee (‚Çπ)</label><input type="number" id="inqExpectedFee" placeholder="Expected monthly fee"></div>
                        </div>
                        <div class="form-group" style="margin-bottom: 20px;">
                            <label>Notes / Remarks</label>
                            <input type="text" id="inqNotes" placeholder="Any additional notes about this inquiry">
                        </div>
                        <button type="submit" class="btn btn-primary" id="inqSubmitBtn">Add Inquiry</button>
                    </form>
                </div>
                <div style="background: #f8f9fa; padding: 15px 20px; border-radius: 10px; margin-bottom: 20px;">
                    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <input type="text" class="search-box" placeholder="Search by name or phone..." id="inquirySearch" style="margin-bottom: 0; max-width: 280px; flex: 1;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-weight: 600; color: #333; white-space: nowrap;">Status:</label>
                            <select id="inquiryStatusFilter" onchange="updateInquiryTable()" style="padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95em;">
                                <option value="">All Statuses</option>
                                <option value="New">New</option><option value="Follow Up">Follow Up</option>
                                <option value="Interested">Interested</option><option value="Not Interested">Not Interested</option>
                                <option value="Converted">Converted</option>
                            </select>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-weight: 600; color: #333; white-space: nowrap;">Class:</label>
                            <select id="inquiryClassFilter" onchange="updateInquiryTable()" style="padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95em;">
                                <option value="">All Classes</option>
                                <option>Class 1</option><option>Class 2</option><option>Class 3</option><option>Class 4</option>
                                <option>Class 5</option><option>Class 6</option><option>Class 7</option><option>Class 8</option>
                                <option>Class 9</option><option>Class 10</option><option>Class 11</option><option>Class 12</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="clearInquiryFilters()" style="padding: 10px 18px;">Clear Filters</button>
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th><th>Name</th><th>Phone</th><th>Class</th><th>Syllabus</th><th>Source</th>
                                <th>Expected Fee</th><th>Status</th><th>Follow Up</th><th>Notes</th>
                                <th id="inquiryActionsHeader">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inquiryTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- ============================================================ -->
            <!-- BATCH 2026 TAB ‚Äî NEW -->
            <!-- ============================================================ -->
            <div id="batch2026" class="tab-content">

                <!-- Header Banner -->
                <div class="b26-header-banner">
                    <div>
                        <h2>üéì Batch 2026 ‚Äî Student Inquiry Form</h2>
                        <p>Dedicated admission inquiry for 10th & 12th Standard students joining in 2026</p>
                        <div class="b26-tags">
                            <span class="b26-tag b26-tag-10">üìò 10th Standard</span>
                            <span class="b26-tag b26-tag-12">üéì 12th Standard</span>
                            <span class="b26-tag b26-tag-batch">üìÖ Batch 2026</span>
                        </div>
                    </div>
                    <div style="display:flex; flex-direction:column; gap:10px; align-items:flex-end;">
                        <button class="btn btn-success" onclick="exportBatch2026ToExcel()" style="padding:10px 20px;">üì• Export to Excel</button>
                    </div>
                </div>

                <!-- Stats -->
                <div class="b26-stats-grid">
                    <div class="b26-stat stotal"><h3 id="b26Total">0</h3><p>Total Inquiries</p></div>
                    <div class="b26-stat s10"><h3 id="b26Count10">0</h3><p>10th Standard</p></div>
                    <div class="b26-stat s12"><h3 id="b26Count12">0</h3><p>12th Standard</p></div>
                    <div class="b26-stat snew"><h3 id="b26CountNew">0</h3><p>New / Pending</p></div>
                    <div class="b26-stat sconv"><h3 id="b26CountConverted">0</h3><p>Converted</p></div>
                </div>

                <!-- Add Inquiry Form -->
                <div id="b26FormSection" class="b26-form-card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px;">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <span style="font-size:1.4em;">üìã</span>
                            <div>
                                <div style="font-size:1.05em; font-weight:700; color:#3a1c71;">Add New Batch 2026 Inquiry</div>
                                <div style="font-size:0.82em; color:#999;">Fill all details carefully for 10th or 12th standard applicant</div>
                            </div>
                        </div>
                    </div>

                    <form id="b26Form">
                        <!-- Section 1: Student Info -->
                        <div style="margin-bottom:22px;">
                            <div class="b26-section-title"><div class="b26-section-num">1</div><div class="b26-section-name">Student Information</div></div>
                            <div class="b26-form-grid">
                                <div class="b26-field">
                                    <label>Student Name <span class="req">*</span></label>
                                    <input type="text" id="b26Name" placeholder="Full name" required>
                                </div>
                                <div class="b26-field">
                                    <label>Date of Birth <span class="req">*</span></label>
                                    <input type="date" id="b26DOB" required>
                                </div>
                                <div class="b26-field">
                                    <label>Gender <span class="req">*</span></label>
                                    <select id="b26Gender" required>
                                        <option value="">Select gender</option>
                                        <option value="Male">Male</option>
                                        <option value="Female">Female</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="b26-field">
                                    <label>Aadhar Number</label>
                                    <input type="text" id="b26Aadhar" placeholder="12-digit Aadhar (optional)" maxlength="14">
                                </div>
                            </div>
                        </div>

                        <!-- Section 2: Standard & Syllabus -->
                        <div style="margin-bottom:22px;">
                            <div class="b26-section-title"><div class="b26-section-num">2</div><div class="b26-section-name">Standard & Syllabus</div></div>
                            <div class="b26-form-grid">
                                <div class="b26-field" style="grid-column: span 2;">
                                    <label>Applying for Standard <span class="req">*</span></label>
                                    <div class="b26-std-toggle">
                                        <div class="b26-std-btn" id="b26Std10Btn" onclick="b26SelectStd('10')">
                                            <div class="icon">üìò</div>
                                            <div class="title">10th Standard</div>
                                            <div class="sub">SSLC / Matriculation</div>
                                        </div>
                                        <div class="b26-std-btn" id="b26Std12Btn" onclick="b26SelectStd('12')">
                                            <div class="icon">üéì</div>
                                            <div class="title">12th Standard</div>
                                            <div class="sub">Higher Secondary</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="b26-field">
                                    <label>Board / Syllabus <span class="req">*</span></label>
                                    <select id="b26Syllabus" required>
                                        <option value="">Select board</option>
                                        <option value="CBSE">CBSE</option>
                                        <option value="Matric">State Board (Matric)</option>
                                        <option value="ICSE">ICSE</option>
                                    </select>
                                </div>
                                <div class="b26-field">
                                    <label>Medium of Instruction <span class="req">*</span></label>
                                    <select id="b26Medium" required>
                                        <option value="">Select medium</option>
                                        <option value="Tamil">Tamil Medium</option>
                                        <option value="English">English Medium</option>
                                    </select>
                                </div>
                            </div>

                            <!-- 10th Subjects -->
                            <div class="b26-conditional" id="b26Sub10Sec" style="margin-top:14px;">
                                <div class="b26-field">
                                    <label>Subjects Needing Help ‚Äî 10th Standard</label>
                                    <div class="b26-subject-grid" id="b26Sub10Grid">
                                        <div class="b26-subject-card" onclick="this.classList.toggle('selected')">üìñ Tamil</div>
                                        <div class="b26-subject-card" onclick="this.classList.toggle('selected')">üî§ English</div>
                                        <div class="b26-subject-card" onclick="this.classList.toggle('selected')">üî¢ Mathematics</div>
                                        <div class="b26-subject-card" onclick="this.classList.toggle('selected')">üî¨ Science</div>
                                        <div class="b26-subject-card" onclick="this.classList.toggle('selected')">üåç Social Science</div>
                                        <div class="b26-subject-card" onclick="this.classList.toggle('selected')">üíª Computer Science</div>
                                        <div class="b26-subject-card" onclick="this.classList.toggle('selected')">üìö All Subjects</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 12th Stream & Subjects -->
                            <div class="b26-conditional" id="b26Sub12Sec" style="margin-top:14px;">
                                <div class="b26-field" style="margin-bottom:12px;">
                                    <label>Stream / Group <span class="req">*</span></label>
                                    <div class="b26-radio-group">
                                        <label class="b26-radio-opt" onclick="b26SelectRadio('b26Stream','Science (Maths)',this); b26LoadStreamSubs('science_maths')"><input type="radio" name="b26stream"><span>üî¢ Science (Maths)</span></label>
                                        <label class="b26-radio-opt" onclick="b26SelectRadio('b26Stream','Science (Bio)',this); b26LoadStreamSubs('science_bio')"><input type="radio" name="b26stream"><span>üß¨ Science (Bio)</span></label>
                                        <label class="b26-radio-opt" onclick="b26SelectRadio('b26Stream','Commerce',this); b26LoadStreamSubs('commerce')"><input type="radio" name="b26stream"><span>üíº Commerce</span></label>
                                        <label class="b26-radio-opt" onclick="b26SelectRadio('b26Stream','Arts',this); b26LoadStreamSubs('arts')"><input type="radio" name="b26stream"><span>üé® Arts / Humanities</span></label>
                                    </div>
                                </div>
                                <div class="b26-field b26-conditional" id="b26Sub12DynSec">
                                    <label>Subjects Needing Help ‚Äî 12th Standard</label>
                                    <div class="b26-subject-grid" id="b26Sub12Grid"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Section 3: Previous Academic Info -->
                        <div style="margin-bottom:22px;">
                            <div class="b26-section-title"><div class="b26-section-num">3</div><div class="b26-section-name">Previous Academic Performance</div></div>
                            <div class="b26-form-grid">
                                <div class="b26-field">
                                    <label>Previous School / Institution <span class="req">*</span></label>
                                    <input type="text" id="b26PrevSchool" placeholder="School name" required>
                                </div>
                                <div class="b26-field">
                                    <label>Last Class Completed <span class="req">*</span></label>
                                    <select id="b26PrevClass" required>
                                        <option value="">Select</option>
                                        <option value="9th">9th Standard</option>
                                        <option value="10th">10th Standard</option>
                                        <option value="11th">11th Standard</option>
                                    </select>
                                </div>
                                <div class="b26-field">
                                    <label>Previous Exam % / CGPA</label>
                                    <input type="text" id="b26PrevScore" placeholder="e.g. 75% or 8.5 CGPA">
                                </div>
                                <div class="b26-field">
                                    <label>Weakest Subject</label>
                                    <input type="text" id="b26WeakSub" placeholder="e.g. Mathematics">
                                </div>
                                <div class="b26-field">
                                    <label>Strongest Subject</label>
                                    <input type="text" id="b26StrongSub" placeholder="e.g. English">
                                </div>
                                <div class="b26-field">
                                    <label>Target Board Exam Score</label>
                                    <select id="b26TargetScore">
                                        <option value="">Select target</option>
                                        <option value="90%+">90% and above</option>
                                        <option value="80-90%">80% ‚Äì 90%</option>
                                        <option value="70-80%">70% ‚Äì 80%</option>
                                        <option value="Pass">Just Pass</option>
                                    </select>
                                </div>
                                <div class="b26-field">
                                    <label>Currently Attending Other Tuition?</label>
                                    <select id="b26OtherTuition">
                                        <option value="">Select</option>
                                        <option value="Yes">Yes</option>
                                        <option value="No">No</option>
                                    </select>
                                </div>
                                <div class="b26-field">
                                    <label>Career / Higher Education Goal</label>
                                    <select id="b26CareerGoal">
                                        <option value="">Select goal</option>
                                        <option value="Engineering / JEE">Engineering / JEE</option>
                                        <option value="Medicine / NEET">Medicine / NEET</option>
                                        <option value="Arts / Law">Arts / Law</option>
                                        <option value="Commerce / CA">Commerce / CA</option>
                                        <option value="Govt. Job / UPSC">Govt. Job / UPSC</option>
                                        <option value="Study Abroad">Study Abroad</option>
                                        <option value="Not Decided">Not Decided Yet</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Section 4: Parent Details -->
                        <div style="margin-bottom:22px;">
                            <div class="b26-section-title"><div class="b26-section-num">4</div><div class="b26-section-name">Parent / Guardian Details</div></div>
                            <div class="b26-form-grid">
                                <div class="b26-field">
                                    <label>Father's Name <span class="req">*</span></label>
                                    <input type="text" id="b26Father" placeholder="Father's full name" required>
                                </div>
                                <div class="b26-field">
                                    <label>Mother's Name</label>
                                    <input type="text" id="b26Mother" placeholder="Mother's full name">
                                </div>
                                <div class="b26-field">
                                    <label>Parent Mobile <span class="req">*</span></label>
                                    <input type="tel" id="b26ParentPhone" placeholder="10-digit mobile" maxlength="10" required>
                                </div>
                                <div class="b26-field">
                                    <label>WhatsApp Number <span class="req">*</span></label>
                                    <input type="tel" id="b26WhatsApp" placeholder="For updates & reminders" maxlength="10" required>
                                </div>
                                <div class="b26-field">
                                    <label>Alternate Contact</label>
                                    <input type="tel" id="b26AltPhone" placeholder="Optional" maxlength="10">
                                </div>
                                <div class="b26-field">
                                    <label>Email Address</label>
                                    <input type="email" id="b26Email" placeholder="Optional">
                                </div>
                                <div class="b26-field" style="grid-column: span 2;">
                                    <label>Full Address <span class="req">*</span></label>
                                    <textarea id="b26Address" placeholder="Door no., Street, Area, City, Pincode" rows="2" required></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Section 5: Batch Preferences -->
                        <div style="margin-bottom:22px;">
                            <div class="b26-section-title"><div class="b26-section-num">5</div><div class="b26-section-name">Batch Preferences</div></div>
                            <div class="b26-form-grid">
                                <div class="b26-field">
                                    <label>Preferred Batch Timing <span class="req">*</span></label>
                                    <div class="b26-check-group" id="b26TimingGroup">
                                        <label class="b26-check-opt" onclick="this.classList.toggle('selected')"><input type="checkbox" value="Morning">üåÖ Morning</label>
                                        <label class="b26-check-opt" onclick="this.classList.toggle('selected')"><input type="checkbox" value="Afternoon">‚òÄÔ∏è Afternoon</label>
                                        <label class="b26-check-opt" onclick="this.classList.toggle('selected')"><input type="checkbox" value="Evening">üåÜ Evening</label>
                                        <label class="b26-check-opt" onclick="this.classList.toggle('selected')"><input type="checkbox" value="Weekend">üìÖ Weekend Only</label>
                                    </div>
                                </div>
                                <div class="b26-field">
                                    <label>Mode of Learning <span class="req">*</span></label>
                                    <select id="b26Mode" required>
                                        <option value="">Select mode</option>
                                        <option value="Offline">üè´ Offline (Centre)</option>
                                        <option value="Online">üíª Online</option>
                                        <option value="Hybrid">üîÑ Hybrid (Both)</option>
                                    </select>
                                </div>
                                <div class="b26-field">
                                    <label>Expected Monthly Fee Range</label>
                                    <select id="b26FeeRange">
                                        <option value="">Select range</option>
                                        <option value="Below ‚Çπ1,000">Below ‚Çπ1,000</option>
                                        <option value="‚Çπ1,000‚Äì‚Çπ2,000">‚Çπ1,000 ‚Äì ‚Çπ2,000</option>
                                        <option value="‚Çπ2,000‚Äì‚Çπ3,000">‚Çπ2,000 ‚Äì ‚Çπ3,000</option>
                                        <option value="‚Çπ3,000‚Äì‚Çπ5,000">‚Çπ3,000 ‚Äì ‚Çπ5,000</option>
                                        <option value="Above ‚Çπ5,000">Above ‚Çπ5,000</option>
                                    </select>
                                </div>
                                <div class="b26-field">
                                    <label>Expected Joining Date</label>
                                    <input type="date" id="b26JoiningDate">
                                </div>
                            </div>
                        </div>

                        <!-- Section 6: Source & Notes -->
                        <div style="margin-bottom:22px;">
                            <div class="b26-section-title"><div class="b26-section-num">6</div><div class="b26-section-name">Source & Additional Info</div></div>
                            <div class="b26-form-grid">
                                <div class="b26-field">
                                    <label>How Did You Hear About Us? <span class="req">*</span></label>
                                    <select id="b26Source" required>
                                        <option value="">Select source</option>
                                        <option value="Walk-in">üö∂ Walk-in</option>
                                        <option value="Referral">üë• Referral</option>
                                        <option value="Social Media">üì± Social Media</option>
                                        <option value="Banner / Pamphlet">ü™ß Banner / Pamphlet</option>
                                        <option value="Phone Call">üìû Phone Call</option>
                                        <option value="Online Search">üåê Online Search</option>
                                        <option value="WhatsApp">üí¨ WhatsApp</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="b26-field">
                                    <label>Referred By</label>
                                    <input type="text" id="b26ReferredBy" placeholder="Name of referrer (if any)">
                                </div>
                                <div class="b26-field">
                                    <label>Inquiry Date <span class="req">*</span></label>
                                    <input type="date" id="b26InqDate" required>
                                </div>
                                <div class="b26-field">
                                    <label>Follow Up Date</label>
                                    <input type="date" id="b26FollowUpDate">
                                </div>
                                <div class="b26-field">
                                    <label>Inquiry Status</label>
                                    <select id="b26Status">
                                        <option value="New">üÜï New</option>
                                        <option value="Contacted">üìû Contacted</option>
                                        <option value="Interested">‚úÖ Interested</option>
                                        <option value="Not Interested">‚ùå Not Interested</option>
                                        <option value="Converted">üéì Converted to Student</option>
                                    </select>
                                </div>
                                <div class="b26-field">
                                    <label>Special Requirements / Notes</label>
                                    <input type="text" id="b26Notes" placeholder="Any additional notes">
                                </div>
                            </div>
                        </div>

                        <div style="display:flex; gap:12px; flex-wrap:wrap;">
                            <button type="submit" class="btn btn-primary" id="b26SubmitBtn">‚ú® Submit Batch 2026 Inquiry</button>
                        </div>
                    </form>
                </div>

                <!-- Filters & Table -->
                <div class="b26-filters">
                    <input type="text" id="b26Search" placeholder="üîç Search name or phone..." style="flex:1; min-width:180px;" oninput="updateBatch2026Table()">
                    <select id="b26FilterStd" onchange="updateBatch2026Table()" style="padding:9px 12px; border:2px solid #e0e0e0; border-radius:8px; font-size:0.92em;">
                        <option value="">All Standards</option>
                        <option value="10">10th Standard</option>
                        <option value="12">12th Standard</option>
                    </select>
                    <select id="b26FilterStatus" onchange="updateBatch2026Table()" style="padding:9px 12px; border:2px solid #e0e0e0; border-radius:8px; font-size:0.92em;">
                        <option value="">All Statuses</option>
                        <option value="New">New</option>
                        <option value="Contacted">Contacted</option>
                        <option value="Interested">Interested</option>
                        <option value="Not Interested">Not Interested</option>
                        <option value="Converted">Converted</option>
                    </select>
                    <button class="btn btn-primary" onclick="clearB26Filters()" style="padding:9px 18px;">Clear</button>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Student Name</th>
                                <th>Standard</th>
                                <th>Syllabus / Stream</th>
                                <th>Parent Phone</th>
                                <th>WhatsApp</th>
                                <th>Source</th>
                                <th>Mode</th>
                                <th>Target %</th>
                                <th>Status</th>
                                <th>Follow Up</th>
                                <th id="b26ActionsHeader">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="b26TableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reports" class="tab-content">
                <h2 style="margin-bottom: 20px;">Fee Status Report</h2>
                <div class="form-grid" style="margin-bottom: 20px;">
                    <div class="form-group"><label>Select Month</label><input type="month" id="reportMonth"></div>
                    <div class="form-group">
                        <label>Filter by Class</label>
                        <select id="reportCourse">
                            <option value="">All Classes</option>
                            <option>Class 1</option><option>Class 2</option><option>Class 3</option><option>Class 4</option>
                            <option>Class 5</option><option>Class 6</option><option>Class 7</option><option>Class 8</option>
                            <option>Class 9</option><option>Class 10</option><option>Class 11</option><option>Class 12</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Filter by Syllabus</label>
                        <select id="reportSyllabus">
                            <option value="">All Syllabus</option><option value="CBSE">CBSE</option><option value="Matric">Matric</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Filter by Fee Status</label>
                        <select id="reportFeeStatus">
                            <option value="">All Students</option><option value="paid">Paid Only</option><option value="pending">Pending Only</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="generateReport()">Generate Report</button>
                <div id="reportSummary" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 20px;">
                    <h3 style="margin-bottom: 15px; color: #667eea;">Report Summary</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;"><p style="color: #666; font-size: 0.9em; margin-bottom: 5px;">Total Students</p><p style="font-size: 1.8em; font-weight: 700; color: #667eea;" id="reportTotalStudents">0</p></div>
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;"><p style="color: #666; font-size: 0.9em; margin-bottom: 5px;">Paid</p><p style="font-size: 1.8em; font-weight: 700; color: #28a745;" id="reportPaidCount">0</p></div>
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;"><p style="color: #666; font-size: 0.9em; margin-bottom: 5px;">Pending</p><p style="font-size: 1.8em; font-weight: 700; color: #ffc107;" id="reportPendingCount">0</p></div>
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;"><p style="color: #666; font-size: 0.9em; margin-bottom: 5px;">Total Amount</p><p style="font-size: 1.8em; font-weight: 700; color: #667eea;" id="reportTotalAmount">‚Çπ0</p></div>
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;"><p style="color: #666; font-size: 0.9em; margin-bottom: 5px;">Collected</p><p style="font-size: 1.8em; font-weight: 700; color: #28a745;" id="reportCollectedAmount">‚Çπ0</p></div>
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;"><p style="color: #666; font-size: 0.9em; margin-bottom: 5px;">Pending Amount</p><p style="font-size: 1.8em; font-weight: 700; color: #dc3545;" id="reportPendingAmount">‚Çπ0</p></div>
                    </div>
                </div>
                <div class="table-container" style="margin-top: 20px;">
                    <table>
                        <thead><tr><th>Roll No.</th><th>Student Name</th><th>Class</th><th>Syllabus</th><th>Monthly Fee</th><th>Status</th><th>Last Payment</th></tr></thead>
                        <tbody id="reportTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Receipt Modal -->
<div id="receiptModal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><h2>Fee Receipt</h2><button class="close-btn" onclick="closeReceipt()">&times;</button></div>
        <div id="receiptContent"></div>
        <button class="btn btn-primary" onclick="window.print()" style="margin-top: 20px; width: 100%;">Print Receipt</button>
    </div>
</div>

<!-- Convert Inquiry to Student Modal -->
<div id="convertModal" class="modal">
    <div class="modal-content convert-modal-content">
        <div class="modal-header">
            <h2>üéì Convert Inquiry to Student</h2>
            <button class="close-btn" onclick="closeConvertModal()">&times;</button>
        </div>
        <div class="convert-notice">‚úÖ Great news! This inquiry is being converted to a student. Please fill in the remaining details below.</div>
        <div id="convertInquiryInfo" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9em;"></div>
        <form id="convertForm">
            <div class="form-grid">
                <div class="form-group"><label>Student Name *</label><input type="text" id="convName" required></div>
                <div class="form-group"><label>Roll Number *</label><input type="text" id="convRollNumber" required placeholder="Assign a roll number"></div>
                <div class="form-group">
                    <label>Class *</label>
                    <select id="convClass" required>
                        <option value="">Select Class</option>
                        <option>Class 1</option><option>Class 2</option><option>Class 3</option><option>Class 4</option>
                        <option>Class 5</option><option>Class 6</option><option>Class 7</option><option>Class 8</option>
                        <option>Class 9</option><option>Class 10</option><option>Class 11</option><option>Class 12</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Syllabus</label>
                    <select id="convSyllabus">
                        <option value="">Select Syllabus</option>
                        <option value="CBSE">CBSE</option>
                        <option value="Matric">Matric</option>
                    </select>
                </div>
                <div class="form-group"><label>Phone Number *</label><input type="tel" id="convPhone" required></div>
                <div class="form-group"><label>Monthly Fee (‚Çπ) *</label><input type="number" id="convFee" required></div>
                <div class="form-group"><label>Admission Date</label><input type="date" id="convAdmissionDate"></div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="convStatus">
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                    </select>
                </div>
            </div>
            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <button type="submit" class="btn btn-success">‚úÖ Convert to Student</button>
                <button type="button" class="btn btn-danger" onclick="closeConvertModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Batch 2026 View Detail Modal -->
<div id="b26DetailModal" class="modal">
    <div class="modal-content b26-detail-modal">
        <div class="modal-header">
            <h2 style="color:#3a1c71;">üéì Batch 2026 Inquiry Details</h2>
            <button class="close-btn" onclick="document.getElementById('b26DetailModal').classList.remove('active')">&times;</button>
        </div>
        <div id="b26DetailContent"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy, onSnapshot, getDoc, setDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import * as XLSX from 'https://cdn.sheetjs.com/xlsx-0.20.1/package/xlsx.mjs';

    const firebaseConfig = {
        apiKey: "AIzaSyBDwn-JoS8oItPiQjETsJ9pqlDgRTrsASQ",
        authDomain: "fee-collection-57e8b.firebaseapp.com",
        projectId: "fee-collection-57e8b",
        storageBucket: "fee-collection-57e8b.firebasestorage.app",
        messagingSenderId: "1009610270668",
        appId: "1:1009610270668:web:c7890359d8c35e325f9f69"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    window.students = [];
    window.payments = [];
    window.reminders = [];
    window.teachers = [];
    window.salaries = [];
    window.expenses = [];
    window.inquiries = [];
    window.batch2026Inquiries = [];

    let studentsListener = null, paymentsListener = null, remindersListener = null;
    let teachersListener = null, salariesListener = null, expensesListener = null;
    let inquiriesListener = null, batch2026Listener = null;
    let currentUser = null, userRole = null;
    let editingStudentId = null, editingExpenseId = null, editingInquiryId = null;
    let editingB26Id = null, convertingInquiryId = null;
    let filteredPaidStudents = [], currentAccountsData = null;
    let b26FormState = { standard: '', stream: '' };

    // ---- Auth ----
    window.showPage = function(pageId) {
        ['loginPage','signupPage','resetPage','mainApp'].forEach(id => document.getElementById(id).style.display = 'none');
        document.getElementById(pageId).style.display = 'block';
        document.querySelectorAll('.error-message, .success-message').forEach(el => el.classList.remove('show'));
    };

    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('loginBtn');
        const errorDiv = document.getElementById('loginError');
        btn.disabled = true; btn.textContent = 'Logging in...';
        errorDiv.classList.remove('show');
        try { await signInWithEmailAndPassword(auth, document.getElementById('loginEmail').value, document.getElementById('loginPassword').value); }
        catch (error) { errorDiv.textContent = '‚ùå ' + getErrorMessage(error.code); errorDiv.classList.add('show'); btn.disabled = false; btn.textContent = 'Login'; }
    });

    document.getElementById('signupForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('signupBtn');
        const errorDiv = document.getElementById('signupError'), successDiv = document.getElementById('signupSuccess');
        btn.disabled = true; btn.textContent = 'Creating Account...';
        errorDiv.classList.remove('show'); successDiv.classList.remove('show');
        try {
            const uc = await createUserWithEmailAndPassword(auth, document.getElementById('signupEmail').value, document.getElementById('signupPassword').value);
            await setDoc(doc(db, 'users', uc.user.uid), { email: document.getElementById('signupEmail').value, name: document.getElementById('signupName').value, role: document.getElementById('signupRole').value, createdAt: new Date().toISOString() });
            successDiv.textContent = '‚úÖ Account created! Redirecting...'; successDiv.classList.add('show');
            setTimeout(() => { showPage('loginPage'); document.getElementById('loginEmail').value = document.getElementById('signupEmail').value; }, 2000);
        } catch (error) { errorDiv.textContent = '‚ùå ' + getErrorMessage(error.code); errorDiv.classList.add('show'); btn.disabled = false; btn.textContent = 'Create Account'; }
    });

    document.getElementById('resetForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('resetBtn');
        const errorDiv = document.getElementById('resetError'), successDiv = document.getElementById('resetSuccess');
        btn.disabled = true; btn.textContent = 'Sending...';
        errorDiv.classList.remove('show'); successDiv.classList.remove('show');
        try { await sendPasswordResetEmail(auth, document.getElementById('resetEmail').value); successDiv.textContent = '‚úÖ Password reset email sent!'; successDiv.classList.add('show'); document.getElementById('resetEmail').value = ''; }
        catch (error) { errorDiv.textContent = '‚ùå ' + getErrorMessage(error.code); errorDiv.classList.add('show'); }
        finally { btn.disabled = false; btn.textContent = 'Send Reset Link'; }
    });

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            const userDoc = await getDoc(doc(db, 'users', user.uid));
            if (userDoc.exists()) {
                const ud = userDoc.data(); userRole = ud.role;
                document.getElementById('userName').textContent = ud.name;
                document.getElementById('userEmail').textContent = user.email;
                document.getElementById('userRole').textContent = userRole.toUpperCase();
                applyRoleBasedUI(userRole);
                showPage('mainApp'); loadData();
            } else { alert('User profile not found.'); signOut(auth); }
        } else { showPage('loginPage'); }
    });

    window.logout = async function() {
        if (confirm('Are you sure you want to logout?')) {
            try {
                [studentsListener,paymentsListener,remindersListener,teachersListener,salariesListener,expensesListener,inquiriesListener,batch2026Listener].forEach(l => l && l());
                await signOut(auth);
            } catch (error) { alert('Error logging out: ' + error.message); }
        }
    };

    function applyRoleBasedUI(role) {
        const isStaff = role === 'staff';
        ['staffNotice'].forEach(id => document.getElementById(id).style.display = isStaff ? 'block' : 'none');
        ['studentFormSection','feeFormSection','teacherFormSection','salaryFormSection','expenseFormSection','inquiryFormSection','b26FormSection'].forEach(id => {
            document.getElementById(id).style.display = isStaff ? 'none' : 'block';
        });
        ['actionsHeader','paymentActionsHeader','teacherActionsHeader','salaryActionsHeader','expenseActionsHeader','inquiryActionsHeader','b26ActionsHeader'].forEach(id => {
            document.getElementById(id).style.display = isStaff ? 'none' : 'table-cell';
        });
    }

    async function loadData() {
        try {
            studentsListener = onSnapshot(query(collection(db, 'students'), orderBy('rollNumber')), (snap) => { window.students = snap.docs.map(d => ({id:d.id,...d.data()})); updateStudentTable(); updateFeeStudentSelect(); updateStats(); });
            paymentsListener = onSnapshot(query(collection(db, 'payments'), orderBy('date','desc')), (snap) => { window.payments = snap.docs.map(d => ({id:d.id,...d.data()})); updatePaymentTable(); updateStats(); });
            remindersListener = onSnapshot(query(collection(db, 'reminders'), orderBy('sentAt','desc')), (snap) => { window.reminders = snap.docs.map(d => ({id:d.id,...d.data()})); updateStudentTable(); });
            teachersListener = onSnapshot(query(collection(db, 'teachers'), orderBy('employeeId')), (snap) => { window.teachers = snap.docs.map(d => ({id:d.id,...d.data()})); updateTeacherTable(); updateSalaryTeacherSelect(); });
            salariesListener = onSnapshot(query(collection(db, 'salaries'), orderBy('date','desc')), (snap) => { window.salaries = snap.docs.map(d => ({id:d.id,...d.data()})); updateSalaryTable(); });
            expensesListener = onSnapshot(query(collection(db, 'expenses'), orderBy('date','desc')), (snap) => { window.expenses = snap.docs.map(d => ({id:d.id,...d.data()})); updateExpenseTable(); updateExpenseSummary(); });
            inquiriesListener = onSnapshot(query(collection(db, 'inquiries'), orderBy('createdAt','desc')), (snap) => { window.inquiries = snap.docs.map(d => ({id:d.id,...d.data()})); updateInquiryTable(); updateInquiryStats(); });
            batch2026Listener = onSnapshot(query(collection(db, 'batch2026'), orderBy('createdAt','desc')), (snap) => { window.batch2026Inquiries = snap.docs.map(d => ({id:d.id,...d.data()})); updateBatch2026Table(); updateB26Stats(); });
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        } catch (error) { console.error(error); alert('Error loading data: ' + error.message); }
    }

    // Default dates
    document.getElementById('feeMonth').value = new Date().toISOString().slice(0,7);
    document.getElementById('reportMonth').value = new Date().toISOString().slice(0,7);
    document.getElementById('paidReportMonth').value = new Date().toISOString().slice(0,7);
    document.getElementById('salaryMonth').value = new Date().toISOString().slice(0,7);
    document.getElementById('expenseDate').value = new Date().toISOString().slice(0,10);
    document.getElementById('accountsMonth').value = new Date().toISOString().slice(0,7);
    document.getElementById('inqDate').value = new Date().toISOString().slice(0,10);
    document.getElementById('b26InqDate').value = new Date().toISOString().slice(0,10);

    // ============================================================
    // BATCH 2026 FUNCTIONS
    // ============================================================
    const b26StreamSubs = {
        science_maths: ['üî§ English','üìñ Tamil','üî¢ Mathematics','‚ö° Physics','‚öóÔ∏è Chemistry','üíª Computer Science'],
        science_bio:   ['üî§ English','üìñ Tamil','üß¨ Biology','‚ö° Physics','‚öóÔ∏è Chemistry','üî¢ Mathematics'],
        commerce:      ['üî§ English','üìñ Tamil','üìä Accountancy','üíº Business Studies','üìà Economics','üî¢ Mathematics'],
        arts:          ['üî§ English','üìñ Tamil','üèõÔ∏è History','üåç Geography','üí∞ Economics','üìä Political Science']
    };

    window.b26SelectStd = function(std) {
        b26FormState.standard = std;
        document.getElementById('b26Std10Btn').classList.toggle('selected', std === '10');
        document.getElementById('b26Std12Btn').classList.toggle('selected', std === '12');
        document.getElementById('b26Sub10Sec').classList.toggle('show', std === '10');
        document.getElementById('b26Sub12Sec').classList.toggle('show', std === '12');
        if (std === '10') { b26FormState.stream = ''; document.getElementById('b26Sub12DynSec').classList.remove('show'); }
    };

    window.b26SelectRadio = function(field, value, el) {
        b26FormState[field] = value;
        el.closest('.b26-radio-group').querySelectorAll('.b26-radio-opt').forEach(o => o.classList.remove('selected'));
        el.classList.add('selected');
    };

    window.b26LoadStreamSubs = function(stream) {
        b26FormState.stream = stream;
        const grid = document.getElementById('b26Sub12Grid');
        const subs = [...(b26StreamSubs[stream] || []), 'üìö All Subjects'];
        grid.innerHTML = subs.map(s => `<div class="b26-subject-card" onclick="this.classList.toggle('selected')">${s}</div>`).join('');
        document.getElementById('b26Sub12DynSec').classList.add('show');
    };

    document.getElementById('b26Form').addEventListener('submit', async function(e) {
        e.preventDefault();
        if (userRole === 'staff') { alert('No permission.'); return; }
        if (!b26FormState.standard) { alert('Please select a standard (10th or 12th).'); return; }

        const btn = document.getElementById('b26SubmitBtn');
        const isEditing = editingB26Id !== null;
        btn.disabled = true; btn.textContent = isEditing ? 'Updating...' : 'Submitting...';

        const getSelectedSubjects = () => {
            const gridId = b26FormState.standard === '10' ? 'b26Sub10Grid' : 'b26Sub12Grid';
            return [...document.querySelectorAll(`#${gridId} .b26-subject-card.selected`)].map(c => c.textContent.trim());
        };
        const getSelectedTimings = () => [...document.querySelectorAll('#b26TimingGroup .b26-check-opt.selected')].map(c => c.querySelector('input').value);

        const data = {
            studentName: document.getElementById('b26Name').value.trim(),
            dob: document.getElementById('b26DOB').value,
            gender: document.getElementById('b26Gender').value,
            aadhar: document.getElementById('b26Aadhar').value.trim(),
            standard: b26FormState.standard,
            syllabus: document.getElementById('b26Syllabus').value,
            medium: document.getElementById('b26Medium').value,
            stream: b26FormState.stream || '-',
            subjects: getSelectedSubjects().join(', ') || '-',
            prevSchool: document.getElementById('b26PrevSchool').value.trim(),
            prevClass: document.getElementById('b26PrevClass').value,
            prevScore: document.getElementById('b26PrevScore').value.trim(),
            weakSubject: document.getElementById('b26WeakSub').value.trim() || '-',
            strongSubject: document.getElementById('b26StrongSub').value.trim() || '-',
            targetScore: document.getElementById('b26TargetScore').value || '-',
            careerGoal: document.getElementById('b26CareerGoal').value || '-',
            otherTuition: document.getElementById('b26OtherTuition').value || '-',
            fatherName: document.getElementById('b26Father').value.trim(),
            motherName: document.getElementById('b26Mother').value.trim() || '-',
            parentPhone: document.getElementById('b26ParentPhone').value.trim(),
            whatsapp: document.getElementById('b26WhatsApp').value.trim(),
            altPhone: document.getElementById('b26AltPhone').value.trim() || '-',
            email: document.getElementById('b26Email').value.trim() || '-',
            address: document.getElementById('b26Address').value.trim(),
            batchTiming: getSelectedTimings().join(', ') || '-',
            mode: document.getElementById('b26Mode').value,
            feeRange: document.getElementById('b26FeeRange').value || '-',
            joiningDate: document.getElementById('b26JoiningDate').value || '-',
            source: document.getElementById('b26Source').value,
            referredBy: document.getElementById('b26ReferredBy').value.trim() || '-',
            inquiryDate: document.getElementById('b26InqDate').value,
            followUpDate: document.getElementById('b26FollowUpDate').value || '-',
            status: document.getElementById('b26Status').value,
            notes: document.getElementById('b26Notes').value.trim() || '-',
            batch: '2026'
        };

        try {
            if (isEditing) {
                await updateDoc(doc(db, 'batch2026', editingB26Id), {...data, updatedAt: new Date().toISOString()});
                alert('‚úÖ Inquiry updated successfully!');
                cancelB26Edit();
            } else {
                await addDoc(collection(db, 'batch2026'), {...data, createdAt: new Date().toISOString()});
                alert('‚úÖ Batch 2026 inquiry submitted successfully!');
            }
            this.reset();
            document.getElementById('b26InqDate').value = new Date().toISOString().slice(0,10);
            b26FormState = { standard: '', stream: '' };
            document.querySelectorAll('#b26Std10Btn, #b26Std12Btn').forEach(b => b.classList.remove('selected'));
            document.querySelectorAll('#b26Sub10Sec, #b26Sub12Sec, #b26Sub12DynSec').forEach(s => s.classList.remove('show'));
            document.querySelectorAll('#b26Sub10Grid .b26-subject-card.selected, #b26Sub12Grid .b26-subject-card.selected, #b26TimingGroup .b26-check-opt.selected').forEach(c => c.classList.remove('selected'));
        } catch (error) { alert('Error saving inquiry: ' + error.message); }
        finally { btn.disabled = false; btn.textContent = isEditing ? 'Update Inquiry' : '‚ú® Submit Batch 2026 Inquiry'; }
    });

    window.updateBatch2026Table = function() {
        const tbody = document.getElementById('b26TableBody');
        const search = document.getElementById('b26Search')?.value.toLowerCase() || '';
        const stdFilter = document.getElementById('b26FilterStd')?.value || '';
        const statusFilter = document.getElementById('b26FilterStatus')?.value || '';

        let filtered = window.batch2026Inquiries.filter(r => {
            const matchSearch = r.studentName?.toLowerCase().includes(search) || r.parentPhone?.includes(search);
            const matchStd = !stdFilter || r.standard === stdFilter;
            const matchStatus = !statusFilter || r.status === statusFilter;
            return matchSearch && matchStd && matchStatus;
        });

        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="12" style="text-align:center;padding:30px;color:#999;">No Batch 2026 inquiries yet. Add the first one above!</td></tr>';
            return;
        }

        const statusBadge = s => ({
            'New': 'b26-badge-new', 'Contacted': 'b26-badge-contacted',
            'Interested': 'badge-interested', 'Not Interested': 'b26-badge-notinterested',
            'Converted': 'b26-badge-converted'
        }[s] || 'badge-pending');

        tbody.innerHTML = filtered.map(r => {
            const actionsCell = userRole === 'staff' ? '' : `
                <td><div class="action-buttons">
                    <button class="btn btn-info" onclick="viewB26Detail('${r.id}')" style="padding:4px 10px;font-size:0.82em;">View</button>
                    <button class="btn btn-whatsapp" onclick="sendB26WhatsApp('${r.whatsapp}','${r.studentName.replace(/'/g,"\\'")}','${r.standard}')" style="padding:4px 10px;font-size:0.82em;">üì±</button>
                    <button class="btn btn-warning" onclick="editB26('${r.id}')" style="padding:4px 10px;font-size:0.82em;">Edit</button>
                    <button class="btn btn-danger" onclick="deleteB26('${r.id}')" style="padding:4px 10px;font-size:0.82em;">Del</button>
                </div></td>`;
            return `<tr style="${r.status==='Converted'?'background:#f0fff4;':''}">
                <td style="font-size:0.88em;">${r.inquiryDate}</td>
                <td><strong>${r.studentName}</strong><br><small style="color:#999;">${r.fatherName}</small></td>
                <td><span class="b26-table-badge ${r.standard==='10'?'b26-badge-10':'b26-badge-12'}">${r.standard}th Std</span></td>
                <td style="font-size:0.85em;">${r.syllabus}<br><small style="color:#999;">${r.stream!=='-'?r.stream:''}</small></td>
                <td>${r.parentPhone}</td>
                <td>${r.whatsapp}</td>
                <td style="font-size:0.85em;">${r.source}</td>
                <td style="font-size:0.85em;">${r.mode}</td>
                <td style="font-size:0.85em;">${r.targetScore}</td>
                <td><span class="badge ${statusBadge(r.status)}">${r.status}</span></td>
                <td style="font-size:0.82em;color:${r.followUpDate!=='-'?'#856404':'#999'};">${r.followUpDate!=='-'?'üìÖ '+r.followUpDate:'-'}</td>
                ${actionsCell}
            </tr>`;
        }).join('');
    };

    window.updateB26Stats = function() {
        const all = window.batch2026Inquiries;
        document.getElementById('b26Total').textContent = all.length;
        document.getElementById('b26Count10').textContent = all.filter(r => r.standard === '10').length;
        document.getElementById('b26Count12').textContent = all.filter(r => r.standard === '12').length;
        document.getElementById('b26CountNew').textContent = all.filter(r => ['New','Contacted'].includes(r.status)).length;
        document.getElementById('b26CountConverted').textContent = all.filter(r => r.status === 'Converted').length;
    };

    window.viewB26Detail = function(id) {
        const r = window.batch2026Inquiries.find(x => x.id === id);
        if (!r) return;
        document.getElementById('b26DetailContent').innerHTML = `
            <div style="margin-bottom:14px;padding:14px;background:linear-gradient(135deg,#f5f0ff,#fff0f5);border-radius:10px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
                <div>
                    <div style="font-size:1.1em;font-weight:700;color:#3a1c71;">${r.studentName}</div>
                    <div style="font-size:0.85em;color:#666;">${r.standard}th Standard ¬∑ ${r.syllabus} ¬∑ ${r.batch} Batch</div>
                </div>
                <span class="badge ${r.status==='Converted'?'badge-paid':r.status==='New'?'badge-new':'badge-pending'}">${r.status}</span>
            </div>
            <div class="b26-detail-grid">
                <div class="b26-detail-row"><label>Date of Birth</label><span>${r.dob}</span></div>
                <div class="b26-detail-row"><label>Gender</label><span>${r.gender}</span></div>
                <div class="b26-detail-row"><label>Aadhar</label><span>${r.aadhar||'-'}</span></div>
                <div class="b26-detail-row"><label>Medium</label><span>${r.medium}</span></div>
                <div class="b26-detail-row"><label>Stream</label><span>${r.stream}</span></div>
                <div class="b26-detail-row"><label>Subjects</label><span style="font-size:0.88em;">${r.subjects}</span></div>
                <div class="b26-detail-row"><label>Previous School</label><span>${r.prevSchool}</span></div>
                <div class="b26-detail-row"><label>Last Class</label><span>${r.prevClass}</span></div>
                <div class="b26-detail-row"><label>Previous Score</label><span>${r.prevScore||'-'}</span></div>
                <div class="b26-detail-row"><label>Weak Subject</label><span>${r.weakSubject}</span></div>
                <div class="b26-detail-row"><label>Strong Subject</label><span>${r.strongSubject}</span></div>
                <div class="b26-detail-row"><label>Target Score</label><span>${r.targetScore}</span></div>
                <div class="b26-detail-row"><label>Career Goal</label><span>${r.careerGoal}</span></div>
                <div class="b26-detail-row"><label>Other Tuition</label><span>${r.otherTuition}</span></div>
                <div class="b26-detail-row"><label>Father's Name</label><span>${r.fatherName}</span></div>
                <div class="b26-detail-row"><label>Mother's Name</label><span>${r.motherName}</span></div>
                <div class="b26-detail-row"><label>Parent Phone</label><span>${r.parentPhone}</span></div>
                <div class="b26-detail-row"><label>WhatsApp</label><span>${r.whatsapp}</span></div>
                <div class="b26-detail-row"><label>Alt Phone</label><span>${r.altPhone}</span></div>
                <div class="b26-detail-row"><label>Email</label><span>${r.email}</span></div>
                <div class="b26-detail-row" style="grid-column:span 2;"><label>Address</label><span>${r.address}</span></div>
                <div class="b26-detail-row"><label>Batch Timing</label><span>${r.batchTiming}</span></div>
                <div class="b26-detail-row"><label>Mode</label><span>${r.mode}</span></div>
                <div class="b26-detail-row"><label>Fee Range</label><span>${r.feeRange}</span></div>
                <div class="b26-detail-row"><label>Joining Date</label><span>${r.joiningDate}</span></div>
                <div class="b26-detail-row"><label>Source</label><span>${r.source}</span></div>
                <div class="b26-detail-row"><label>Referred By</label><span>${r.referredBy}</span></div>
                <div class="b26-detail-row"><label>Follow Up Date</label><span>${r.followUpDate}</span></div>
                <div class="b26-detail-row"><label>Notes</label><span>${r.notes}</span></div>
            </div>
            <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap;">
                <button class="btn btn-whatsapp" onclick="sendB26WhatsApp('${r.whatsapp}','${r.studentName.replace(/'/g,"\\'")}','${r.standard}')">üì± Send WhatsApp</button>
            </div>`;
        document.getElementById('b26DetailModal').classList.add('active');
    };

    window.editB26 = function(id) {
        if (userRole === 'staff') { alert('No permission.'); return; }
        const r = window.batch2026Inquiries.find(x => x.id === id);
        if (!r) return;
        editingB26Id = id;
        document.getElementById('b26Name').value = r.studentName;
        document.getElementById('b26DOB').value = r.dob;
        document.getElementById('b26Gender').value = r.gender;
        document.getElementById('b26Aadhar').value = r.aadhar || '';
        b26SelectStd(r.standard);
        document.getElementById('b26Syllabus').value = r.syllabus;
        document.getElementById('b26Medium').value = r.medium;
        document.getElementById('b26PrevSchool').value = r.prevSchool;
        document.getElementById('b26PrevClass').value = r.prevClass;
        document.getElementById('b26PrevScore').value = r.prevScore || '';
        document.getElementById('b26WeakSub').value = r.weakSubject === '-' ? '' : r.weakSubject;
        document.getElementById('b26StrongSub').value = r.strongSubject === '-' ? '' : r.strongSubject;
        document.getElementById('b26TargetScore').value = r.targetScore === '-' ? '' : r.targetScore;
        document.getElementById('b26CareerGoal').value = r.careerGoal === '-' ? '' : r.careerGoal;
        document.getElementById('b26OtherTuition').value = r.otherTuition === '-' ? '' : r.otherTuition;
        document.getElementById('b26Father').value = r.fatherName;
        document.getElementById('b26Mother').value = r.motherName === '-' ? '' : r.motherName;
        document.getElementById('b26ParentPhone').value = r.parentPhone;
        document.getElementById('b26WhatsApp').value = r.whatsapp;
        document.getElementById('b26AltPhone').value = r.altPhone === '-' ? '' : r.altPhone;
        document.getElementById('b26Email').value = r.email === '-' ? '' : r.email;
        document.getElementById('b26Address').value = r.address;
        document.getElementById('b26Mode').value = r.mode;
        document.getElementById('b26FeeRange').value = r.feeRange === '-' ? '' : r.feeRange;
        document.getElementById('b26JoiningDate').value = r.joiningDate === '-' ? '' : r.joiningDate;
        document.getElementById('b26Source').value = r.source;
        document.getElementById('b26ReferredBy').value = r.referredBy === '-' ? '' : r.referredBy;
        document.getElementById('b26InqDate').value = r.inquiryDate;
        document.getElementById('b26FollowUpDate').value = r.followUpDate === '-' ? '' : r.followUpDate;
        document.getElementById('b26Status').value = r.status;
        document.getElementById('b26Notes').value = r.notes === '-' ? '' : r.notes;
        const btn = document.getElementById('b26SubmitBtn');
        btn.textContent = 'Update Inquiry'; btn.classList.add('btn-warning'); btn.classList.remove('btn-primary');
        if (!document.getElementById('cancelB26EditBtn')) {
            const cb = document.createElement('button'); cb.type = 'button'; cb.id = 'cancelB26EditBtn';
            cb.className = 'btn btn-danger'; cb.textContent = 'Cancel Edit'; cb.onclick = cancelB26Edit; cb.style.marginLeft = '10px';
            btn.parentNode.appendChild(cb);
        }
        document.getElementById('b26FormSection').scrollIntoView({ behavior: 'smooth' });
    };

    function cancelB26Edit() {
        editingB26Id = null;
        document.getElementById('b26Form').reset();
        document.getElementById('b26InqDate').value = new Date().toISOString().slice(0,10);
        b26FormState = { standard: '', stream: '' };
        document.querySelectorAll('#b26Std10Btn,#b26Std12Btn').forEach(b => b.classList.remove('selected'));
        document.querySelectorAll('#b26Sub10Sec,#b26Sub12Sec,#b26Sub12DynSec').forEach(s => s.classList.remove('show'));
        const btn = document.getElementById('b26SubmitBtn');
        btn.textContent = '‚ú® Submit Batch 2026 Inquiry'; btn.classList.remove('btn-warning'); btn.classList.add('btn-primary');
        const cb = document.getElementById('cancelB26EditBtn'); if (cb) cb.remove();
    }

    window.deleteB26 = async function(id) {
        if (userRole === 'staff') { alert('No permission.'); return; }
        if (!confirm('Delete this Batch 2026 inquiry?')) return;
        try { await deleteDoc(doc(db, 'batch2026', id)); alert('‚úÖ Deleted!'); }
        catch (error) { alert('Error: ' + error.message); }
    };

    window.clearB26Filters = function() {
        document.getElementById('b26Search').value = '';
        document.getElementById('b26FilterStd').value = '';
        document.getElementById('b26FilterStatus').value = '';
        updateBatch2026Table();
    };

    window.sendB26WhatsApp = function(phone, name, standard) {
        let p = phone.replace(/\D/g,'');
        if (p.length === 10) p = '91' + p;
        const msg = `Dear Parent of ${name},\n\nThank you for your interest in *Vismaya Education* ‚Äî Batch 2026! üéì\n\nüìò Standard: ${standard}th Standard\n\nWe are now enrolling students for our *Batch 2026* programme. Our expert faculty will provide focused coaching to help your child excel in board exams.\n\nüìç Highlights:\n‚Ä¢ Experienced teachers for ${standard}th Std\n‚Ä¢ CBSE & State Board coverage\n‚Ä¢ Morning / Evening batches available\n‚Ä¢ Personalised attention\n\nPlease visit us or call to complete your admission.\n\nWe look forward to seeing ${name} succeed! üåü\n\n*Vismaya Education Team*`;
        window.open(`https://wa.me/${p}?text=${encodeURIComponent(msg)}`, '_blank');
    };

    window.exportBatch2026ToExcel = function() {
        if (window.batch2026Inquiries.length === 0) { alert('No inquiries to export.'); return; }
        const data = window.batch2026Inquiries.map((r, i) => ({
            'S.No': i+1, 'Inquiry Date': r.inquiryDate, 'Student Name': r.studentName,
            'Standard': r.standard + 'th', 'Syllabus': r.syllabus, 'Medium': r.medium,
            'Stream': r.stream, 'Subjects': r.subjects,
            'DOB': r.dob, 'Gender': r.gender,
            'Previous School': r.prevSchool, 'Last Class': r.prevClass, 'Previous Score': r.prevScore,
            'Weak Subject': r.weakSubject, 'Strong Subject': r.strongSubject,
            'Target Score': r.targetScore, 'Career Goal': r.careerGoal,
            'Other Tuition': r.otherTuition,
            "Father's Name": r.fatherName, "Mother's Name": r.motherName,
            'Parent Phone': r.parentPhone, 'WhatsApp': r.whatsapp,
            'Alt Phone': r.altPhone, 'Email': r.email, 'Address': r.address,
            'Batch Timing': r.batchTiming, 'Mode': r.mode, 'Fee Range': r.feeRange,
            'Joining Date': r.joiningDate, 'Source': r.source, 'Referred By': r.referredBy,
            'Status': r.status, 'Follow Up Date': r.followUpDate, 'Notes': r.notes
        }));
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Batch 2026 Inquiries');
        XLSX.writeFile(wb, `Batch2026_Inquiries_${new Date().toISOString().slice(0,10)}.xlsx`);
    };

    // expose for html onclick
    window.b26SelectStd = window.b26SelectStd;

    // ============================================================
    // EXISTING INQUIRY FUNCTIONS
    // ============================================================
    document.getElementById('inquiryForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        if (userRole === 'staff') { alert('No permission.'); return; }
        const btn = document.getElementById('inqSubmitBtn');
        const isEditing = editingInquiryId !== null;
        btn.disabled = true; btn.textContent = isEditing ? 'Updating...' : 'Adding...';
        try {
            const d = {
                name: document.getElementById('inqName').value.trim(),
                phone: document.getElementById('inqPhone').value.trim(),
                altPhone: document.getElementById('inqAltPhone').value.trim() || '-',
                interestedClass: document.getElementById('inqClass').value,
                syllabus: document.getElementById('inqSyllabus').value || '-',
                source: document.getElementById('inqSource').value || '-',
                date: document.getElementById('inqDate').value,
                status: document.getElementById('inqStatus').value,
                followUpDate: document.getElementById('inqFollowUpDate').value || '-',
                expectedFee: parseFloat(document.getElementById('inqExpectedFee').value) || 0,
                notes: document.getElementById('inqNotes').value.trim() || '-'
            };
            if (isEditing) {
                await updateDoc(doc(db, 'inquiries', editingInquiryId), {...d, updatedAt: new Date().toISOString()});
                alert('‚úÖ Inquiry updated!'); cancelInquiryEdit();
            } else {
                await addDoc(collection(db, 'inquiries'), {...d, createdAt: new Date().toISOString()});
                alert('‚úÖ Inquiry added!');
            }
            this.reset(); document.getElementById('inqDate').value = new Date().toISOString().slice(0,10);
        } catch (error) { alert('Error: ' + error.message); }
        finally { btn.disabled = false; btn.textContent = isEditing ? 'Update Inquiry' : 'Add Inquiry'; }
    });

    window.updateInquiryTable = function() {
        const tbody = document.getElementById('inquiryTableBody');
        const search = document.getElementById('inquirySearch')?.value.toLowerCase() || '';
        const statusF = document.getElementById('inquiryStatusFilter')?.value || '';
        const classF = document.getElementById('inquiryClassFilter')?.value || '';
        let filtered = window.inquiries.filter(inq => {
            return (inq.name.toLowerCase().includes(search) || inq.phone.includes(search)) &&
                   (!statusF || inq.status === statusF) && (!classF || inq.interestedClass === classF);
        });
        if (!filtered.length) { tbody.innerHTML = '<tr><td colspan="11" style="text-align:center;padding:30px;color:#999;">No inquiries found.</td></tr>'; return; }
        const sbc = {'New':'badge-new','Follow Up':'badge-followup','Interested':'badge-interested','Not Interested':'badge-notinterested','Converted':'badge-converted'};
        tbody.innerHTML = filtered.map(inq => {
            const isConv = inq.status === 'Converted';
            const act = userRole === 'staff' ? '' : `<td><div class="action-buttons">
                ${!isConv ? `<button class="btn btn-success" onclick="openConvertModal('${inq.id}')" style="padding:5px 10px;font-size:0.85em;">üéì Convert</button>` : `<span style="color:#0c5460;font-size:0.85em;font-weight:600;">‚úÖ Converted</span>`}
                <button class="btn btn-whatsapp" onclick="sendInquiryWhatsApp('${inq.phone}','${inq.name.replace(/'/g,"\\'")}','${inq.interestedClass}')" style="padding:5px 10px;font-size:0.85em;">üì±</button>
                ${!isConv ? `<button class="btn btn-warning" onclick="editInquiry('${inq.id}')" style="padding:5px 10px;font-size:0.85em;">Edit</button>` : ''}
                <button class="btn btn-danger" onclick="deleteInquiry('${inq.id}')" style="padding:5px 10px;font-size:0.85em;">Delete</button>
            </div></td>`;
            return `<tr style="${isConv?'background:#f0fff4;':''}">
                <td>${inq.date}</td><td><strong>${inq.name}</strong></td>
                <td>${inq.phone}${inq.altPhone!=='-'?'<br><small style="color:#999;">'+inq.altPhone+'</small>':''}</td>
                <td>${inq.interestedClass}</td><td>${inq.syllabus}</td><td>${inq.source}</td>
                <td>${inq.expectedFee>0?'‚Çπ'+inq.expectedFee.toLocaleString():'-'}</td>
                <td><span class="badge ${sbc[inq.status]||'badge-pending'}">${inq.status}</span></td>
                <td style="font-size:0.9em;color:${inq.followUpDate!=='-'?'#856404':'#999'};">${inq.followUpDate!=='-'?'üìÖ '+inq.followUpDate:'-'}</td>
                <td style="font-size:0.85em;color:#666;max-width:150px;word-break:break-word;">${inq.notes}</td>
                ${act}
            </tr>`;
        }).join('');
    };

    window.updateInquiryStats = function() {
        const all = window.inquiries;
        document.getElementById('inqTotal').textContent = all.length;
        document.getElementById('inqNew').textContent = all.filter(i=>i.status==='New').length;
        document.getElementById('inqFollowup').textContent = all.filter(i=>i.status==='Follow Up').length;
        document.getElementById('inqInterested').textContent = all.filter(i=>i.status==='Interested').length;
        document.getElementById('inqNotInterested').textContent = all.filter(i=>i.status==='Not Interested').length;
        document.getElementById('inqConverted').textContent = all.filter(i=>i.status==='Converted').length;
    };

    window.editInquiry = function(id) {
        if (userRole === 'staff') { alert('No permission.'); return; }
        const inq = window.inquiries.find(i=>i.id===id); if (!inq) return;
        editingInquiryId = id;
        ['inqName','inqPhone','inqAltPhone','inqClass','inqSyllabus','inqSource','inqDate','inqStatus','inqFollowUpDate','inqExpectedFee','inqNotes'].forEach(fid => {
            const el = document.getElementById(fid); if (!el) return;
            const key = {inqName:'name',inqPhone:'phone',inqAltPhone:'altPhone',inqClass:'interestedClass',inqSyllabus:'syllabus',inqSource:'source',inqDate:'date',inqStatus:'status',inqFollowUpDate:'followUpDate',inqExpectedFee:'expectedFee',inqNotes:'notes'}[fid];
            el.value = (inq[key]==='-'||inq[key]===0) ? '' : inq[key];
        });
        const btn = document.getElementById('inqSubmitBtn');
        btn.textContent = 'Update Inquiry'; btn.classList.add('btn-warning'); btn.classList.remove('btn-primary');
        if (!document.getElementById('cancelInquiryEditBtn')) {
            const cb = document.createElement('button'); cb.type='button'; cb.id='cancelInquiryEditBtn';
            cb.className='btn btn-danger'; cb.textContent='Cancel Edit'; cb.onclick=cancelInquiryEdit; cb.style.marginLeft='10px';
            btn.parentNode.appendChild(cb);
        }
        document.getElementById('inquiryFormSection').scrollIntoView({behavior:'smooth'});
    };

    function cancelInquiryEdit() {
        editingInquiryId = null; document.getElementById('inquiryForm').reset();
        document.getElementById('inqDate').value = new Date().toISOString().slice(0,10);
        const btn = document.getElementById('inqSubmitBtn');
        btn.textContent = 'Add Inquiry'; btn.classList.remove('btn-warning'); btn.classList.add('btn-primary');
        const cb = document.getElementById('cancelInquiryEditBtn'); if (cb) cb.remove();
    }

    window.deleteInquiry = async function(id) {
        if (userRole==='staff') { alert('No permission.'); return; }
        if (!confirm('Delete this inquiry?')) return;
        try { await deleteDoc(doc(db,'inquiries',id)); alert('Deleted!'); } catch(e) { alert(e.message); }
    };

    window.clearInquiryFilters = function() {
        document.getElementById('inquirySearch').value=''; document.getElementById('inquiryStatusFilter').value=''; document.getElementById('inquiryClassFilter').value=''; updateInquiryTable();
    };

    window.openConvertModal = function(inquiryId) {
        if (userRole==='staff') { alert('No permission.'); return; }
        const inq = window.inquiries.find(i=>i.id===inquiryId); if (!inq) return;
        convertingInquiryId = inquiryId;
        document.getElementById('convName').value=inq.name; document.getElementById('convPhone').value=inq.phone;
        document.getElementById('convClass').value=inq.interestedClass; document.getElementById('convSyllabus').value=inq.syllabus==='-'?'':inq.syllabus;
        document.getElementById('convFee').value=inq.expectedFee>0?inq.expectedFee:'';
        document.getElementById('convAdmissionDate').value=new Date().toISOString().slice(0,10);
        document.getElementById('convRollNumber').value='';
        document.getElementById('convertInquiryInfo').innerHTML=`<strong>Inquiry Details:</strong><br>üìã Name: ${inq.name} | üìû Phone: ${inq.phone}<br>üè´ Class: ${inq.interestedClass} | üìÖ Date: ${inq.date}<br>üìù Notes: ${inq.notes}`;
        document.getElementById('convertModal').classList.add('active');
    };

    window.closeConvertModal = function() { document.getElementById('convertModal').classList.remove('active'); convertingInquiryId=null; document.getElementById('convertForm').reset(); };

    document.getElementById('convertForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const btn = e.target.querySelector('button[type="submit"]'); btn.disabled=true; btn.textContent='Converting...';
        try {
            const sd = {
                name: document.getElementById('convName').value.trim(), rollNumber: document.getElementById('convRollNumber').value.trim(),
                course: document.getElementById('convClass').value, syllabus: document.getElementById('convSyllabus').value||'-',
                phone: document.getElementById('convPhone').value.trim(), monthlyFee: parseFloat(document.getElementById('convFee').value),
                admissionDate: document.getElementById('convAdmissionDate').value||'-', status: document.getElementById('convStatus').value,
                convertedFromInquiry: convertingInquiryId, createdAt: new Date().toISOString()
            };
            if (window.students.find(s=>s.rollNumber===sd.rollNumber)) { alert(`‚ùå Roll number "${sd.rollNumber}" already exists.`); btn.disabled=false; btn.textContent='‚úÖ Convert to Student'; return; }
            await addDoc(collection(db,'students'), sd);
            await updateDoc(doc(db,'inquiries',convertingInquiryId), {status:'Converted', convertedAt:new Date().toISOString(), convertedStudentName:sd.name, convertedRollNumber:sd.rollNumber});
            alert(`üéâ "${sd.name}" converted to student!\nRoll: ${sd.rollNumber} | Class: ${sd.course}`);
            closeConvertModal();
        } catch(error) { alert('Error: '+error.message); btn.disabled=false; btn.textContent='‚úÖ Convert to Student'; }
    });

    window.sendInquiryWhatsApp = function(phone, name, cls) {
        let p=phone.replace(/\D/g,''); if(p.length===10) p='91'+p;
        const msg=`Dear ${name},\n\nThank you for your inquiry at *Vismaya Education*! üéì\n\nWe are happy to inform you about our ${cls} program.\n\nPlease visit or call to know more about:\n‚Ä¢ Class timings\n‚Ä¢ Fee structure\n‚Ä¢ Admission process\n\nWe look forward to welcoming you!\n*Vismaya Education Team*`;
        window.open(`https://wa.me/${p}?text=${encodeURIComponent(msg)}`, '_blank');
    };

    window.exportInquiriesToExcel = function() {
        if (!window.inquiries.length) { alert('No inquiries.'); return; }
        const data = window.inquiries.map((inq,i) => ({'S.No':i+1,'Date':inq.date,'Name':inq.name,'Phone':inq.phone,'Alt Phone':inq.altPhone,'Class':inq.interestedClass,'Syllabus':inq.syllabus,'Source':inq.source,'Expected Fee':inq.expectedFee,'Status':inq.status,'Follow Up Date':inq.followUpDate,'Notes':inq.notes}));
        const ws=XLSX.utils.json_to_sheet(data); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Inquiries');
        XLSX.writeFile(wb,`Inquiries_${new Date().toISOString().slice(0,10)}.xlsx`);
    };

    document.getElementById('inquirySearch').addEventListener('input', updateInquiryTable);

    // ============================================================
    // STUDENT FUNCTIONS
    // ============================================================
    document.getElementById('studentForm').addEventListener('submit', async function(e) {
        e.preventDefault(); if(userRole==='staff'){alert('No permission.');return;}
        const btn=e.target.querySelector('button[type="submit"]'); btn.disabled=true;
        const isEditing=editingStudentId!==null; btn.textContent=isEditing?'Updating...':'Adding...';
        try {
            const sd={name:document.getElementById('studentName').value,rollNumber:document.getElementById('rollNumber').value,course:document.getElementById('course').value,syllabus:document.getElementById('syllabus').value||'-',phone:document.getElementById('phoneNumber').value,monthlyFee:parseFloat(document.getElementById('monthlyFee').value),admissionDate:document.getElementById('admissionDate').value||'-',status:document.getElementById('studentStatus').value};
            if(isEditing){await updateDoc(doc(db,'students',editingStudentId),{...sd,updatedAt:new Date().toISOString()});alert('‚úÖ Updated!');cancelEdit();}
            else{await addDoc(collection(db,'students'),{...sd,createdAt:new Date().toISOString()});alert('‚úÖ Student added!');}
            this.reset();
        } catch(error){alert('Error: '+error.message);}
        finally{btn.disabled=false;btn.textContent=isEditing?'Update Student':'Add Student';}
    });

    window.collectFee = async function() {
        if(userRole==='staff'){alert('No permission.');return;}
        const studentId=document.getElementById('feeStudent').value,month=document.getElementById('feeMonth').value,amount=parseFloat(document.getElementById('feeAmount').value),method=document.getElementById('paymentMethod').value;
        if(!studentId||!month||!amount||!method){alert('Please fill all fields');return;}
        if(window.payments.some(p=>p.studentId===studentId&&p.month===month)){alert(`‚ùå Fee already collected for this month!`);return;}
        try {
            const payment={receiptNo:'REC'+Date.now().toString().slice(-6),studentId,month,amount,method,date:new Date().toISOString().slice(0,10),createdAt:new Date().toISOString()};
            const ref=await addDoc(collection(db,'payments'),payment);
            document.getElementById('feeStudent').value='';document.getElementById('feeAmount').value='';document.getElementById('paymentMethod').value='';
            showReceipt({id:ref.id,...payment});
        } catch(e){alert('Error: '+e.message);}
    };

    window.deleteStudent=async function(id){if(userRole==='staff'){alert('No permission.');return;}if(!confirm('Delete this student?'))return;try{await deleteDoc(doc(db,'students',id));const sp=window.payments.filter(p=>p.studentId===id);for(const p of sp)await deleteDoc(doc(db,'payments',p.id));alert('Deleted!');}catch(e){alert(e.message);}};
    window.deletePayment=async function(id,name,month,amount){if(userRole==='staff'){alert('No permission.');return;}if(!confirm(`Delete payment?\nStudent: ${name}\nMonth: ${month}\nAmount: ‚Çπ${amount}`))return;try{await deleteDoc(doc(db,'payments',id));alert('‚úÖ Deleted!');}catch(e){alert(e.message);}};
    window.editStudent=function(id){if(userRole==='staff'){alert('No permission.');return;}const s=window.students.find(x=>x.id===id);if(!s)return;editingStudentId=id;document.getElementById('studentName').value=s.name;document.getElementById('rollNumber').value=s.rollNumber;document.getElementById('course').value=s.course;document.getElementById('syllabus').value=s.syllabus==='-'?'':s.syllabus;document.getElementById('phoneNumber').value=s.phone;document.getElementById('monthlyFee').value=s.monthlyFee;document.getElementById('admissionDate').value=s.admissionDate==='-'?'':s.admissionDate;document.getElementById('studentStatus').value=s.status;const btn=document.querySelector('#studentForm button[type="submit"]');btn.textContent='Update Student';btn.classList.add('btn-warning');btn.classList.remove('btn-primary');if(!document.getElementById('cancelEditBtn')){const cb=document.createElement('button');cb.type='button';cb.id='cancelEditBtn';cb.className='btn btn-danger';cb.textContent='Cancel Edit';cb.onclick=cancelEdit;cb.style.marginLeft='10px';btn.parentNode.appendChild(cb);}window.scrollTo(0,0);};
    function cancelEdit(){editingStudentId=null;document.getElementById('studentForm').reset();const btn=document.querySelector('#studentForm button[type="submit"]');btn.textContent='Add Student';btn.classList.remove('btn-warning');btn.classList.add('btn-primary');const cb=document.getElementById('cancelEditBtn');if(cb)cb.remove();}

    window.updateStudentTable=function(){const tbody=document.getElementById('studentTableBody');const search=document.getElementById('studentSearch').value.toLowerCase();const sf=document.getElementById('sortField').value;const so=document.getElementById('sortOrder').value;let fs=window.students.filter(s=>s.name.toLowerCase().includes(search)||s.rollNumber.toLowerCase().includes(search));fs.sort((a,b)=>{let vA,vB;if(sf==='rollNumber'){vA=a.rollNumber.match(/\d+/)?parseInt(a.rollNumber.match(/\d+/)[0]):a.rollNumber;vB=b.rollNumber.match(/\d+/)?parseInt(b.rollNumber.match(/\d+/)[0]):b.rollNumber;}else if(sf==='monthlyFee'){vA=parseFloat(a[sf])||0;vB=parseFloat(b[sf])||0;}else{vA=(a[sf]||'').toString().toLowerCase();vB=(b[sf]||'').toString().toLowerCase();}if(vA<vB)return so==='asc'?-1:1;if(vA>vB)return so==='asc'?1:-1;return 0;});const cm=new Date().toISOString().slice(0,7);tbody.innerHTML=fs.map(s=>{const hasPaid=window.payments.some(p=>p.studentId===s.id&&p.month===cm);const mr=window.reminders.filter(r=>r.studentId===s.id&&r.month===cm);const rc=mr.length;const lr=mr[0]||null;let rc2='<td class="reminder-info">';if(rc>0){rc2+=`<span class="reminder-count">${rc} sent</span>`;if(lr){const d=new Date(lr.sentAt);rc2+=`<span class="reminder-date">Last: ${d.toLocaleDateString('en-IN',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'})}</span>`;}}else rc2+='<span style="color:#999;">None</span>';rc2+='</td>';const act=userRole==='staff'?'':`<td><div class="action-buttons"><button class="btn btn-warning" onclick="editStudent('${s.id}')" style="padding:5px 15px;">Edit</button><button class="btn btn-danger" onclick="deleteStudent('${s.id}')" style="padding:5px 15px;">Delete</button></div></td>`;const wa=`<td><button class="btn btn-whatsapp" onclick="sendWhatsAppReminder('${s.id}','${s.phone}','${s.name.replace(/'/g,"\\'")}',${s.monthlyFee})" style="padding:5px 15px;">üì± Remind</button></td>`;return `<tr><td>${s.rollNumber}</td><td>${s.name}</td><td>${s.course}</td><td>${s.syllabus}</td><td>${s.phone}</td><td>‚Çπ${s.monthlyFee}</td><td><span class="badge ${s.status==='Active'?'badge-active':'badge-inactive'}">${s.status}</span></td><td><span class="badge ${hasPaid?'badge-paid':'badge-pending'}">${hasPaid?'Paid':'Pending'}</span></td>${rc2}${act}${wa}</tr>`;}).join('');};
    window.updateFeeStudentSelect=function(){const sel=document.getElementById('feeStudent');sel.innerHTML='<option value="">Choose student...</option>'+window.students.map(s=>`<option value="${s.id}">${s.rollNumber} - ${s.name}</option>`).join('');};
    window.updatePaymentTable=function(){const tbody=document.getElementById('paymentTableBody');const sf=document.getElementById('paymentSortField')?.value||'date';const so=document.getElementById('paymentSortOrder')?.value||'desc';let sorted=[...window.payments];sorted.sort((a,b)=>{const sA=window.students.find(s=>s.id===a.studentId);const sB=window.students.find(s=>s.id===b.studentId);let vA,vB;if(sf==='date'){vA=new Date(a.date);vB=new Date(b.date);}else if(sf==='rollNumber'){const rA=sA?.rollNumber||'';const rB=sB?.rollNumber||'';vA=rA.match(/\d+/)?parseInt(rA.match(/\d+/)[0]):rA;vB=rB.match(/\d+/)?parseInt(rB.match(/\d+/)[0]):rB;}else if(sf==='studentName'){vA=(sA?.name||'').toLowerCase();vB=(sB?.name||'').toLowerCase();}else if(sf==='amount'){vA=a.amount;vB=b.amount;}if(vA<vB)return so==='asc'?-1:1;if(vA>vB)return so==='asc'?1:-1;return 0;});tbody.innerHTML=sorted.slice(0,20).map(p=>{const s=window.students.find(x=>x.id===p.studentId);const act=userRole==='staff'?'':`<td><div class="action-buttons"><button class="btn btn-primary" onclick='showReceipt(${JSON.stringify(p).replace(/'/g,"&#39;")})' style="padding:5px 15px;">View</button><button class="btn btn-danger" onclick="deletePayment('${p.id}','${s?s.name:'Unknown'}','${p.month}',${p.amount})" style="padding:5px 15px;">Delete</button></div></td>`;return `<tr><td>${p.receiptNo}</td><td>${p.date}</td><td>${s?s.rollNumber:'N/A'}</td><td>${s?s.name:'Unknown'}</td><td>${p.month}</td><td>‚Çπ${p.amount}</td><td>${p.method}</td>${act}</tr>`;}).join('');};
    window.showReceipt=function(payment){const s=window.students.find(x=>x.id===payment.studentId);document.getElementById('receiptContent').innerHTML=`<div class="receipt"><div class="receipt-header"><h2>üìö Vismaya Education Dashboard</h2><p>Fee Receipt</p></div><div class="receipt-details"><div class="receipt-row"><strong>Receipt No:</strong><span>${payment.receiptNo}</span></div><div class="receipt-row"><strong>Date:</strong><span>${payment.date}</span></div><div class="receipt-row"><strong>Student Name:</strong><span>${s?s.name:'Unknown'}</span></div><div class="receipt-row"><strong>Roll Number:</strong><span>${s?s.rollNumber:'N/A'}</span></div><div class="receipt-row"><strong>Class:</strong><span>${s?s.course:'N/A'}</span></div><div class="receipt-row"><strong>Syllabus:</strong><span>${s?s.syllabus:'N/A'}</span></div><div class="receipt-row"><strong>Fee Month:</strong><span>${payment.month}</span></div><div class="receipt-row"><strong>Payment Method:</strong><span>${payment.method}</span></div><div class="receipt-row receipt-total"><strong>Amount Paid:</strong><span>‚Çπ${payment.amount}</span></div></div><div style="text-align:center;margin-top:30px;padding-top:20px;border-top:2px dashed #667eea;"><p style="font-size:0.9em;color:#666;">Thank you for your payment!</p><p style="font-size:0.8em;color:#999;margin-top:10px;">Computer-generated receipt</p></div></div>`;document.getElementById('receiptModal').classList.add('active');};
    window.closeReceipt=function(){document.getElementById('receiptModal').classList.remove('active');};
    window.updateStats=function(){const cm=new Date().toISOString().slice(0,7);const total=window.students.length;document.getElementById('totalStudents').textContent=total;const ps=new Set(window.payments.filter(p=>p.month===cm).map(p=>p.studentId));document.getElementById('paidStudents').textContent=ps.size;document.getElementById('pendingStudents').textContent=total-ps.size;const col=window.payments.filter(p=>p.month===cm).reduce((s,p)=>s+p.amount,0);document.getElementById('totalCollected').textContent='‚Çπ'+col.toLocaleString();const pen=window.students.filter(s=>!ps.has(s.id)).reduce((s,x)=>s+x.monthlyFee,0);document.getElementById('totalPending').textContent='‚Çπ'+pen.toLocaleString();document.getElementById('thisMonth').textContent='‚Çπ'+window.students.reduce((s,x)=>s+x.monthlyFee,0).toLocaleString();};
    window.switchTab=function(tabName,el){document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));if(el)el.classList.add('active');document.getElementById(tabName).classList.add('active');};
    window.generateReport=function(){const month=document.getElementById('reportMonth').value;const course=document.getElementById('reportCourse').value;const syl=document.getElementById('reportSyllabus').value;const fs=document.getElementById('reportFeeStatus').value;let filtered=window.students;if(course)filtered=filtered.filter(s=>s.course===course);if(syl)filtered=filtered.filter(s=>s.syllabus===syl);const ws2=filtered.map(s=>({...s,hasPaid:window.payments.some(p=>p.studentId===s.id&&p.month===month)}));let final=ws2;if(fs==='paid')final=ws2.filter(s=>s.hasPaid);else if(fs==='pending')final=ws2.filter(s=>!s.hasPaid);const paid=final.filter(s=>s.hasPaid);const pend=final.filter(s=>!s.hasPaid);document.getElementById('reportTotalStudents').textContent=final.length;document.getElementById('reportPaidCount').textContent=paid.length;document.getElementById('reportPendingCount').textContent=pend.length;document.getElementById('reportTotalAmount').textContent='‚Çπ'+final.reduce((s,x)=>s+x.monthlyFee,0).toLocaleString();document.getElementById('reportCollectedAmount').textContent='‚Çπ'+paid.reduce((s,x)=>s+x.monthlyFee,0).toLocaleString();document.getElementById('reportPendingAmount').textContent='‚Çπ'+pend.reduce((s,x)=>s+x.monthlyFee,0).toLocaleString();document.getElementById('reportSummary').style.display='block';const tbody=document.getElementById('reportTableBody');tbody.innerHTML=final.map(s=>{const last=window.payments.filter(p=>p.studentId===s.id).sort((a,b)=>new Date(b.date)-new Date(a.date))[0];return `<tr><td>${s.rollNumber}</td><td>${s.name}</td><td>${s.course}</td><td>${s.syllabus}</td><td>‚Çπ${s.monthlyFee}</td><td><span class="badge ${s.hasPaid?'badge-paid':'badge-pending'}">${s.hasPaid?'Paid':'Pending'}</span></td><td>${last?last.date:'No payment yet'}</td></tr>`;}).join('')||'<tr><td colspan="7" style="text-align:center;padding:30px;color:#999;">No students found.</td></tr>';};
    document.getElementById('studentSearch').addEventListener('input',updateStudentTable);
    document.getElementById('feeStudent').addEventListener('change',function(){const s=window.students.find(x=>x.id===this.value);if(s)document.getElementById('feeAmount').value=s.monthlyFee;});

    // Teachers
    document.getElementById('teacherForm').addEventListener('submit',async function(e){e.preventDefault();if(userRole==='staff'){alert('No permission.');return;}const btn=e.target.querySelector('button[type="submit"]');btn.disabled=true;btn.textContent='Adding...';try{await addDoc(collection(db,'teachers'),{name:document.getElementById('teacherName').value,employeeId:document.getElementById('employeeId').value,subject:document.getElementById('teacherSubject').value||'-',phone:document.getElementById('teacherPhone').value,email:document.getElementById('teacherEmail').value||'-',salary:parseFloat(document.getElementById('teacherSalary').value),joiningDate:document.getElementById('teacherJoiningDate').value||'-',status:document.getElementById('teacherStatus').value,createdAt:new Date().toISOString()});alert('‚úÖ Teacher added!');this.reset();}catch(e){alert('Error: '+e.message);}finally{btn.disabled=false;btn.textContent='Add Teacher';}});
    window.updateTeacherTable=function(){const tbody=document.getElementById('teacherTableBody');const search=document.getElementById('teacherSearch')?.value.toLowerCase()||'';const filtered=window.teachers.filter(t=>t.name.toLowerCase().includes(search)||t.employeeId.toLowerCase().includes(search));tbody.innerHTML=filtered.map(t=>{const act=userRole==='staff'?'':`<td><button class="btn btn-danger" onclick="deleteTeacher('${t.id}')" style="padding:5px 15px;">Delete</button></td>`;return `<tr><td>${t.employeeId}</td><td>${t.name}</td><td>${t.subject}</td><td>${t.phone}</td><td>${t.email}</td><td>‚Çπ${t.salary.toLocaleString()}</td><td>${t.joiningDate}</td><td><span class="badge ${t.status==='Active'?'badge-active':'badge-inactive'}">${t.status}</span></td>${act}</tr>`;}).join('');};
    document.getElementById('teacherSearch')?.addEventListener('input',updateTeacherTable);
    window.deleteTeacher=async function(id){if(userRole==='staff'){alert('No permission.');return;}if(!confirm('Delete teacher?'))return;try{await deleteDoc(doc(db,'teachers',id));alert('Deleted!');}catch(e){alert(e.message);}};
    window.updateSalaryTeacherSelect=function(){const sel=document.getElementById('salaryTeacher');sel.innerHTML='<option value="">Choose teacher...</option>'+window.teachers.filter(t=>t.status==='Active').map(t=>`<option value="${t.id}">${t.employeeId} - ${t.name}</option>`).join('');};
    document.getElementById('salaryTeacher')?.addEventListener('change',function(){const t=window.teachers.find(x=>x.id===this.value);if(t)document.getElementById('salaryAmount').value=t.salary;});
    window.paySalary=async function(){if(userRole==='staff'){alert('No permission.');return;}const tid=document.getElementById('salaryTeacher').value,month=document.getElementById('salaryMonth').value,amount=parseFloat(document.getElementById('salaryAmount').value),method=document.getElementById('salaryPaymentMethod').value;if(!tid||!month||!amount||!method){alert('Please fill all fields');return;}if(window.salaries.some(s=>s.teacherId===tid&&s.month===month)){alert('‚ùå Salary already paid this month!');return;}try{await addDoc(collection(db,'salaries'),{receiptNo:'SAL'+Date.now().toString().slice(-6),teacherId:tid,month,amount,method,date:new Date().toISOString().slice(0,10),createdAt:new Date().toISOString()});document.getElementById('salaryTeacher').value='';document.getElementById('salaryAmount').value='';document.getElementById('salaryPaymentMethod').value='';alert('‚úÖ Salary paid!');}catch(e){alert(e.message);}};
    window.updateSalaryTable=function(){const tbody=document.getElementById('salaryTableBody');tbody.innerHTML=window.salaries.slice(0,20).map(s=>{const t=window.teachers.find(x=>x.id===s.teacherId);const act=userRole==='staff'?'':`<td><button class="btn btn-danger" onclick="deleteSalary('${s.id}','${t?.name||'Unknown'}','${s.month}',${s.amount})" style="padding:5px 15px;">Delete</button></td>`;return `<tr><td>${s.receiptNo}</td><td>${s.date}</td><td>${t?.employeeId||'N/A'}</td><td>${t?.name||'Unknown'}</td><td>${s.month}</td><td>‚Çπ${s.amount.toLocaleString()}</td><td>${s.method}</td>${act}</tr>`;}).join('');};
    window.deleteSalary=async function(id,name,month,amount){if(userRole==='staff'){alert('No permission.');return;}if(!confirm(`Delete salary?\nTeacher: ${name}\nMonth: ${month}\nAmount: ‚Çπ${amount}`))return;try{await deleteDoc(doc(db,'salaries',id));alert('‚úÖ Deleted!');}catch(e){alert(e.message);}};

    // Expenses
    document.getElementById('expenseForm').addEventListener('submit',async function(e){e.preventDefault();if(userRole==='staff'){alert('No permission.');return;}const btn=e.target.querySelector('button[type="submit"]');btn.disabled=true;const isEditing=editingExpenseId!==null;btn.textContent=isEditing?'Updating...':'Adding...';try{const ed={type:document.getElementById('expenseType').value,description:document.getElementById('expenseDescription').value,amount:parseFloat(document.getElementById('expenseAmount').value),date:document.getElementById('expenseDate').value,paymentMethod:document.getElementById('expensePaymentMethod').value,paidTo:document.getElementById('expensePaidTo').value||'-',forMonth:document.getElementById('expenseForMonth').value||'-',notes:document.getElementById('expenseNotes').value||'-'};if(isEditing){await updateDoc(doc(db,'expenses',editingExpenseId),{...ed,updatedAt:new Date().toISOString()});alert('‚úÖ Expense updated!');cancelExpenseEdit();}else{await addDoc(collection(db,'expenses'),{...ed,createdAt:new Date().toISOString()});alert('‚úÖ Expense added!');}this.reset();document.getElementById('expenseDate').value=new Date().toISOString().slice(0,10);}catch(e){alert('Error: '+e.message);}finally{btn.disabled=false;btn.textContent=isEditing?'Update Expense':'Add Expense';}});
    window.updateExpenseTable=function(){const tbody=document.getElementById('expenseTableBody');const search=document.getElementById('expenseSearch')?.value.toLowerCase()||'';const typeF=document.getElementById('expenseFilterType')?.value||'';const monthF=document.getElementById('expenseFilterMonth')?.value||'';let filtered=window.expenses.filter(e=>{const ms=e.description.toLowerCase().includes(search)||e.type.toLowerCase().includes(search)||(e.paidTo&&e.paidTo.toLowerCase().includes(search));return ms&&(!typeF||e.type===typeF)&&(!monthF||e.forMonth===monthF||e.date.startsWith(monthF));});if(!filtered.length){tbody.innerHTML='<tr><td colspan="9" style="text-align:center;padding:30px;color:#999;">No expenses found.</td></tr>';return;}tbody.innerHTML=filtered.map(e=>{const act=userRole==='staff'?'':`<td><div class="action-buttons"><button class="btn btn-warning" onclick="editExpense('${e.id}')" style="padding:5px 15px;">Edit</button><button class="btn btn-danger" onclick="deleteExpense('${e.id}')" style="padding:5px 15px;">Delete</button></div></td>`;return `<tr><td>${e.date}</td><td><span class="badge badge-active">${e.type}</span></td><td>${e.description}</td><td style="font-weight:600;color:#dc3545;">‚Çπ${e.amount.toLocaleString()}</td><td>${e.forMonth==='-'?'-':e.forMonth}</td><td>${e.paidTo}</td><td>${e.paymentMethod}</td><td style="font-size:0.9em;color:#666;">${e.notes}</td>${act}</tr>`;}).join('');};
    document.getElementById('expenseSearch')?.addEventListener('input',updateExpenseTable);
    window.clearExpenseFilters=function(){document.getElementById('expenseFilterType').value='';document.getElementById('expenseFilterMonth').value='';updateExpenseTable();};
    window.editExpense=function(id){if(userRole==='staff'){alert('No permission.');return;}const e=window.expenses.find(x=>x.id===id);if(!e)return;editingExpenseId=id;document.getElementById('expenseType').value=e.type;document.getElementById('expenseDescription').value=e.description;document.getElementById('expenseAmount').value=e.amount;document.getElementById('expenseDate').value=e.date;document.getElementById('expensePaymentMethod').value=e.paymentMethod;document.getElementById('expensePaidTo').value=e.paidTo==='-'?'':e.paidTo;document.getElementById('expenseForMonth').value=e.forMonth==='-'?'':e.forMonth;document.getElementById('expenseNotes').value=e.notes==='-'?'':e.notes;const btn=document.querySelector('#expenseForm button[type="submit"]');btn.textContent='Update Expense';btn.classList.add('btn-warning');btn.classList.remove('btn-primary');if(!document.getElementById('cancelExpenseEditBtn')){const cb=document.createElement('button');cb.type='button';cb.id='cancelExpenseEditBtn';cb.className='btn btn-danger';cb.textContent='Cancel Edit';cb.onclick=cancelExpenseEdit;cb.style.marginLeft='10px';btn.parentNode.appendChild(cb);}document.getElementById('expenseFormSection').scrollIntoView({behavior:'smooth'});};
    function cancelExpenseEdit(){editingExpenseId=null;document.getElementById('expenseForm').reset();document.getElementById('expenseDate').value=new Date().toISOString().slice(0,10);const btn=document.querySelector('#expenseForm button[type="submit"]');btn.textContent='Add Expense';btn.classList.remove('btn-warning');btn.classList.add('btn-primary');const cb=document.getElementById('cancelExpenseEditBtn');if(cb)cb.remove();}
    window.deleteExpense=async function(id){if(userRole==='staff'){alert('No permission.');return;}if(!confirm('Delete?'))return;try{await deleteDoc(doc(db,'expenses',id));alert('Deleted!');}catch(e){alert(e.message);}};
    window.updateExpenseSummary=function(){const cm=new Date().toISOString().slice(0,7);document.getElementById('totalExpenses').textContent='‚Çπ'+window.expenses.reduce((s,e)=>s+e.amount,0).toLocaleString();document.getElementById('thisMonthExpenses').textContent='‚Çπ'+window.expenses.filter(e=>e.date.startsWith(cm)||e.forMonth===cm).reduce((s,e)=>s+e.amount,0).toLocaleString();document.getElementById('expenseCount').textContent=window.expenses.length;};

    // WhatsApp
    window.sendWhatsAppReminder=async function(sid,phone,name,fee){let p=phone
