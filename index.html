<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vismaya Education Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .auth-container {
            max-width: 450px;
            margin: 100px auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }
        .auth-header { text-align: center; margin-bottom: 30px; }
        .auth-header h1 { color: #667eea; font-size: 2em; margin-bottom: 10px; }
        .auth-header p { color: #666; font-size: 0.95em; }
        .auth-form { display: flex; flex-direction: column; gap: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 8px; font-weight: 600; color: #333; }
        .form-group input { padding: 14px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em; transition: border-color 0.3s; }
        .form-group input:focus { outline: none; border-color: #667eea; }
        .form-group select { padding: 14px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em; transition: border-color 0.3s; }
        .auth-btn {
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 8px;
            font-size: 1.1em; font-weight: 600; cursor: pointer; transition: all 0.3s; margin-top: 10px;
        }
        .auth-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102,126,234,0.4); }
        .auth-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .auth-link { text-align: center; margin-top: 20px; color: #666; font-size: 0.9em; }
        .auth-link a { color: #667eea; text-decoration: none; font-weight: 600; cursor: pointer; }
        .auth-link a:hover { text-decoration: underline; }
        .error-message, .success-message { padding: 12px; border-radius: 8px; font-size: 0.9em; text-align: center; display: none; }
        .error-message { background: #f8d7da; color: #721c24; }
        .success-message { background: #d4edda; color: #155724; }
        .error-message.show, .success-message.show { display: block; }
        .logout-btn { background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .logout-btn:hover { background: #c82333; transform: translateY(-2px); }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 20px 30px;
            display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;
        }
        .header-content h1 { font-size: 1.8em; margin-bottom: 5px; }
        .header-content p { opacity: 0.9; font-size: 0.95em; }
        .user-info { text-align: right; }
        .user-info p { margin-bottom: 5px; opacity: 0.9; }
        .role-badge { display: inline-block; padding: 4px 12px; background: rgba(255,255,255,0.2); border-radius: 12px; font-size: 0.85em; margin-top: 5px; }
        .loading { text-align: center; padding: 20px; color: #667eea; font-size: 1.2em; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; padding: 30px; background: #f8f9fa; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; }
        .stat-card h3 { color: #667eea; font-size: 2em; margin-bottom: 5px; }
        .stat-card p { color: #666; font-size: 0.9em; }
        .tabs { display: flex; background: #f8f9fa; padding: 0 30px; border-bottom: 2px solid #e0e0e0; overflow-x: auto; }
        .tab { padding: 15px 25px; cursor: pointer; border: none; background: transparent; font-size: 0.95em; font-weight: 600; color: #666; transition: all 0.3s; border-bottom: 3px solid transparent; white-space: nowrap; }
        .tab.active { color: #667eea; border-bottom-color: #667eea; }
        .tab:hover { background: rgba(102,126,234,0.1); }
        .tab-content { display: none; padding: 30px; }
        .tab-content.active { display: block; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .btn { padding: 12px 30px; border: none; border-radius: 8px; font-size: 1em; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102,126,234,0.4); }
        .btn-whatsapp { background: #25D366; color: white; display: inline-flex; align-items: center; gap: 5px; }
        .btn-whatsapp:hover { background: #128C7E; transform: translateY(-2px); }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover:not(:disabled) { background: #218838; transform: translateY(-2px); }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-info:hover:not(:disabled) { background: #138496; transform: translateY(-2px); }
        .table-container { overflow-x: auto; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #e0e0e0; }
        th { background: #f8f9fa; font-weight: 600; color: #333; }
        tr:hover { background: #f8f9fa; }
        .badge { padding: 5px 10px; border-radius: 20px; font-size: 0.85em; font-weight: 600; }
        .badge-active { background: #d4edda; color: #155724; }
        .badge-inactive { background: #f8d7da; color: #721c24; }
        .badge-paid { background: #d4edda; color: #155724; }
        .badge-pending { background: #fff3cd; color: #856404; }
        .badge-new { background: #cce5ff; color: #004085; }
        .badge-followup { background: #fff3cd; color: #856404; }
        .badge-interested { background: #d4edda; color: #155724; }
        .badge-notinterested { background: #f8d7da; color: #721c24; }
        .badge-converted { background: #d1ecf1; color: #0c5460; }
        .search-box { padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em; width: 100%; max-width: 400px; margin-bottom: 20px; }
        .sort-controls { display: flex; gap: 10px; align-items: center; margin-bottom: 20px; flex-wrap: wrap; }
        .sort-controls label { font-weight: 600; color: #333; }
        .sort-controls select { padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95em; cursor: pointer; }
        .action-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { color: #667eea; }
        .close-btn { background: none; border: none; font-size: 1.5em; cursor: pointer; color: #666; }
        .receipt { border: 2px solid #667eea; padding: 20px; border-radius: 10px; margin-top: 20px; }
        .receipt-header { text-align: center; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 2px dashed #667eea; }
        .receipt-details { margin-bottom: 20px; }
        .receipt-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #e0e0e0; }
        .receipt-total { font-size: 1.3em; font-weight: 700; color: #667eea; }
        .readonly-notice { background: #fff3cd; color: #856404; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; font-weight: 600; }
        #loginPage, #signupPage, #resetPage { display: none; }
        #mainApp { display: none; }

        /* Inquiry Styles */
        .inquiry-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .inquiry-stat { background: white; border-radius: 12px; padding: 18px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.08); border-top: 4px solid #667eea; }
        .inquiry-stat.new-color { border-top-color: #17a2b8; }
        .inquiry-stat.followup-color { border-top-color: #ffc107; }
        .inquiry-stat.interested-color { border-top-color: #28a745; }
        .inquiry-stat.notinterested-color { border-top-color: #dc3545; }
        .inquiry-stat.converted-color { border-top-color: #667eea; }
        .inquiry-stat h3 { font-size: 1.8em; font-weight: 700; margin-bottom: 4px; }
        .inquiry-stat p { font-size: 0.8em; color: #666; }
        .inquiry-stat.new-color h3 { color: #17a2b8; }
        .inquiry-stat.followup-color h3 { color: #ffc107; }
        .inquiry-stat.interested-color h3 { color: #28a745; }
        .inquiry-stat.notinterested-color h3 { color: #dc3545; }
        .inquiry-stat.converted-color h3 { color: #667eea; }

        .convert-modal-content { background: white; padding: 30px; border-radius: 15px; max-width: 700px; width: 95%; max-height: 90vh; overflow-y: auto; }
        .convert-notice { background: #d1ecf1; color: #0c5460; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-weight: 600; border-left: 4px solid #17a2b8; }

        /* Accounts Tab Styles */
        .accounts-month-selector { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 25px; display: flex; align-items: center; gap: 20px; flex-wrap: wrap; }
        .accounts-month-selector label { font-weight: 600; color: #333; font-size: 1em; }
        .accounts-month-selector input[type="month"] { padding: 10px 15px; border: 2px solid #667eea; border-radius: 8px; font-size: 1em; color: #333; }
        .accounts-summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .accounts-card { padding: 25px 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); position: relative; overflow: hidden; }
        .accounts-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; }
        .accounts-card.income { background: #f0fff4; }
        .accounts-card.income::before { background: #28a745; }
        .accounts-card.expense-card { background: #fff5f5; }
        .accounts-card.expense-card::before { background: #dc3545; }
        .accounts-card.salary-card { background: #fff8f0; }
        .accounts-card.salary-card::before { background: #fd7e14; }
        .accounts-card.profit { background: #f0f4ff; }
        .accounts-card.profit::before { background: #667eea; }
        .accounts-card-icon { font-size: 2em; margin-bottom: 10px; }
        .accounts-card-label { font-size: 0.9em; color: #666; margin-bottom: 8px; font-weight: 500; }
        .accounts-card-value { font-size: 1.9em; font-weight: 700; }
        .accounts-card.income .accounts-card-value { color: #28a745; }
        .accounts-card.expense-card .accounts-card-value { color: #dc3545; }
        .accounts-card.salary-card .accounts-card-value { color: #fd7e14; }
        .accounts-card.profit .accounts-card-value { color: #667eea; }
        .accounts-breakdown { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 30px; }
        @media (max-width: 768px) { .accounts-breakdown { grid-template-columns: 1fr; } }
        .accounts-breakdown-card { background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); overflow: hidden; }
        .accounts-breakdown-header { padding: 15px 20px; font-weight: 700; font-size: 1em; color: white; }
        .accounts-breakdown-header.green { background: linear-gradient(135deg, #28a745, #20c997); }
        .accounts-breakdown-header.red { background: linear-gradient(135deg, #dc3545, #e83e8c); }
        .accounts-breakdown-header.orange { background: linear-gradient(135deg, #fd7e14, #ffc107); }
        .accounts-breakdown-body { padding: 10px 0; }
        .accounts-breakdown-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; border-bottom: 1px solid #f0f0f0; font-size: 0.92em; }
        .accounts-breakdown-row:last-child { border-bottom: none; }
        .accounts-breakdown-row:hover { background: #f8f9fa; }
        .accounts-breakdown-row .row-label { color: #444; }
        .accounts-breakdown-row .row-amount { font-weight: 600; }
        .accounts-breakdown-row .row-amount.green { color: #28a745; }
        .accounts-breakdown-row .row-amount.red { color: #dc3545; }
        .accounts-breakdown-row .row-amount.orange { color: #fd7e14; }
        .accounts-breakdown-empty { padding: 20px; text-align: center; color: #999; font-size: 0.9em; }
        .accounts-breakdown-total { display: flex; justify-content: space-between; align-items: center; padding: 14px 20px; background: #f8f9fa; font-weight: 700; font-size: 1em; border-top: 2px solid #e0e0e0; }
        .net-result-banner { border-radius: 12px; padding: 25px 30px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 30px; }
        .net-result-banner.profit-banner { background: linear-gradient(135deg, #28a745, #20c997); color: white; }
        .net-result-banner.loss-banner { background: linear-gradient(135deg, #dc3545, #e83e8c); color: white; }
        .net-result-banner .net-label { font-size: 1.1em; opacity: 0.9; }
        .net-result-banner .net-value { font-size: 2.2em; font-weight: 700; }
        .net-result-banner .net-formula { font-size: 0.9em; opacity: 0.8; margin-top: 4px; }
        .monthly-history-table th { background: #f8f9fa; }
        .monthly-history-table tr.profit-row td { background: #f0fff4; }
        .monthly-history-table tr.loss-row td { background: #fff5f5; }
        .reminder-info { font-size: 0.85em; color: #666; }
        .reminder-count { font-weight: 600; color: #667eea; }
        .reminder-date { font-size: 0.8em; color: #999; display: block; margin-top: 2px; }

        @media print {
            body * { visibility: hidden; }
            .receipt, .receipt * { visibility: visible; }
            .receipt { position: absolute; left: 0; top: 0; }
        }
    </style>
</head>
<body>

<!-- Login Page -->
<div id="loginPage">
    <div class="auth-container">
        <div class="auth-header">
            <h1>üìö Vismaya Education</h1>
            <p>Fee Collection & Management System</p>
        </div>
        <div id="loginError" class="error-message"></div>
        <form id="loginForm" class="auth-form">
            <div class="form-group">
                <label>Email Address</label>
                <input type="email" id="loginEmail" required placeholder="Enter your email">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="loginPassword" required placeholder="Enter your password">
            </div>
            <button type="submit" class="auth-btn" id="loginBtn">Login</button>
        </form>
        <div class="auth-link"><a onclick="showPage('resetPage')">Forgot Password?</a></div>
        <div class="auth-link">Don't have an account? <a onclick="showPage('signupPage')">Sign Up</a></div>
    </div>
</div>

<!-- Signup Page -->
<div id="signupPage">
    <div class="auth-container">
        <div class="auth-header">
            <h1>üìö Create Account</h1>
            <p>Join Vismaya Education Dashboard</p>
        </div>
        <div id="signupError" class="error-message"></div>
        <div id="signupSuccess" class="success-message"></div>
        <form id="signupForm" class="auth-form">
            <div class="form-group"><label>Full Name</label><input type="text" id="signupName" required placeholder="Enter your name"></div>
            <div class="form-group"><label>Email Address</label><input type="email" id="signupEmail" required placeholder="Enter your email"></div>
            <div class="form-group"><label>Password</label><input type="password" id="signupPassword" required placeholder="Create a password (min 6 characters)"></div>
            <div class="form-group">
                <label>Role</label>
                <select id="signupRole" required>
                    <option value="">Select your role</option>
                    <option value="staff">Staff (Read Only)</option>
                    <option value="admin">Admin (Full Access)</option>
                </select>
            </div>
            <button type="submit" class="auth-btn" id="signupBtn">Create Account</button>
        </form>
        <div class="auth-link">Already have an account? <a onclick="showPage('loginPage')">Login</a></div>
    </div>
</div>

<!-- Password Reset Page -->
<div id="resetPage">
    <div class="auth-container">
        <div class="auth-header">
            <h1>üîí Reset Password</h1>
            <p>Enter your email to receive reset instructions</p>
        </div>
        <div id="resetError" class="error-message"></div>
        <div id="resetSuccess" class="success-message"></div>
        <form id="resetForm" class="auth-form">
            <div class="form-group"><label>Email Address</label><input type="email" id="resetEmail" required placeholder="Enter your email"></div>
            <button type="submit" class="auth-btn" id="resetBtn">Send Reset Link</button>
        </form>
        <div class="auth-link">Remember your password? <a onclick="showPage('loginPage')">Login</a></div>
    </div>
</div>

<!-- Main Application -->
<div id="mainApp">
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>üìö Vismaya Education Dashboard</h1>
                <p>Fee Collection & Management System</p>
            </div>
            <div class="user-info">
                <p>üë§ <span id="userName"></span></p>
                <p><span id="userEmail"></span></p>
                <span class="role-badge" id="userRole"></span>
                <div style="margin-top: 10px;">
                    <button class="logout-btn" onclick="logout()">Logout</button>
                </div>
            </div>
        </div>

        <div class="loading" id="loadingIndicator">‚è≥ Loading data from cloud...</div>

        <div id="mainContent" style="display: none;">
            <div id="staffNotice" class="readonly-notice" style="display: none;">
                üìñ You are logged in as STAFF with read-only access. Contact an admin for write permissions.
            </div>

            <div class="stats-grid">
                <div class="stat-card"><h3 id="totalStudents">0</h3><p>Total Students</p></div>
                <div class="stat-card"><h3 id="paidStudents">0</h3><p>Students Paid</p></div>
                <div class="stat-card"><h3 id="pendingStudents">0</h3><p>Students Pending</p></div>
                <div class="stat-card"><h3 id="totalCollected">‚Çπ0</h3><p>Collected This Month</p></div>
                <div class="stat-card"><h3 id="totalPending">‚Çπ0</h3><p>Pending Fees</p></div>
                <div class="stat-card"><h3 id="thisMonth">‚Çπ0</h3><p>Total Expected (This Month)</p></div>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="switchTab('students', this)">Students</button>
                <button class="tab" onclick="switchTab('fees', this)">Fee Collection</button>
                <button class="tab" onclick="switchTab('teachers', this)">Teachers</button>
                <button class="tab" onclick="switchTab('expenses', this)">Expenses</button>
                <button class="tab" onclick="switchTab('accounts', this)">Accounts</button>
                <button class="tab" onclick="switchTab('inquiries', this)">üîç Inquiry Form</button>
                <button class="tab" onclick="switchTab('reports', this)">Reports</button>
            </div>

            <!-- Students Tab -->
            <div id="students" class="tab-content active">
                <div id="studentFormSection">
                    <h2 style="margin-bottom: 20px;">Add Students</h2>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 30px;">
                        <h3 style="margin-bottom: 15px; color: #667eea;">üì§ Bulk Upload from Excel</h3>
                        <p style="margin-bottom: 15px; color: #666;">Upload an Excel file (.xlsx or .xls) to add multiple students at once.</p>
                        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                            <input type="file" id="excelFile" accept=".xlsx,.xls" style="padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                            <button type="button" class="btn btn-success" onclick="uploadExcel()">Upload & Import</button>
                            <button type="button" class="btn btn-primary" onclick="downloadTemplate()">üì• Download Template</button>
                        </div>
                        <div id="uploadStatus" style="margin-top: 15px; padding: 10px; border-radius: 5px; display: none;"></div>
                    </div>

                    <h3 style="margin-bottom: 20px;">‚ûï Add Single Student</h3>
                    <form id="studentForm">
                        <div class="form-grid">
                            <div class="form-group"><label>Student Name *</label><input type="text" id="studentName" required></div>
                            <div class="form-group"><label>Roll Number *</label><input type="text" id="rollNumber" required></div>
                            <div class="form-group">
                                <label>Class *</label>
                                <select id="course" required>
                                    <option value="">Select Class</option>
                                    <option>Class 1</option><option>Class 2</option><option>Class 3</option><option>Class 4</option>
                                    <option>Class 5</option><option>Class 6</option><option>Class 7</option><option>Class 8</option>
                                    <option>Class 9</option><option>Class 10</option><option>Class 11</option><option>Class 12</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Syllabus (Optional)</label>
                                <select id="syllabus">
                                    <option value="">Select Syllabus</option>
                                    <option value="CBSE">CBSE</option>
                                    <option value="Matric">Matric</option>
                                </select>
                            </div>
                            <div class="form-group"><label>Phone Number *</label><input type="tel" id="phoneNumber" required></div>
                            <div class="form-group"><label>Monthly Fee (‚Çπ) *</label><input type="number" id="monthlyFee" required></div>
                            <div class="form-group"><label>Admission Date (Optional)</label><input type="date" id="admissionDate"></div>
                            <div class="form-group">
                                <label>Status *</label>
                                <select id="studentStatus" required>
                                    <option value="">Select Status</option>
                                    <option value="Active">Active</option>
                                    <option value="Inactive">Inactive</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Student</button>
                    </form>
                </div>

                <h2 style="margin-top: 40px; margin-bottom: 20px;">All Students</h2>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                    <div style="flex: 1; min-width: 250px;">
                        <input type="text" class="search-box" placeholder="Search by name or roll number..." id="studentSearch" style="margin-bottom: 0; max-width: 100%;">
                    </div>
                    <div class="sort-controls">
                        <label>Sort By:</label>
                        <select id="sortField" onchange="updateStudentTable()">
                            <option value="rollNumber">Roll Number</option>
                            <option value="name">Name</option>
                            <option value="course">Class</option>
                            <option value="monthlyFee">Fee Amount</option>
                            <option value="status">Status</option>
                        </select>
                        <select id="sortOrder" onchange="updateStudentTable()">
                            <option value="asc">Ascending</option>
                            <option value="desc">Descending</option>
                        </select>
                    </div>
                    <button class="btn btn-success" onclick="exportStudentsToExcel()" style="padding: 10px 20px;">üì• Export to Excel</button>
                    <button class="btn btn-whatsapp" onclick="sendBulkWhatsAppReminders()" style="padding: 10px 20px;">üì± Send Reminders</button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Roll No.</th><th>Name</th><th>Class</th><th>Syllabus</th><th>Phone</th>
                                <th>Monthly Fee</th><th>Status</th><th>Fee Status</th><th>Reminders</th>
                                <th id="actionsHeader">Actions</th><th id="whatsappHeader">WhatsApp</th>
                            </tr>
                        </thead>
                        <tbody id="studentTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Fee Collection Tab -->
            <div id="fees" class="tab-content">
                <div id="feeFormSection">
                    <h2 style="margin-bottom: 20px;">Collect Fee</h2>
                    <div class="form-grid">
                        <div class="form-group"><label>Select Student *</label><select id="feeStudent" required><option value="">Choose student...</option></select></div>
                        <div class="form-group"><label>Fee Month *</label><input type="month" id="feeMonth" required></div>
                        <div class="form-group"><label>Amount (‚Çπ) *</label><input type="number" id="feeAmount" required></div>
                        <div class="form-group">
                            <label>Payment Method *</label>
                            <select id="paymentMethod" required>
                                <option value="">Select method...</option>
                                <option value="Cash">Cash</option><option value="UPI">UPI</option>
                                <option value="Card">Card</option><option value="Bank Transfer">Bank Transfer</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="collectFee()">Collect Fee</button>
                </div>

                <h2 style="margin-top: 40px; margin-bottom: 20px;">üìä Paid Students Report</h2>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 30px;">
                    <div class="form-grid" style="margin-bottom: 20px;">
                        <div class="form-group"><label>Select Month</label><input type="month" id="paidReportMonth"></div>
                        <div class="form-group">
                            <label>Filter by Class</label>
                            <select id="paidReportClass">
                                <option value="">All Classes</option>
                                <option>Class 1</option><option>Class 2</option><option>Class 3</option><option>Class 4</option>
                                <option>Class 5</option><option>Class 6</option><option>Class 7</option><option>Class 8</option>
                                <option>Class 9</option><option>Class 10</option><option>Class 11</option><option>Class 12</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Filter by Payment Method</label>
                            <select id="paidReportMethod">
                                <option value="">All Methods</option>
                                <option value="Cash">Cash</option><option value="UPI">UPI</option>
                                <option value="Card">Card</option><option value="Bank Transfer">Bank Transfer</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="generatePaidStudentsReport()">Generate Report</button>
                        <button class="btn btn-success" onclick="exportPaidStudentsReport()" style="display: none;" id="exportPaidReportBtn">üì• Export Report to Excel</button>
                    </div>
                </div>
                <div id="paidReportSummary" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px; color: #667eea;">Report Summary</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;"><p style="color: #666; font-size: 0.9em; margin-bottom: 5px;">Total Paid Students</p><p style="font-size: 1.8em; font-weight: 700; color: #28a745;" id="paidReportCount">0</p></div>
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;"><p style="color: #666; font-size: 0.9em; margin-bottom: 5px;">Total Amount Collected</p><p style="font-size: 1.8em; font-weight: 700; color: #667eea;" id="paidReportTotal">‚Çπ0</p></div>
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;"><p style="color: #666; font-size: 0.9em; margin-bottom: 5px;">Average Fee</p><p style="font-size: 1.8em; font-weight: 700; color: #764ba2;" id="paidReportAverage">‚Çπ0</p></div>
                    </div>
                </div>
                <div id="paidStudentsTableContainer" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="color: #667eea;">Students Who Paid Fees</h3>
                        <input type="text" class="search-box" placeholder="Search..." id="paidStudentsSearch" onkeyup="filterPaidStudentsTable()" style="margin-bottom: 0; max-width: 300px;">
                    </div>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>S.No</th><th>Roll No.</th><th>Student Name</th><th>Class</th><th>Phone</th><th>Amount Paid</th><th>Payment Date</th><th>Payment Method</th><th>Receipt No.</th></tr></thead>
                            <tbody id="paidStudentsTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <h2 style="margin-top: 40px; margin-bottom: 20px;">Recent Payments (Last 20)</h2>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                    <div class="sort-controls">
                        <label>Sort By:</label>
                        <select id="paymentSortField" onchange="updatePaymentTable()">
                            <option value="date">Recent First</option><option value="rollNumber">Roll Number</option>
                            <option value="studentName">Student Name</option><option value="amount">Amount</option>
                        </select>
                        <select id="paymentSortOrder" onchange="updatePaymentTable()">
                            <option value="desc">Descending</option><option value="asc">Ascending</option>
                        </select>
                    </div>
                    <button class="btn btn-success" onclick="exportRecentPaymentsToExcel()" style="padding: 10px 20px;">üì• Export to Excel</button>
                </div>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Receipt No.</th><th>Date</th><th>Roll No.</th><th>Student</th><th>Month</th><th>Amount</th><th>Method</th><th id="paymentActionsHeader">Actions</th></tr></thead>
                        <tbody id="paymentTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Teachers Tab -->
            <div id="teachers" class="tab-content">
                <div id="teacherFormSection">
                    <h2 style="margin-bottom: 20px;">üë®‚Äçüè´ Add Teacher</h2>
                    <form id="teacherForm">
                        <div class="form-grid">
                            <div class="form-group"><label>Teacher Name *</label><input type="text" id="teacherName" required></div>
                            <div class="form-group"><label>Employee ID *</label><input type="text" id="employeeId" required></div>
                            <div class="form-group"><label>Subject/Specialization</label><input type="text" id="teacherSubject" placeholder="e.g., Mathematics, Science"></div>
                            <div class="form-group"><label>Phone Number *</label><input type="tel" id="teacherPhone" required></div>
                            <div class="form-group"><label>Email (Optional)</label><input type="email" id="teacherEmail"></div>
                            <div class="form-group"><label>Monthly Salary (‚Çπ) *</label><input type="number" id="teacherSalary" required></div>
                            <div class="form-group"><label>Joining Date</label><input type="date" id="teacherJoiningDate"></div>
                            <div class="form-group">
                                <label>Status *</label>
                                <select id="teacherStatus" required>
                                    <option value="">Select Status</option><option value="Active">Active</option><option value="Inactive">Inactive</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Teacher</button>
                    </form>
                </div>
                <h2 style="margin-top: 40px; margin-bottom: 20px;">All Teachers</h2>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                    <input type="text" class="search-box" placeholder="Search by name or employee ID..." id="teacherSearch" style="margin-bottom: 0; max-width: 400px;">
                    <button class="btn btn-success" onclick="exportTeachersToExcel()" style="padding: 10px 20px;">üì• Export to Excel</button>
                </div>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Employee ID</th><th>Name</th><th>Subject</th><th>Phone</th><th>Email</th><th>Monthly Salary</th><th>Joining Date</th><th>Status</th><th id="teacherActionsHeader">Actions</th></tr></thead>
                        <tbody id="teacherTableBody"></tbody>
                    </table>
                </div>

                <div id="salaryFormSection" style="margin-top: 40px;">
                    <h2 style="margin-bottom: 20px;">üí∞ Pay Salary</h2>
                    <div class="form-grid">
                        <div class="form-group"><label>Select Teacher *</label><select id="salaryTeacher" required><option value="">Choose teacher...</option></select></div>
                        <div class="form-group"><label>Salary Month *</label><input type="month" id="salaryMonth" required></div>
                        <div class="form-group"><label>Amount (‚Çπ) *</label><input type="number" id="salaryAmount" required></div>
                        <div class="form-group">
                            <label>Payment Method *</label>
                            <select id="salaryPaymentMethod" required>
                                <option value="">Select method...</option>
                                <option value="Cash">Cash</option><option value="Bank Transfer">Bank Transfer</option>
                                <option value="UPI">UPI</option><option value="Cheque">Cheque</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="paySalary()">Pay Salary</button>
                </div>
                <h2 style="margin-top: 40px; margin-bottom: 20px;">Recent Salary Payments</h2>
                <div style="display: flex; justify-content: flex-end; margin-bottom: 15px;">
                    <button class="btn btn-success" onclick="exportSalaryPaymentsToExcel()" style="padding: 10px 20px;">üì• Export to Excel</button>
                </div>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Receipt No.</th><th>Date</th><th>Employee ID</th><th>Teacher Name</th><th>Month</th><th>Amount</th><th>Method</th><th id="salaryActionsHeader">Actions</th></tr></thead>
                        <tbody id="salaryTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Expenses Tab -->
            <div id="expenses" class="tab-content">
                <div id="expenseFormSection">
                    <h2 style="margin-bottom: 20px;">üíµ Add Expense</h2>
                    <form id="expenseForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Expense Type *</label>
                                <select id="expenseType" required>
                                    <option value="">Select Type</option>
                                    <option value="Rent">Rent</option><option value="Electricity">Electricity</option>
                                    <option value="Water">Water</option><option value="Internet">Internet</option>
                                    <option value="Maintenance">Maintenance</option><option value="Supplies">Supplies</option>
                                    <option value="Transportation">Transportation</option><option value="Marketing">Marketing</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group"><label>Description *</label><input type="text" id="expenseDescription" required placeholder="e.g., Monthly center rent"></div>
                            <div class="form-group"><label>Amount (‚Çπ) *</label><input type="number" id="expenseAmount" required></div>
                            <div class="form-group"><label>Expense Date *</label><input type="date" id="expenseDate" required></div>
                            <div class="form-group">
                                <label>Payment Method *</label>
                                <select id="expensePaymentMethod" required>
                                    <option value="">Select method...</option>
                                    <option value="Cash">Cash</option><option value="Bank Transfer">Bank Transfer</option>
                                    <option value="UPI">UPI</option><option value="Cheque">Cheque</option><option value="Card">Card</option>
                                </select>
                            </div>
                            <div class="form-group"><label>Paid To</label><input type="text" id="expensePaidTo" placeholder="e.g., Landlord name, Vendor name"></div>
                            <div class="form-group"><label>For Month (Optional)</label><input type="month" id="expenseForMonth"></div>
                            <div class="form-group"><label>Notes (Optional)</label><input type="text" id="expenseNotes" placeholder="Additional details"></div>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Expense</button>
                    </form>
                </div>
                <h2 style="margin-top: 40px; margin-bottom: 20px;">All Expenses</h2>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <div class="form-grid" style="margin-bottom: 0;">
                        <div class="form-group">
                            <label>Filter by Type</label>
                            <select id="expenseFilterType" onchange="updateExpenseTable()">
                                <option value="">All Types</option>
                                <option value="Rent">Rent</option><option value="Electricity">Electricity</option>
                                <option value="Water">Water</option><option value="Internet">Internet</option>
                                <option value="Maintenance">Maintenance</option><option value="Supplies">Supplies</option>
                                <option value="Transportation">Transportation</option><option value="Marketing">Marketing</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group"><label>Filter by Month</label><input type="month" id="expenseFilterMonth" onchange="updateExpenseTable()"></div>
                        <div class="form-group" style="display: flex; align-items: flex-end;">
                            <button class="btn btn-primary" onclick="clearExpenseFilters()" style="width: 100%;">Clear Filters</button>
                        </div>
                    </div>
                </div>
                <div id="expenseSummary" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px; color: #667eea;">Expense Summary</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;"><p style="color: #666; font-size: 0.9em; margin-bottom: 5px;">Total Expenses</p><p style="font-size: 1.8em; font-weight: 700; color: #dc3545;" id="totalExpenses">‚Çπ0</p></div>
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;"><p style="color: #666; font-size: 0.9em; margin-bottom: 5px;">This Month</p><p style="font-size: 1.8em; font-weight: 700; color: #ffc107;" id="thisMonthExpenses">‚Çπ0</p></div>
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;"><p style="color: #666; font-size: 0.9em; margin-bottom: 5px;">Count</p><p style="font-size: 1.8em; font-weight: 700; color: #667eea;" id="expenseCount">0</p></div>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                    <input type="text" class="search-box" placeholder="Search expenses..." id="expenseSearch" style="margin-bottom: 0; max-width: 400px;">
                    <button class="btn btn-success" onclick="exportExpensesToExcel()" style="padding: 10px 20px;">üì• Export to Excel</button>
                </div>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Date</th><th>Type</th><th>Description</th><th>Amount</th><th>For Month</th><th>Paid To</th><th>Method</th><th>Notes</th><th id="expenseActionsHeader">Actions</th></tr></thead>
                        <tbody id="expenseTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Accounts Tab -->
            <div id="accounts" class="tab-content">
                <h2 style="margin-bottom: 5px;">üìí Accounts Overview</h2>
                <p style="color: #666; margin-bottom: 25px;">Monthly income vs expenses breakdown</p>
                <div class="accounts-month-selector">
                    <label>üìÖ Select Month:</label>
                    <input type="month" id="accountsMonth">
                    <button class="btn btn-primary" onclick="generateAccountsSummary()">View Summary</button>
                    <button class="btn btn-success" onclick="exportAccountsToExcel()" id="exportAccountsBtn" style="display:none;">üì• Export to Excel</button>
                </div>
                <div id="netResultBanner" style="display:none;"></div>
                <div class="accounts-summary-grid" id="accountsSummaryGrid" style="display:none;">
                    <div class="accounts-card income"><div class="accounts-card-icon">üí∞</div><div class="accounts-card-label">Total Fees Collected</div><div class="accounts-card-value" id="accTotalFees">‚Çπ0</div></div>
                    <div class="accounts-card salary-card"><div class="accounts-card-icon">üë®‚Äçüè´</div><div class="accounts-card-label">Salary Paid</div><div class="accounts-card-value" id="accTotalSalary">‚Çπ0</div></div>
                    <div class="accounts-card expense-card"><div class="accounts-card-icon">üè¢</div><div class="accounts-card-label">Other Expenses</div><div class="accounts-card-value" id="accTotalExpenses">‚Çπ0</div></div>
                    <div class="accounts-card expense-card"><div class="accounts-card-icon">üìä</div><div class="accounts-card-label">Total Expenditure</div><div class="accounts-card-value" id="accTotalExpenditure">‚Çπ0</div></div>
                </div>
                <div class="accounts-breakdown" id="accountsBreakdown" style="display:none;">
                    <div class="accounts-breakdown-card">
                        <div class="accounts-breakdown-header green">üí∞ Fee Collections</div>
                        <div class="accounts-breakdown-body" id="feeBreakdownBody"></div>
                        <div class="accounts-breakdown-total"><span>Total Collected</span><span id="feeBreakdownTotal" style="color:#28a745;">‚Çπ0</span></div>
                    </div>
                    <div class="accounts-breakdown-card">
                        <div class="accounts-breakdown-header red">üè¢ Expenses</div>
                        <div class="accounts-breakdown-body" id="expenseBreakdownBody"></div>
                        <div class="accounts-breakdown-total"><span>Total Expenses</span><span id="expenseBreakdownTotal" style="color:#dc3545;">‚Çπ0</span></div>
                    </div>
                    <div class="accounts-breakdown-card">
                        <div class="accounts-breakdown-header orange">üë®‚Äçüè´ Salary Payments</div>
                        <div class="accounts-breakdown-body" id="salaryBreakdownBody"></div>
                        <div class="accounts-breakdown-total"><span>Total Salary</span><span id="salaryBreakdownTotal" style="color:#fd7e14;">‚Çπ0</span></div>
                    </div>
                    <div class="accounts-breakdown-card">
                        <div class="accounts-breakdown-header red">üìÇ Expense by Category</div>
                        <div class="accounts-breakdown-body" id="categoryBreakdownBody"></div>
                        <div class="accounts-breakdown-total"><span>Total</span><span id="categoryBreakdownTotal" style="color:#dc3545;">‚Çπ0</span></div>
                    </div>
                </div>
                <div id="monthlyHistorySection" style="display:none;">
                    <h3 style="color:#667eea; margin-bottom:15px;">üìÖ Month-wise History (All Months)</h3>
                    <div class="table-container">
                        <table class="monthly-history-table">
                            <thead><tr><th>Month</th><th>Fees Collected</th><th>Salary Paid</th><th>Other Expenses</th><th>Total Expenditure</th><th>Net Profit / Loss</th></tr></thead>
                            <tbody id="monthlyHistoryBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ============================================================ -->
            <!-- INQUIRY FORM TAB -->
            <!-- ============================================================ -->
            <div id="inquiries" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 25px; flex-wrap: wrap; gap: 15px;">
                    <div>
                        <h2 style="margin-bottom: 5px;">üîç Inquiry Management</h2>
                        <p style="color: #666;">Track potential students and convert them when they're ready to join</p>
                    </div>
                    <button class="btn btn-success" onclick="exportInquiriesToExcel()" style="padding: 10px 20px;">üì• Export to Excel</button>
                </div>

                <!-- Inquiry Stats -->
                <div class="inquiry-stats" id="inquiryStats">
                    <div class="inquiry-stat"><h3 id="inqTotal">0</h3><p>Total Inquiries</p></div>
                    <div class="inquiry-stat new-color"><h3 id="inqNew">0</h3><p>New</p></div>
                    <div class="inquiry-stat followup-color"><h3 id="inqFollowup">0</h3><p>Follow Up</p></div>
                    <div class="inquiry-stat interested-color"><h3 id="inqInterested">0</h3><p>Interested</p></div>
                    <div class="inquiry-stat notinterested-color"><h3 id="inqNotInterested">0</h3><p>Not Interested</p></div>
                    <div class="inquiry-stat converted-color"><h3 id="inqConverted">0</h3><p>Converted</p></div>
                </div>

                <!-- Add Inquiry Form -->
                <div id="inquiryFormSection" style="background: #f8f9fa; padding: 25px; border-radius: 12px; margin-bottom: 30px;">
                    <h3 style="margin-bottom: 20px; color: #667eea;">‚ûï Add New Inquiry</h3>
                    <form id="inquiryForm">
                        <div class="form-grid">
                            <div class="form-group"><label>Student/Parent Name *</label><input type="text" id="inqName" required placeholder="Full name"></div>
                            <div class="form-group"><label>Phone Number *</label><input type="tel" id="inqPhone" required placeholder="Contact number"></div>
                            <div class="form-group"><label>Alternate Phone</label><input type="tel" id="inqAltPhone" placeholder="Alternate number (optional)"></div>
                            <div class="form-group">
                                <label>Interested Class *</label>
                                <select id="inqClass" required>
                                    <option value="">Select Class</option>
                                    <option>Class 1</option><option>Class 2</option><option>Class 3</option><option>Class 4</option>
                                    <option>Class 5</option><option>Class 6</option><option>Class 7</option><option>Class 8</option>
                                    <option>Class 9</option><option>Class 10</option><option>Class 11</option><option>Class 12</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Syllabus Preference</label>
                                <select id="inqSyllabus">
                                    <option value="">Not Sure</option>
                                    <option value="CBSE">CBSE</option>
                                    <option value="Matric">Matric</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Source</label>
                                <select id="inqSource">
                                    <option value="">Select Source</option>
                                    <option value="Walk-in">Walk-in</option>
                                    <option value="Phone Call">Phone Call</option>
                                    <option value="WhatsApp">WhatsApp</option>
                                    <option value="Referral">Referral</option>
                                    <option value="Social Media">Social Media</option>
                                    <option value="Advertisement">Advertisement</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group"><label>Inquiry Date *</label><input type="date" id="inqDate" required></div>
                            <div class="form-group">
                                <label>Status *</label>
                                <select id="inqStatus" required>
                                    <option value="New">New</option>
                                    <option value="Follow Up">Follow Up</option>
                                    <option value="Interested">Interested</option>
                                    <option value="Not Interested">Not Interested</option>
                                </select>
                            </div>
                            <div class="form-group"><label>Follow Up Date</label><input type="date" id="inqFollowUpDate"></div>
                            <div class="form-group"><label>Expected Fee (‚Çπ)</label><input type="number" id="inqExpectedFee" placeholder="Expected monthly fee"></div>
                        </div>
                        <div class="form-group" style="margin-bottom: 20px;">
                            <label>Notes / Remarks</label>
                            <input type="text" id="inqNotes" placeholder="Any additional notes about this inquiry">
                        </div>
                        <button type="submit" class="btn btn-primary" id="inqSubmitBtn">Add Inquiry</button>
                    </form>
                </div>

                <!-- Inquiry Filters -->
                <div style="background: #f8f9fa; padding: 15px 20px; border-radius: 10px; margin-bottom: 20px;">
                    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <input type="text" class="search-box" placeholder="Search by name or phone..." id="inquirySearch" style="margin-bottom: 0; max-width: 280px; flex: 1;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-weight: 600; color: #333; white-space: nowrap;">Status:</label>
                            <select id="inquiryStatusFilter" onchange="updateInquiryTable()" style="padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95em;">
                                <option value="">All Statuses</option>
                                <option value="New">New</option>
                                <option value="Follow Up">Follow Up</option>
                                <option value="Interested">Interested</option>
                                <option value="Not Interested">Not Interested</option>
                                <option value="Converted">Converted</option>
                            </select>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-weight: 600; color: #333; white-space: nowrap;">Class:</label>
                            <select id="inquiryClassFilter" onchange="updateInquiryTable()" style="padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95em;">
                                <option value="">All Classes</option>
                                <option>Class 1</option><option>Class 2</option><option>Class 3</option><option>Class 4</option>
                                <option>Class 5</option><option>Class 6</option><option>Class 7</option><option>Class 8</option>
                                <option>Class 9</option><option>Class 10</option><option>Class 11</option><option>Class 12</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="clearInquiryFilters()" style="padding: 10px 18px;">Clear Filters</button>
                    </div>
                </div>

                <!-- Inquiry Table -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Name</th>
                                <th>Phone</th>
                                <th>Class</th>
                                <th>Syllabus</th>
                                <th>Source</th>
                                <th>Expected Fee</th>
                                <th>Status</th>
                                <th>Follow Up</th>
                                <th>Notes</th>
                                <th id="inquiryActionsHeader">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inquiryTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reports" class="tab-content">
                <h2 style="margin-bottom: 20px;">Fee Status Report</h2>
                <div class="form-grid" style="margin-bottom: 20px;">
                    <div class="form-group"><label>Select Month</label><input type="month" id="reportMonth"></div>
                    <div class="form-group">
                        <label>Filter by Class</label>
                        <select id="reportCourse">
                            <option value="">All Classes</option>
                            <option>Class 1</option><option>Class 2</option><option>Class 3</option><option>Class 4</option>
                            <option>Class 5</option><option>Class 6</option><option>Class 7</option><option>Class 8</option>
                            <option>Class 9</option><option>Class 10</option><option>Class 11</option><option>Class 12</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Filter by Syllabus</label>
                        <select id="reportSyllabus">
                            <option value="">All Syllabus</option><option value="CBSE">CBSE</option><option value="Matric">Matric</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Filter by Fee Status</label>
                        <select id="reportFeeStatus">
                            <option value="">All Students</option><option value="paid">Paid Only</option><option value="pending">Pending Only</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="generateReport()">Generate Report</button>
                <div id="reportSummary" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 20px;">
                    <h3 style="margin-bottom: 15px; color: #667eea;">Report Summary</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;"><p style="color: #666; font-size: 0.9em; margin-bottom: 5px;">Total Students</p><p style="font-size: 1.8em; font-weight: 700; color: #667eea;" id="reportTotalStudents">0</p></div>
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;"><p style="color: #666; font-size: 0.9em; margin-bottom: 5px;">Paid</p><p style="font-size: 1.8em; font-weight: 700; color: #28a745;" id="reportPaidCount">0</p></div>
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;"><p style="color: #666; font-size: 0.9em; margin-bottom: 5px;">Pending</p><p style="font-size: 1.8em; font-weight: 700; color: #ffc107;" id="reportPendingCount">0</p></div>
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;"><p style="color: #666; font-size: 0.9em; margin-bottom: 5px;">Total Amount</p><p style="font-size: 1.8em; font-weight: 700; color: #667eea;" id="reportTotalAmount">‚Çπ0</p></div>
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;"><p style="color: #666; font-size: 0.9em; margin-bottom: 5px;">Collected</p><p style="font-size: 1.8em; font-weight: 700; color: #28a745;" id="reportCollectedAmount">‚Çπ0</p></div>
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;"><p style="color: #666; font-size: 0.9em; margin-bottom: 5px;">Pending Amount</p><p style="font-size: 1.8em; font-weight: 700; color: #dc3545;" id="reportPendingAmount">‚Çπ0</p></div>
                    </div>
                </div>
                <div class="table-container" style="margin-top: 20px;">
                    <table>
                        <thead><tr><th>Roll No.</th><th>Student Name</th><th>Class</th><th>Syllabus</th><th>Monthly Fee</th><th>Status</th><th>Last Payment</th></tr></thead>
                        <tbody id="reportTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Receipt Modal -->
<div id="receiptModal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><h2>Fee Receipt</h2><button class="close-btn" onclick="closeReceipt()">&times;</button></div>
        <div id="receiptContent"></div>
        <button class="btn btn-primary" onclick="window.print()" style="margin-top: 20px; width: 100%;">Print Receipt</button>
    </div>
</div>

<!-- Convert Inquiry to Student Modal -->
<div id="convertModal" class="modal">
    <div class="modal-content convert-modal-content">
        <div class="modal-header">
            <h2>üéì Convert Inquiry to Student</h2>
            <button class="close-btn" onclick="closeConvertModal()">&times;</button>
        </div>
        <div class="convert-notice">
            ‚úÖ Great news! This inquiry is being converted to a student. Please fill in the remaining details below.
        </div>
        <div id="convertInquiryInfo" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9em;"></div>
        <form id="convertForm">
            <div class="form-grid">
                <div class="form-group"><label>Student Name *</label><input type="text" id="convName" required></div>
                <div class="form-group"><label>Roll Number *</label><input type="text" id="convRollNumber" required placeholder="Assign a roll number"></div>
                <div class="form-group">
                    <label>Class *</label>
                    <select id="convClass" required>
                        <option value="">Select Class</option>
                        <option>Class 1</option><option>Class 2</option><option>Class 3</option><option>Class 4</option>
                        <option>Class 5</option><option>Class 6</option><option>Class 7</option><option>Class 8</option>
                        <option>Class 9</option><option>Class 10</option><option>Class 11</option><option>Class 12</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Syllabus</label>
                    <select id="convSyllabus">
                        <option value="">Select Syllabus</option>
                        <option value="CBSE">CBSE</option>
                        <option value="Matric">Matric</option>
                    </select>
                </div>
                <div class="form-group"><label>Phone Number *</label><input type="tel" id="convPhone" required></div>
                <div class="form-group"><label>Monthly Fee (‚Çπ) *</label><input type="number" id="convFee" required></div>
                <div class="form-group"><label>Admission Date</label><input type="date" id="convAdmissionDate"></div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="convStatus">
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                    </select>
                </div>
            </div>
            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <button type="submit" class="btn btn-success">‚úÖ Convert to Student</button>
                <button type="button" class="btn btn-danger" onclick="closeConvertModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy, onSnapshot, getDoc, setDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import * as XLSX from 'https://cdn.sheetjs.com/xlsx-0.20.1/package/xlsx.mjs';

    const firebaseConfig = {
        apiKey: "AIzaSyBDwn-JoS8oItPiQjETsJ9pqlDgRTrsASQ",
        authDomain: "fee-collection-57e8b.firebaseapp.com",
        projectId: "fee-collection-57e8b",
        storageBucket: "fee-collection-57e8b.firebasestorage.app",
        messagingSenderId: "1009610270668",
        appId: "1:1009610270668:web:c7890359d8c35e325f9f69"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    window.students = [];
    window.payments = [];
    window.reminders = [];
    window.teachers = [];
    window.salaries = [];
    window.expenses = [];
    window.inquiries = [];

    let studentsListener = null;
    let paymentsListener = null;
    let remindersListener = null;
    let teachersListener = null;
    let salariesListener = null;
    let expensesListener = null;
    let inquiriesListener = null;
    let currentUser = null;
    let userRole = null;
    let editingStudentId = null;
    let editingExpenseId = null;
    let editingInquiryId = null;
    let convertingInquiryId = null;
    let filteredPaidStudents = [];
    let currentAccountsData = null;

    window.showPage = function(pageId) {
        ['loginPage','signupPage','resetPage','mainApp'].forEach(id => {
            document.getElementById(id).style.display = 'none';
        });
        document.getElementById(pageId).style.display = 'block';
        document.querySelectorAll('.error-message, .success-message').forEach(el => el.classList.remove('show'));
    };

    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        const btn = document.getElementById('loginBtn');
        const errorDiv = document.getElementById('loginError');
        btn.disabled = true; btn.textContent = 'Logging in...';
        errorDiv.classList.remove('show');
        try {
            await signInWithEmailAndPassword(auth, email, password);
        } catch (error) {
            errorDiv.textContent = '‚ùå ' + getErrorMessage(error.code);
            errorDiv.classList.add('show');
            btn.disabled = false; btn.textContent = 'Login';
        }
    });

    document.getElementById('signupForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('signupName').value;
        const email = document.getElementById('signupEmail').value;
        const password = document.getElementById('signupPassword').value;
        const role = document.getElementById('signupRole').value;
        const btn = document.getElementById('signupBtn');
        const errorDiv = document.getElementById('signupError');
        const successDiv = document.getElementById('signupSuccess');
        btn.disabled = true; btn.textContent = 'Creating Account...';
        errorDiv.classList.remove('show'); successDiv.classList.remove('show');
        try {
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            await setDoc(doc(db, 'users', userCredential.user.uid), { email, name, role, createdAt: new Date().toISOString() });
            successDiv.textContent = '‚úÖ Account created! Redirecting...';
            successDiv.classList.add('show');
            setTimeout(() => { showPage('loginPage'); document.getElementById('loginEmail').value = email; }, 2000);
        } catch (error) {
            errorDiv.textContent = '‚ùå ' + getErrorMessage(error.code);
            errorDiv.classList.add('show');
            btn.disabled = false; btn.textContent = 'Create Account';
        }
    });

    document.getElementById('resetForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('resetEmail').value;
        const btn = document.getElementById('resetBtn');
        btn.disabled = true; btn.textContent = 'Sending...';
        const errorDiv = document.getElementById('resetError');
        const successDiv = document.getElementById('resetSuccess');
        errorDiv.classList.remove('show'); successDiv.classList.remove('show');
        try {
            await sendPasswordResetEmail(auth, email);
            successDiv.textContent = '‚úÖ Password reset email sent!';
            successDiv.classList.add('show');
            document.getElementById('resetEmail').value = '';
        } catch (error) {
            errorDiv.textContent = '‚ùå ' + getErrorMessage(error.code);
            errorDiv.classList.add('show');
        } finally {
            btn.disabled = false; btn.textContent = 'Send Reset Link';
        }
    });

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            const userDoc = await getDoc(doc(db, 'users', user.uid));
            if (userDoc.exists()) {
                const userData = userDoc.data();
                userRole = userData.role;
                document.getElementById('userName').textContent = userData.name;
                document.getElementById('userEmail').textContent = user.email;
                document.getElementById('userRole').textContent = userRole.toUpperCase();
                applyRoleBasedUI(userRole);
                showPage('mainApp');
                loadData();
            } else {
                alert('User profile not found.'); signOut(auth);
            }
        } else {
            showPage('loginPage');
        }
    });

    window.logout = async function() {
        if (confirm('Are you sure you want to logout?')) {
            try {
                if (studentsListener) studentsListener();
                if (paymentsListener) paymentsListener();
                if (remindersListener) remindersListener();
                if (teachersListener) teachersListener();
                if (salariesListener) salariesListener();
                if (expensesListener) expensesListener();
                if (inquiriesListener) inquiriesListener();
                await signOut(auth);
            } catch (error) { alert('Error logging out: ' + error.message); }
        }
    };

    function applyRoleBasedUI(role) {
        const isStaff = role === 'staff';
        document.getElementById('staffNotice').style.display = isStaff ? 'block' : 'none';
        document.getElementById('studentFormSection').style.display = isStaff ? 'none' : 'block';
        document.getElementById('feeFormSection').style.display = isStaff ? 'none' : 'block';
        document.getElementById('actionsHeader').style.display = isStaff ? 'none' : 'table-cell';
        document.getElementById('paymentActionsHeader').style.display = isStaff ? 'none' : 'table-cell';
        document.getElementById('teacherFormSection').style.display = isStaff ? 'none' : 'block';
        document.getElementById('salaryFormSection').style.display = isStaff ? 'none' : 'block';
        document.getElementById('teacherActionsHeader').style.display = isStaff ? 'none' : 'table-cell';
        document.getElementById('salaryActionsHeader').style.display = isStaff ? 'none' : 'table-cell';
        document.getElementById('expenseFormSection').style.display = isStaff ? 'none' : 'block';
        document.getElementById('expenseActionsHeader').style.display = isStaff ? 'none' : 'table-cell';
        document.getElementById('inquiryFormSection').style.display = isStaff ? 'none' : 'block';
        document.getElementById('inquiryActionsHeader').style.display = isStaff ? 'none' : 'table-cell';
    }

    async function loadData() {
        try {
            studentsListener = onSnapshot(query(collection(db, 'students'), orderBy('rollNumber')), (snapshot) => {
                window.students = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                updateStudentTable(); updateFeeStudentSelect(); updateStats();
            });
            paymentsListener = onSnapshot(query(collection(db, 'payments'), orderBy('date', 'desc')), (snapshot) => {
                window.payments = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                updatePaymentTable(); updateStats();
            });
            remindersListener = onSnapshot(query(collection(db, 'reminders'), orderBy('sentAt', 'desc')), (snapshot) => {
                window.reminders = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                updateStudentTable();
            });
            teachersListener = onSnapshot(query(collection(db, 'teachers'), orderBy('employeeId')), (snapshot) => {
                window.teachers = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                updateTeacherTable(); updateSalaryTeacherSelect();
            });
            salariesListener = onSnapshot(query(collection(db, 'salaries'), orderBy('date', 'desc')), (snapshot) => {
                window.salaries = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                updateSalaryTable();
            });
            expensesListener = onSnapshot(query(collection(db, 'expenses'), orderBy('date', 'desc')), (snapshot) => {
                window.expenses = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                updateExpenseTable(); updateExpenseSummary();
            });
            inquiriesListener = onSnapshot(query(collection(db, 'inquiries'), orderBy('createdAt', 'desc')), (snapshot) => {
                window.inquiries = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                updateInquiryTable(); updateInquiryStats();
            });

            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        } catch (error) {
            console.error('Error loading data:', error);
            alert('Error loading data: ' + error.message);
        }
    }

    // Set default dates
    document.getElementById('feeMonth').value = new Date().toISOString().slice(0,7);
    document.getElementById('reportMonth').value = new Date().toISOString().slice(0,7);
    document.getElementById('paidReportMonth').value = new Date().toISOString().slice(0,7);
    document.getElementById('salaryMonth').value = new Date().toISOString().slice(0,7);
    document.getElementById('expenseDate').value = new Date().toISOString().slice(0,10);
    document.getElementById('accountsMonth').value = new Date().toISOString().slice(0,7);
    document.getElementById('inqDate').value = new Date().toISOString().slice(0,10);

    // ============================================================
    // INQUIRY FUNCTIONS
    // ============================================================

    document.getElementById('inquiryForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        if (userRole === 'staff') { alert('You do not have permission to add inquiries.'); return; }

        const submitBtn = document.getElementById('inqSubmitBtn');
        const isEditing = editingInquiryId !== null;
        submitBtn.disabled = true;
        submitBtn.textContent = isEditing ? 'Updating...' : 'Adding...';

        try {
            const inquiryData = {
                name: document.getElementById('inqName').value.trim(),
                phone: document.getElementById('inqPhone').value.trim(),
                altPhone: document.getElementById('inqAltPhone').value.trim() || '-',
                interestedClass: document.getElementById('inqClass').value,
                syllabus: document.getElementById('inqSyllabus').value || '-',
                source: document.getElementById('inqSource').value || '-',
                date: document.getElementById('inqDate').value,
                status: document.getElementById('inqStatus').value,
                followUpDate: document.getElementById('inqFollowUpDate').value || '-',
                expectedFee: parseFloat(document.getElementById('inqExpectedFee').value) || 0,
                notes: document.getElementById('inqNotes').value.trim() || '-'
            };

            if (isEditing) {
                await updateDoc(doc(db, 'inquiries', editingInquiryId), { ...inquiryData, updatedAt: new Date().toISOString() });
                alert('‚úÖ Inquiry updated successfully!');
                cancelInquiryEdit();
            } else {
                await addDoc(collection(db, 'inquiries'), { ...inquiryData, createdAt: new Date().toISOString() });
                alert('‚úÖ Inquiry added successfully!');
            }
            this.reset();
            document.getElementById('inqDate').value = new Date().toISOString().slice(0,10);
        } catch (error) {
            alert('Error saving inquiry: ' + error.message);
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = isEditing ? 'Update Inquiry' : 'Add Inquiry';
        }
    });

    window.updateInquiryTable = function() {
        const tbody = document.getElementById('inquiryTableBody');
        const searchTerm = document.getElementById('inquirySearch')?.value.toLowerCase() || '';
        const statusFilter = document.getElementById('inquiryStatusFilter')?.value || '';
        const classFilter = document.getElementById('inquiryClassFilter')?.value || '';

        let filtered = window.inquiries.filter(inq => {
            const matchSearch = inq.name.toLowerCase().includes(searchTerm) || inq.phone.includes(searchTerm);
            const matchStatus = !statusFilter || inq.status === statusFilter;
            const matchClass = !classFilter || inq.interestedClass === classFilter;
            return matchSearch && matchStatus && matchClass;
        });

        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 30px; color: #999;">No inquiries found. Add your first inquiry above!</td></tr>';
            return;
        }

        tbody.innerHTML = filtered.map(inq => {
            const statusBadgeClass = {
                'New': 'badge-new',
                'Follow Up': 'badge-followup',
                'Interested': 'badge-interested',
                'Not Interested': 'badge-notinterested',
                'Converted': 'badge-converted'
            }[inq.status] || 'badge-pending';

            const isConverted = inq.status === 'Converted';

            const actionsCell = userRole === 'staff' ? '' : `
                <td>
                    <div class="action-buttons">
                        ${!isConverted ? `<button class="btn btn-success" onclick="openConvertModal('${inq.id}')" style="padding: 5px 10px; font-size: 0.85em;">üéì Convert</button>` : `<span style="color:#0c5460; font-size:0.85em; font-weight:600;">‚úÖ Converted</span>`}
                        <button class="btn btn-whatsapp" onclick="sendInquiryWhatsApp('${inq.phone}', '${inq.name.replace(/'/g,"\\'")}', '${inq.interestedClass}')" style="padding: 5px 10px; font-size: 0.85em;">üì±</button>
                        ${!isConverted ? `<button class="btn btn-warning" onclick="editInquiry('${inq.id}')" style="padding: 5px 10px; font-size: 0.85em;">Edit</button>` : ''}
                        <button class="btn btn-danger" onclick="deleteInquiry('${inq.id}')" style="padding: 5px 10px; font-size: 0.85em;">Delete</button>
                    </div>
                </td>
            `;

            return `
                <tr style="${isConverted ? 'background: #f0fff4;' : ''}">
                    <td>${inq.date}</td>
                    <td><strong>${inq.name}</strong></td>
                    <td>${inq.phone}${inq.altPhone !== '-' ? '<br><small style="color:#999;">' + inq.altPhone + '</small>' : ''}</td>
                    <td>${inq.interestedClass}</td>
                    <td>${inq.syllabus}</td>
                    <td>${inq.source}</td>
                    <td>${inq.expectedFee > 0 ? '‚Çπ' + inq.expectedFee.toLocaleString() : '-'}</td>
                    <td><span class="badge ${statusBadgeClass}">${inq.status}</span></td>
                    <td style="font-size:0.9em; color:${inq.followUpDate !== '-' ? '#856404' : '#999'};">${inq.followUpDate !== '-' ? 'üìÖ ' + inq.followUpDate : '-'}</td>
                    <td style="font-size:0.85em; color:#666; max-width:150px; word-break:break-word;">${inq.notes}</td>
                    ${actionsCell}
                </tr>
            `;
        }).join('');
    };

    window.updateInquiryStats = function() {
        const total = window.inquiries.length;
        const newCount = window.inquiries.filter(i => i.status === 'New').length;
        const followup = window.inquiries.filter(i => i.status === 'Follow Up').length;
        const interested = window.inquiries.filter(i => i.status === 'Interested').length;
        const notInterested = window.inquiries.filter(i => i.status === 'Not Interested').length;
        const converted = window.inquiries.filter(i => i.status === 'Converted').length;
        document.getElementById('inqTotal').textContent = total;
        document.getElementById('inqNew').textContent = newCount;
        document.getElementById('inqFollowup').textContent = followup;
        document.getElementById('inqInterested').textContent = interested;
        document.getElementById('inqNotInterested').textContent = notInterested;
        document.getElementById('inqConverted').textContent = converted;
    };

    window.editInquiry = function(id) {
        if (userRole === 'staff') { alert('You do not have permission to edit inquiries.'); return; }
        const inq = window.inquiries.find(i => i.id === id);
        if (!inq) return;
        editingInquiryId = id;
        document.getElementById('inqName').value = inq.name;
        document.getElementById('inqPhone').value = inq.phone;
        document.getElementById('inqAltPhone').value = inq.altPhone === '-' ? '' : inq.altPhone;
        document.getElementById('inqClass').value = inq.interestedClass;
        document.getElementById('inqSyllabus').value = inq.syllabus === '-' ? '' : inq.syllabus;
        document.getElementById('inqSource').value = inq.source === '-' ? '' : inq.source;
        document.getElementById('inqDate').value = inq.date;
        document.getElementById('inqStatus').value = inq.status;
        document.getElementById('inqFollowUpDate').value = inq.followUpDate === '-' ? '' : inq.followUpDate;
        document.getElementById('inqExpectedFee').value = inq.expectedFee || '';
        document.getElementById('inqNotes').value = inq.notes === '-' ? '' : inq.notes;

        const submitBtn = document.getElementById('inqSubmitBtn');
        submitBtn.textContent = 'Update Inquiry';
        submitBtn.classList.add('btn-warning');
        submitBtn.classList.remove('btn-primary');

        if (!document.getElementById('cancelInquiryEditBtn')) {
            const cancelBtn = document.createElement('button');
            cancelBtn.type = 'button'; cancelBtn.id = 'cancelInquiryEditBtn';
            cancelBtn.className = 'btn btn-danger'; cancelBtn.textContent = 'Cancel Edit';
            cancelBtn.onclick = cancelInquiryEdit; cancelBtn.style.marginLeft = '10px';
            submitBtn.parentNode.appendChild(cancelBtn);
        }
        document.getElementById('inquiryFormSection').scrollIntoView({ behavior: 'smooth' });
    };

    function cancelInquiryEdit() {
        editingInquiryId = null;
        document.getElementById('inquiryForm').reset();
        document.getElementById('inqDate').value = new Date().toISOString().slice(0,10);
        const submitBtn = document.getElementById('inqSubmitBtn');
        submitBtn.textContent = 'Add Inquiry';
        submitBtn.classList.remove('btn-warning');
        submitBtn.classList.add('btn-primary');
        const cancelBtn = document.getElementById('cancelInquiryEditBtn');
        if (cancelBtn) cancelBtn.remove();
    }

    window.deleteInquiry = async function(id) {
        if (userRole === 'staff') { alert('You do not have permission to delete inquiries.'); return; }
        if (!confirm('Are you sure you want to delete this inquiry?')) return;
        try {
            await deleteDoc(doc(db, 'inquiries', id));
            alert('Inquiry deleted successfully!');
        } catch (error) { alert('Error deleting inquiry: ' + error.message); }
    };

    window.clearInquiryFilters = function() {
        document.getElementById('inquirySearch').value = '';
        document.getElementById('inquiryStatusFilter').value = '';
        document.getElementById('inquiryClassFilter').value = '';
        updateInquiryTable();
    };

    // ---- Convert Inquiry to Student ----

    window.openConvertModal = function(inquiryId) {
        if (userRole === 'staff') { alert('You do not have permission to convert inquiries.'); return; }
        const inq = window.inquiries.find(i => i.id === inquiryId);
        if (!inq) return;
        convertingInquiryId = inquiryId;

        // Pre-fill modal with inquiry data
        document.getElementById('convName').value = inq.name;
        document.getElementById('convPhone').value = inq.phone;
        document.getElementById('convClass').value = inq.interestedClass;
        document.getElementById('convSyllabus').value = inq.syllabus === '-' ? '' : inq.syllabus;
        document.getElementById('convFee').value = inq.expectedFee > 0 ? inq.expectedFee : '';
        document.getElementById('convAdmissionDate').value = new Date().toISOString().slice(0,10);
        document.getElementById('convRollNumber').value = '';

        // Show inquiry info
        document.getElementById('convertInquiryInfo').innerHTML = `
            <strong>Inquiry Details:</strong><br>
            üìã Name: ${inq.name} &nbsp;|&nbsp; üìû Phone: ${inq.phone}<br>
            üè´ Class: ${inq.interestedClass} &nbsp;|&nbsp; üìÖ Inquiry Date: ${inq.date}<br>
            üìù Notes: ${inq.notes}
        `;

        document.getElementById('convertModal').classList.add('active');
    };

    window.closeConvertModal = function() {
        document.getElementById('convertModal').classList.remove('active');
        convertingInquiryId = null;
        document.getElementById('convertForm').reset();
    };

    document.getElementById('convertForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const submitBtn = e.target.querySelector('button[type="submit"]');
        submitBtn.disabled = true; submitBtn.textContent = 'Converting...';

        try {
            const studentData = {
                name: document.getElementById('convName').value.trim(),
                rollNumber: document.getElementById('convRollNumber').value.trim(),
                course: document.getElementById('convClass').value,
                syllabus: document.getElementById('convSyllabus').value || '-',
                phone: document.getElementById('convPhone').value.trim(),
                monthlyFee: parseFloat(document.getElementById('convFee').value),
                admissionDate: document.getElementById('convAdmissionDate').value || '-',
                status: document.getElementById('convStatus').value,
                convertedFromInquiry: convertingInquiryId,
                createdAt: new Date().toISOString()
            };

            // Check duplicate roll number
            const duplicate = window.students.find(s => s.rollNumber === studentData.rollNumber);
            if (duplicate) {
                alert(`‚ùå Roll number "${studentData.rollNumber}" already exists. Please choose a different roll number.`);
                submitBtn.disabled = false; submitBtn.textContent = '‚úÖ Convert to Student';
                return;
            }

            // Add student
            await addDoc(collection(db, 'students'), studentData);

            // Update inquiry status to Converted
            await updateDoc(doc(db, 'inquiries', convertingInquiryId), {
                status: 'Converted',
                convertedAt: new Date().toISOString(),
                convertedStudentName: studentData.name,
                convertedRollNumber: studentData.rollNumber
            });

            alert(`üéâ Success!\n\n"${studentData.name}" has been converted to a student!\nRoll Number: ${studentData.rollNumber}\nClass: ${studentData.course}`);
            closeConvertModal();
        } catch (error) {
            alert('Error converting inquiry: ' + error.message);
            submitBtn.disabled = false; submitBtn.textContent = '‚úÖ Convert to Student';
        }
    });

    window.sendInquiryWhatsApp = function(phone, name, interestedClass) {
        let cleanPhone = phone.replace(/\D/g, '');
        if (cleanPhone.length === 10) cleanPhone = '91' + cleanPhone;

        const message = `Dear ${name},

Thank you for your inquiry at *Vismaya Education*! üéì

We are happy to inform you about our ${interestedClass} program. We offer quality education with experienced teachers.

üìç Please visit us or call to know more about:
‚Ä¢ Class timings
‚Ä¢ Fee structure
‚Ä¢ Admission process

We look forward to welcoming you!

*Vismaya Education Team*`;

        window.open(`https://wa.me/${cleanPhone}?text=${encodeURIComponent(message)}`, '_blank');
    };

    window.exportInquiriesToExcel = function() {
        if (window.inquiries.length === 0) { alert('No inquiries to export.'); return; }
        const data = window.inquiries.map((inq, i) => ({
            'S.No': i + 1,
            'Date': inq.date,
            'Name': inq.name,
            'Phone': inq.phone,
            'Alt Phone': inq.altPhone,
            'Class': inq.interestedClass,
            'Syllabus': inq.syllabus,
            'Source': inq.source,
            'Expected Fee': inq.expectedFee,
            'Status': inq.status,
            'Follow Up Date': inq.followUpDate,
            'Notes': inq.notes
        }));
        const ws = XLSX.utils.json_to_sheet(data);
        ws['!cols'] = [{ wch: 5 },{ wch: 12 },{ wch: 25 },{ wch: 15 },{ wch: 15 },{ wch: 12 },{ wch: 10 },{ wch: 15 },{ wch: 14 },{ wch: 15 },{ wch: 15 },{ wch: 30 }];
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Inquiries');
        XLSX.writeFile(wb, `Inquiries_${new Date().toISOString().slice(0,10)}.xlsx`);
    };

    document.getElementById('inquirySearch').addEventListener('input', updateInquiryTable);

    // ============================================================
    // STUDENT FUNCTIONS (original)
    // ============================================================

    document.getElementById('studentForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        if (userRole === 'staff') { alert('You do not have permission to add students.'); return; }
        const submitBtn = e.target.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        const isEditing = editingStudentId !== null;
        submitBtn.textContent = isEditing ? 'Updating...' : 'Adding...';
        try {
            const studentData = {
                name: document.getElementById('studentName').value,
                rollNumber: document.getElementById('rollNumber').value,
                course: document.getElementById('course').value,
                syllabus: document.getElementById('syllabus').value || '-',
                phone: document.getElementById('phoneNumber').value,
                monthlyFee: parseFloat(document.getElementById('monthlyFee').value),
                admissionDate: document.getElementById('admissionDate').value || '-',
                status: document.getElementById('studentStatus').value
            };
            if (isEditing) {
                await updateDoc(doc(db, 'students', editingStudentId), { ...studentData, updatedAt: new Date().toISOString() });
                alert('‚úÖ Student updated successfully!');
                cancelEdit();
            } else {
                await addDoc(collection(db, 'students'), { ...studentData, createdAt: new Date().toISOString() });
                alert('‚úÖ Student added successfully!');
            }
            this.reset();
        } catch (error) { alert('Error saving student: ' + error.message); }
        finally {
            submitBtn.disabled = false;
            submitBtn.textContent = isEditing ? 'Update Student' : 'Add Student';
        }
    });

    window.collectFee = async function() {
        if (userRole === 'staff') { alert('You do not have permission to collect fees.'); return; }
        const studentId = document.getElementById('feeStudent').value;
        const month = document.getElementById('feeMonth').value;
        const amount = parseFloat(document.getElementById('feeAmount').value);
        const method = document.getElementById('paymentMethod').value;
        if (!studentId || !month || !amount || !method) { alert('Please fill all fields'); return; }
        const alreadyPaid = window.payments.some(p => p.studentId === studentId && p.month === month);
        if (alreadyPaid) {
            const student = window.students.find(s => s.id === studentId);
            alert(`‚ùå Fee Already Collected!\nStudent: ${student?.name}\nMonth: ${month}`);
            return;
        }
        try {
            const payment = {
                receiptNo: 'REC' + Date.now().toString().slice(-6),
                studentId, month, amount, method,
                date: new Date().toISOString().slice(0,10),
                createdAt: new Date().toISOString()
            };
            const docRef = await addDoc(collection(db, 'payments'), payment);
            document.getElementById('feeStudent').value = '';
            document.getElementById('feeAmount').value = '';
            document.getElementById('paymentMethod').value = '';
            showReceipt({ id: docRef.id, ...payment });
        } catch (error) { alert('Error collecting fee: ' + error.message); }
    };

    window.deleteStudent = async function(id) {
        if (userRole === 'staff') { alert('You do not have permission to delete students.'); return; }
        if (!confirm('Are you sure you want to delete this student?')) return;
        try {
            await deleteDoc(doc(db, 'students', id));
            const sp = window.payments.filter(p => p.studentId === id);
            for (const payment of sp) await deleteDoc(doc(db, 'payments', payment.id));
            alert('Student deleted successfully!');
        } catch (error) { alert('Error deleting student: ' + error.message); }
    };

    window.deletePayment = async function(paymentId, studentName, month, amount) {
        if (userRole === 'staff') { alert('You do not have permission to delete payments.'); return; }
        if (!confirm(`‚ö†Ô∏è Delete payment?\nStudent: ${studentName}\nMonth: ${month}\nAmount: ‚Çπ${amount}`)) return;
        try {
            await deleteDoc(doc(db, 'payments', paymentId));
            alert('‚úÖ Payment deleted!');
        } catch (error) { alert('Error deleting payment: ' + error.message); }
    };

    window.editStudent = function(id) {
        if (userRole === 'staff') { alert('You do not have permission to edit students.'); return; }
        const student = window.students.find(s => s.id === id);
        if (student) {
            editingStudentId = id;
            document.getElementById('studentName').value = student.name;
            document.getElementById('rollNumber').value = student.rollNumber;
            document.getElementById('course').value = student.course;
            document.getElementById('syllabus').value = student.syllabus === '-' ? '' : student.syllabus;
            document.getElementById('phoneNumber').value = student.phone;
            document.getElementById('monthlyFee').value = student.monthlyFee;
            document.getElementById('admissionDate').value = student.admissionDate === '-' ? '' : student.admissionDate;
            document.getElementById('studentStatus').value = student.status;
            const submitBtn = document.querySelector('#studentForm button[type="submit"]');
            submitBtn.textContent = 'Update Student';
            submitBtn.classList.add('btn-warning');
            submitBtn.classList.remove('btn-primary');
            if (!document.getElementById('cancelEditBtn')) {
                const cancelBtn = document.createElement('button');
                cancelBtn.type = 'button'; cancelBtn.id = 'cancelEditBtn';
                cancelBtn.className = 'btn btn-danger'; cancelBtn.textContent = 'Cancel Edit';
                cancelBtn.onclick = cancelEdit; cancelBtn.style.marginLeft = '10px';
                submitBtn.parentNode.appendChild(cancelBtn);
            }
            window.scrollTo(0, 0);
        }
    };

    function cancelEdit() {
        editingStudentId = null;
        document.getElementById('studentForm').reset();
        const submitBtn = document.querySelector('#studentForm button[type="submit"]');
        submitBtn.textContent = 'Add Student';
        submitBtn.classList.remove('btn-warning');
        submitBtn.classList.add('btn-primary');
        const cancelBtn = document.getElementById('cancelEditBtn');
        if (cancelBtn) cancelBtn.remove();
    }

    window.updateStudentTable = function() {
        const tbody = document.getElementById('studentTableBody');
        const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
        const sortField = document.getElementById('sortField').value;
        const sortOrder = document.getElementById('sortOrder').value;
        let filteredStudents = window.students.filter(s =>
            s.name.toLowerCase().includes(searchTerm) || s.rollNumber.toLowerCase().includes(searchTerm)
        );
        filteredStudents.sort((a, b) => {
            let vA, vB;
            if (sortField === 'rollNumber') {
                vA = a.rollNumber.match(/\d+/) ? parseInt(a.rollNumber.match(/\d+/)[0]) : a.rollNumber;
                vB = b.rollNumber.match(/\d+/) ? parseInt(b.rollNumber.match(/\d+/)[0]) : b.rollNumber;
            } else if (sortField === 'monthlyFee') {
                vA = parseFloat(a[sortField]) || 0; vB = parseFloat(b[sortField]) || 0;
            } else {
                vA = (a[sortField] || '').toString().toLowerCase();
                vB = (b[sortField] || '').toString().toLowerCase();
            }
            if (vA < vB) return sortOrder === 'asc' ? -1 : 1;
            if (vA > vB) return sortOrder === 'asc' ? 1 : -1;
            return 0;
        });

        tbody.innerHTML = filteredStudents.map(student => {
            const currentMonth = new Date().toISOString().slice(0,7);
            const hasPaid = window.payments.some(p => p.studentId === student.id && p.month === currentMonth);
            const monthReminders = window.reminders.filter(r => r.studentId === student.id && r.month === currentMonth);
            const reminderCount = monthReminders.length;
            const lastReminder = monthReminders[0] || null;

            let reminderCell = '<td class="reminder-info">';
            if (reminderCount > 0) {
                reminderCell += `<span class="reminder-count">${reminderCount} sent</span>`;
                if (lastReminder) {
                    const d = new Date(lastReminder.sentAt);
                    reminderCell += `<span class="reminder-date">Last: ${d.toLocaleDateString('en-IN', { day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit' })}</span>`;
                }
            } else {
                reminderCell += '<span style="color: #999;">None</span>';
            }
            reminderCell += '</td>';

            const actionsCell = userRole === 'staff' ? '' : `<td><div class="action-buttons">
                <button class="btn btn-warning" onclick="editStudent('${student.id}')" style="padding: 5px 15px;">Edit</button>
                <button class="btn btn-danger" onclick="deleteStudent('${student.id}')" style="padding: 5px 15px;">Delete</button>
            </div></td>`;

            const whatsappCell = `<td><button class="btn btn-whatsapp" onclick="sendWhatsAppReminder('${student.id}','${student.phone}','${student.name.replace(/'/g,"\\'")}',${student.monthlyFee})" style="padding: 5px 15px;">üì± Remind</button></td>`;

            return `<tr>
                <td>${student.rollNumber}</td><td>${student.name}</td><td>${student.course}</td>
                <td>${student.syllabus}</td><td>${student.phone}</td><td>‚Çπ${student.monthlyFee}</td>
                <td><span class="badge ${student.status === 'Active' ? 'badge-active' : 'badge-inactive'}">${student.status}</span></td>
                <td><span class="badge ${hasPaid ? 'badge-paid' : 'badge-pending'}">${hasPaid ? 'Paid' : 'Pending'}</span></td>
                ${reminderCell}${actionsCell}${whatsappCell}
            </tr>`;
        }).join('');
    };

    window.updateFeeStudentSelect = function() {
        const select = document.getElementById('feeStudent');
        select.innerHTML = '<option value="">Choose student...</option>' +
            window.students.map(s => `<option value="${s.id}">${s.rollNumber} - ${s.name}</option>`).join('');
    };

    window.updatePaymentTable = function() {
        const tbody = document.getElementById('paymentTableBody');
        const sortField = document.getElementById('paymentSortField')?.value || 'date';
        const sortOrder = document.getElementById('paymentSortOrder')?.value || 'desc';
        let sorted = [...window.payments];
        sorted.sort((a, b) => {
            const sA = window.students.find(s => s.id === a.studentId);
            const sB = window.students.find(s => s.id === b.studentId);
            let vA, vB;
            if (sortField === 'date') { vA = new Date(a.date); vB = new Date(b.date); }
            else if (sortField === 'rollNumber') {
                const rA = sA?.rollNumber || ''; const rB = sB?.rollNumber || '';
                vA = rA.match(/\d+/) ? parseInt(rA.match(/\d+/)[0]) : rA;
                vB = rB.match(/\d+/) ? parseInt(rB.match(/\d+/)[0]) : rB;
            } else if (sortField === 'studentName') { vA = (sA?.name || '').toLowerCase(); vB = (sB?.name || '').toLowerCase(); }
            else if (sortField === 'amount') { vA = a.amount; vB = b.amount; }
            if (vA < vB) return sortOrder === 'asc' ? -1 : 1;
            if (vA > vB) return sortOrder === 'asc' ? 1 : -1;
            return 0;
        });
        tbody.innerHTML = sorted.slice(0,20).map(payment => {
            const student = window.students.find(s => s.id === payment.studentId);
            const actionsCell = userRole === 'staff' ? '' : `<td><div class="action-buttons">
                <button class="btn btn-primary" onclick='showReceipt(${JSON.stringify(payment).replace(/'/g,"&#39;")})' style="padding: 5px 15px;">View</button>
                <button class="btn btn-danger" onclick="deletePayment('${payment.id}','${student ? student.name : 'Unknown'}','${payment.month}',${payment.amount})" style="padding: 5px 15px;">Delete</button>
            </div></td>`;
            return `<tr>
                <td>${payment.receiptNo}</td><td>${payment.date}</td>
                <td>${student ? student.rollNumber : 'N/A'}</td><td>${student ? student.name : 'Unknown'}</td>
                <td>${payment.month}</td><td>‚Çπ${payment.amount}</td><td>${payment.method}</td>
                ${actionsCell}
            </tr>`;
        }).join('');
    };

    window.showReceipt = function(payment) {
        const student = window.students.find(s => s.id === payment.studentId);
        document.getElementById('receiptContent').innerHTML = `
            <div class="receipt">
                <div class="receipt-header"><h2>üìö Vismaya Education Dashboard</h2><p>Fee Receipt</p></div>
                <div class="receipt-details">
                    <div class="receipt-row"><strong>Receipt No:</strong><span>${payment.receiptNo}</span></div>
                    <div class="receipt-row"><strong>Date:</strong><span>${payment.date}</span></div>
                    <div class="receipt-row"><strong>Student Name:</strong><span>${student ? student.name : 'Unknown'}</span></div>
                    <div class="receipt-row"><strong>Roll Number:</strong><span>${student ? student.rollNumber : 'N/A'}</span></div>
                    <div class="receipt-row"><strong>Class:</strong><span>${student ? student.course : 'N/A'}</span></div>
                    <div class="receipt-row"><strong>Syllabus:</strong><span>${student ? student.syllabus : 'N/A'}</span></div>
                    <div class="receipt-row"><strong>Fee Month:</strong><span>${payment.month}</span></div>
                    <div class="receipt-row"><strong>Payment Method:</strong><span>${payment.method}</span></div>
                    <div class="receipt-row receipt-total"><strong>Amount Paid:</strong><span>‚Çπ${payment.amount}</span></div>
                </div>
                <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 2px dashed #667eea;">
                    <p style="font-size: 0.9em; color: #666;">Thank you for your payment!</p>
                    <p style="font-size: 0.8em; color: #999; margin-top: 10px;">Computer-generated receipt</p>
                </div>
            </div>`;
        document.getElementById('receiptModal').classList.add('active');
    };

    window.closeReceipt = function() { document.getElementById('receiptModal').classList.remove('active'); };

    window.updateStats = function() {
        const currentMonth = new Date().toISOString().slice(0,7);
        const total = window.students.length;
        document.getElementById('totalStudents').textContent = total;
        const paidSet = new Set(window.payments.filter(p => p.month === currentMonth).map(p => p.studentId));
        document.getElementById('paidStudents').textContent = paidSet.size;
        document.getElementById('pendingStudents').textContent = total - paidSet.size;
        const collected = window.payments.filter(p => p.month === currentMonth).reduce((sum, p) => sum + p.amount, 0);
        document.getElementById('totalCollected').textContent = '‚Çπ' + collected.toLocaleString();
        const pending = window.students.filter(s => !paidSet.has(s.id)).reduce((sum, s) => sum + s.monthlyFee, 0);
        document.getElementById('totalPending').textContent = '‚Çπ' + pending.toLocaleString();
        const expected = window.students.reduce((sum, s) => sum + s.monthlyFee, 0);
        document.getElementById('thisMonth').textContent = '‚Çπ' + expected.toLocaleString();
    };

    window.switchTab = function(tabName, clickedTab) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        if (clickedTab) clickedTab.classList.add('active');
        document.getElementById(tabName).classList.add('active');
    };

    window.generateReport = function() {
        const month = document.getElementById('reportMonth').value;
        const course = document.getElementById('reportCourse').value;
        const syllabus = document.getElementById('reportSyllabus').value;
        const feeStatus = document.getElementById('reportFeeStatus').value;
        let filtered = window.students;
        if (course) filtered = filtered.filter(s => s.course === course);
        if (syllabus) filtered = filtered.filter(s => s.syllabus === syllabus);
        const withStatus = filtered.map(s => ({ ...s, hasPaid: window.payments.some(p => p.studentId === s.id && p.month === month) }));
        let final = withStatus;
        if (feeStatus === 'paid') final = withStatus.filter(s => s.hasPaid);
        else if (feeStatus === 'pending') final = withStatus.filter(s => !s.hasPaid);
        const paid = final.filter(s => s.hasPaid);
        const pending = final.filter(s => !s.hasPaid);
        document.getElementById('reportTotalStudents').textContent = final.length;
        document.getElementById('reportPaidCount').textContent = paid.length;
        document.getElementById('reportPendingCount').textContent = pending.length;
        document.getElementById('reportTotalAmount').textContent = '‚Çπ' + final.reduce((sum, s) => sum + s.monthlyFee, 0).toLocaleString();
        document.getElementById('reportCollectedAmount').textContent = '‚Çπ' + paid.reduce((sum, s) => sum + s.monthlyFee, 0).toLocaleString();
        document.getElementById('reportPendingAmount').textContent = '‚Çπ' + pending.reduce((sum, s) => sum + s.monthlyFee, 0).toLocaleString();
        document.getElementById('reportSummary').style.display = 'block';
        const tbody = document.getElementById('reportTableBody');
        tbody.innerHTML = final.map(s => {
            const last = window.payments.filter(p => p.studentId === s.id).sort((a,b) => new Date(b.date) - new Date(a.date))[0];
            return `<tr>
                <td>${s.rollNumber}</td><td>${s.name}</td><td>${s.course}</td><td>${s.syllabus}</td>
                <td>‚Çπ${s.monthlyFee}</td>
                <td><span class="badge ${s.hasPaid ? 'badge-paid' : 'badge-pending'}">${s.hasPaid ? 'Paid' : 'Pending'}</span></td>
                <td>${last ? last.date : 'No payment yet'}</td>
            </tr>`;
        }).join('') || '<tr><td colspan="7" style="text-align:center;padding:30px;color:#999;">No students found.</td></tr>';
    };

    document.getElementById('studentSearch').addEventListener('input', updateStudentTable);
    document.getElementById('feeStudent').addEventListener('change', function() {
        const student = window.students.find(s => s.id === this.value);
        if (student) document.getElementById('feeAmount').value = student.monthlyFee;
    });

    // ---- Teachers ----
    document.getElementById('teacherForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        if (userRole === 'staff') { alert('No permission.'); return; }
        const submitBtn = e.target.querySelector('button[type="submit"]');
        submitBtn.disabled = true; submitBtn.textContent = 'Adding...';
        try {
            await addDoc(collection(db, 'teachers'), {
                name: document.getElementById('teacherName').value,
                employeeId: document.getElementById('employeeId').value,
                subject: document.getElementById('teacherSubject').value || '-',
                phone: document.getElementById('teacherPhone').value,
                email: document.getElementById('teacherEmail').value || '-',
                salary: parseFloat(document.getElementById('teacherSalary').value),
                joiningDate: document.getElementById('teacherJoiningDate').value || '-',
                status: document.getElementById('teacherStatus').value,
                createdAt: new Date().toISOString()
            });
            alert('‚úÖ Teacher added!');
            this.reset();
        } catch (error) { alert('Error: ' + error.message); }
        finally { submitBtn.disabled = false; submitBtn.textContent = 'Add Teacher'; }
    });

    window.updateTeacherTable = function() {
        const tbody = document.getElementById('teacherTableBody');
        const searchTerm = document.getElementById('teacherSearch')?.value.toLowerCase() || '';
        const filtered = window.teachers.filter(t =>
            t.name.toLowerCase().includes(searchTerm) || t.employeeId.toLowerCase().includes(searchTerm)
        );
        tbody.innerHTML = filtered.map(t => {
            const actionsCell = userRole === 'staff' ? '' : `<td><button class="btn btn-danger" onclick="deleteTeacher('${t.id}')" style="padding:5px 15px;">Delete</button></td>`;
            return `<tr>
                <td>${t.employeeId}</td><td>${t.name}</td><td>${t.subject}</td><td>${t.phone}</td>
                <td>${t.email}</td><td>‚Çπ${t.salary.toLocaleString()}</td><td>${t.joiningDate}</td>
                <td><span class="badge ${t.status === 'Active' ? 'badge-active' : 'badge-inactive'}">${t.status}</span></td>
                ${actionsCell}
            </tr>`;
        }).join('');
    };

    document.getElementById('teacherSearch')?.addEventListener('input', updateTeacherTable);

    window.deleteTeacher = async function(id) {
        if (userRole === 'staff') { alert('No permission.'); return; }
        if (!confirm('Delete this teacher?')) return;
        try { await deleteDoc(doc(db, 'teachers', id)); alert('Teacher deleted!'); }
        catch (error) { alert('Error: ' + error.message); }
    };

    window.updateSalaryTeacherSelect = function() {
        const select = document.getElementById('salaryTeacher');
        select.innerHTML = '<option value="">Choose teacher...</option>' +
            window.teachers.filter(t => t.status === 'Active').map(t => `<option value="${t.id}">${t.employeeId} - ${t.name}</option>`).join('');
    };

    document.getElementById('salaryTeacher')?.addEventListener('change', function() {
        const teacher = window.teachers.find(t => t.id === this.value);
        if (teacher) document.getElementById('salaryAmount').value = teacher.salary;
    });

    window.paySalary = async function() {
        if (userRole === 'staff') { alert('No permission.'); return; }
        const teacherId = document.getElementById('salaryTeacher').value;
        const month = document.getElementById('salaryMonth').value;
        const amount = parseFloat(document.getElementById('salaryAmount').value);
        const method = document.getElementById('salaryPaymentMethod').value;
        if (!teacherId || !month || !amount || !method) { alert('Please fill all fields'); return; }
        if (window.salaries.some(s => s.teacherId === teacherId && s.month === month)) {
            alert('‚ùå Salary already paid for this month!'); return;
        }
        try {
            await addDoc(collection(db, 'salaries'), {
                receiptNo: 'SAL' + Date.now().toString().slice(-6),
                teacherId, month, amount, method,
                date: new Date().toISOString().slice(0,10),
                createdAt: new Date().toISOString()
            });
            document.getElementById('salaryTeacher').value = '';
            document.getElementById('salaryAmount').value = '';
            document.getElementById('salaryPaymentMethod').value = '';
            alert('‚úÖ Salary paid!');
        } catch (error) { alert('Error: ' + error.message); }
    };

    window.updateSalaryTable = function() {
        const tbody = document.getElementById('salaryTableBody');
        tbody.innerHTML = window.salaries.slice(0,20).map(salary => {
            const teacher = window.teachers.find(t => t.id === salary.teacherId);
            const actionsCell = userRole === 'staff' ? '' : `<td><button class="btn btn-danger" onclick="deleteSalary('${salary.id}','${teacher?.name||'Unknown'}','${salary.month}',${salary.amount})" style="padding:5px 15px;">Delete</button></td>`;
            return `<tr>
                <td>${salary.receiptNo}</td><td>${salary.date}</td>
                <td>${teacher?.employeeId||'N/A'}</td><td>${teacher?.name||'Unknown'}</td>
                <td>${salary.month}</td><td>‚Çπ${salary.amount.toLocaleString()}</td><td>${salary.method}</td>
                ${actionsCell}
            </tr>`;
        }).join('');
    };

    window.deleteSalary = async function(id, name, month, amount) {
        if (userRole === 'staff') { alert('No permission.'); return; }
        if (!confirm(`Delete salary payment?\nTeacher: ${name}\nMonth: ${month}\nAmount: ‚Çπ${amount}`)) return;
        try { await deleteDoc(doc(db, 'salaries', id)); alert('‚úÖ Deleted!'); }
        catch (error) { alert('Error: ' + error.message); }
    };

    // ---- Expenses ----
    document.getElementById('expenseForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        if (userRole === 'staff') { alert('No permission.'); return; }
        const submitBtn = e.target.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        const isEditing = editingExpenseId !== null;
        submitBtn.textContent = isEditing ? 'Updating...' : 'Adding...';
        try {
            const expenseData = {
                type: document.getElementById('expenseType').value,
                description: document.getElementById('expenseDescription').value,
                amount: parseFloat(document.getElementById('expenseAmount').value),
                date: document.getElementById('expenseDate').value,
                paymentMethod: document.getElementById('expensePaymentMethod').value,
                paidTo: document.getElementById('expensePaidTo').value || '-',
                forMonth: document.getElementById('expenseForMonth').value || '-',
                notes: document.getElementById('expenseNotes').value || '-'
            };
            if (isEditing) {
                await updateDoc(doc(db, 'expenses', editingExpenseId), { ...expenseData, updatedAt: new Date().toISOString() });
                alert('‚úÖ Expense updated!');
                cancelExpenseEdit();
            } else {
                await addDoc(collection(db, 'expenses'), { ...expenseData, createdAt: new Date().toISOString() });
                alert('‚úÖ Expense added!');
            }
            this.reset();
            document.getElementById('expenseDate').value = new Date().toISOString().slice(0,10);
        } catch (error) { alert('Error: ' + error.message); }
        finally { submitBtn.disabled = false; submitBtn.textContent = isEditing ? 'Update Expense' : 'Add Expense'; }
    });

    window.updateExpenseTable = function() {
        const tbody = document.getElementById('expenseTableBody');
        const searchTerm = document.getElementById('expenseSearch')?.value.toLowerCase() || '';
        const typeFilter = document.getElementById('expenseFilterType')?.value || '';
        const monthFilter = document.getElementById('expenseFilterMonth')?.value || '';
        let filtered = window.expenses.filter(e => {
            const matchSearch = e.description.toLowerCase().includes(searchTerm) || e.type.toLowerCase().includes(searchTerm) || (e.paidTo && e.paidTo.toLowerCase().includes(searchTerm));
            const matchType = !typeFilter || e.type === typeFilter;
            const matchMonth = !monthFilter || e.forMonth === monthFilter || e.date.startsWith(monthFilter);
            return matchSearch && matchType && matchMonth;
        });
        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:30px;color:#999;">No expenses found.</td></tr>';
            return;
        }
        tbody.innerHTML = filtered.map(e => {
            const actionsCell = userRole === 'staff' ? '' : `<td><div class="action-buttons">
                <button class="btn btn-warning" onclick="editExpense('${e.id}')" style="padding:5px 15px;">Edit</button>
                <button class="btn btn-danger" onclick="deleteExpense('${e.id}')" style="padding:5px 15px;">Delete</button>
            </div></td>`;
            return `<tr>
                <td>${e.date}</td><td><span class="badge badge-active">${e.type}</span></td>
                <td>${e.description}</td><td style="font-weight:600;color:#dc3545;">‚Çπ${e.amount.toLocaleString()}</td>
                <td>${e.forMonth === '-' ? '-' : e.forMonth}</td><td>${e.paidTo}</td>
                <td>${e.paymentMethod}</td><td style="font-size:0.9em;color:#666;">${e.notes}</td>
                ${actionsCell}
            </tr>`;
        }).join('');
    };

    document.getElementById('expenseSearch')?.addEventListener('input', updateExpenseTable);

    window.clearExpenseFilters = function() {
        document.getElementById('expenseFilterType').value = '';
        document.getElementById('expenseFilterMonth').value = '';
        updateExpenseTable();
    };

    window.editExpense = function(id) {
        if (userRole === 'staff') { alert('No permission.'); return; }
        const expense = window.expenses.find(e => e.id === id);
        if (expense) {
            editingExpenseId = id;
            document.getElementById('expenseType').value = expense.type;
            document.getElementById('expenseDescription').value = expense.description;
            document.getElementById('expenseAmount').value = expense.amount;
            document.getElementById('expenseDate').value = expense.date;
            document.getElementById('expensePaymentMethod').value = expense.paymentMethod;
            document.getElementById('expensePaidTo').value = expense.paidTo === '-' ? '' : expense.paidTo;
            document.getElementById('expenseForMonth').value = expense.forMonth === '-' ? '' : expense.forMonth;
            document.getElementById('expenseNotes').value = expense.notes === '-' ? '' : expense.notes;
            const submitBtn = document.querySelector('#expenseForm button[type="submit"]');
            submitBtn.textContent = 'Update Expense';
            submitBtn.classList.add('btn-warning');
            submitBtn.classList.remove('btn-primary');
            if (!document.getElementById('cancelExpenseEditBtn')) {
                const cancelBtn = document.createElement('button');
                cancelBtn.type = 'button'; cancelBtn.id = 'cancelExpenseEditBtn';
                cancelBtn.className = 'btn btn-danger'; cancelBtn.textContent = 'Cancel Edit';
                cancelBtn.onclick = cancelExpenseEdit; cancelBtn.style.marginLeft = '10px';
                submitBtn.parentNode.appendChild(cancelBtn);
            }
            document.getElementById('expenseFormSection').scrollIntoView({ behavior: 'smooth' });
        }
    };

    function cancelExpenseEdit() {
        editingExpenseId = null;
        document.getElementById('expenseForm').reset();
        document.getElementById('expenseDate').value = new Date().toISOString().slice(0,10);
        const submitBtn = document.querySelector('#expenseForm button[type="submit"]');
        submitBtn.textContent = 'Add Expense';
        submitBtn.classList.remove('btn-warning');
        submitBtn.classList.add('btn-primary');
        const cancelBtn = document.getElementById('cancelExpenseEditBtn');
        if (cancelBtn) cancelBtn.remove();
    }

    window.deleteExpense = async function(id) {
        if (userRole === 'staff') { alert('No permission.'); return; }
        if (!confirm('Delete this expense?')) return;
        try { await deleteDoc(doc(db, 'expenses', id)); alert('Expense deleted!'); }
        catch (error) { alert('Error: ' + error.message); }
    };

    window.updateExpenseSummary = function() {
        const currentMonth = new Date().toISOString().slice(0,7);
        const total = window.expenses.reduce((sum, e) => sum + e.amount, 0);
        const thisMonth = window.expenses.filter(e => e.date.startsWith(currentMonth) || e.forMonth === currentMonth).reduce((sum, e) => sum + e.amount, 0);
        document.getElementById('totalExpenses').textContent = '‚Çπ' + total.toLocaleString();
        document.getElementById('thisMonthExpenses').textContent = '‚Çπ' + thisMonth.toLocaleString();
        document.getElementById('expenseCount').textContent = window.expenses.length;
    };

    // ---- WhatsApp ----
    window.sendWhatsAppReminder = async function(studentId, phone, studentName, monthlyFee) {
        let cleanPhone = phone.replace(/\D/g, '');
        if (cleanPhone.length === 10) cleanPhone = '91' + cleanPhone;
        const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
        const currentMonth = monthNames[new Date().getMonth()];
        const currentMonthCode = new Date().toISOString().slice(0,7);
        const message = `Dear ${studentName},\n\nThis is a friendly reminder from Vismaya Education regarding your fee payment.\n\nüìö *Fee Details:*\n‚Ä¢ Month: ${currentMonth}\n‚Ä¢ Amount: ‚Çπ${monthlyFee}\n\nPlease make the payment at your earliest convenience.\n\nThank you!\n*Vismaya Education*`;
        try {
            await addDoc(collection(db, 'reminders'), { studentId, month: currentMonthCode, sentAt: new Date().toISOString(), sentBy: currentUser.email, phone, studentName });
            window.open(`https://wa.me/${cleanPhone}?text=${encodeURIComponent(message)}`, '_blank');
        } catch (error) { window.open(`https://wa.me/${cleanPhone}?text=${encodeURIComponent(message)}`, '_blank'); }
    };

    window.sendBulkWhatsAppReminders = function() {
        const currentMonth = new Date().toISOString().slice(0,7);
        const unpaid = window.students.filter(s => !window.payments.some(p => p.studentId === s.id && p.month === currentMonth) && s.status === 'Active');
        if (unpaid.length === 0) { alert('‚úÖ All active students have paid!'); return; }
        if (confirm(`Send WhatsApp reminders to ${unpaid.length} students?`)) {
            unpaid.forEach((s, i) => setTimeout(() => sendWhatsAppReminder(s.id, s.phone, s.name, s.monthlyFee), i * 2000));
        }
    };

    // ---- Accounts ----
    window.generateAccountsSummary = function() {
        const month = document.getElementById('accountsMonth').value;
        if (!month) { alert('Please select a month.'); return; }
        const monthPayments = window.payments.filter(p => p.month === month);
        const totalFees = monthPayments.reduce((sum, p) => sum + p.amount, 0);
        const monthSalaries = window.salaries.filter(s => s.month === month);
        const totalSalary = monthSalaries.reduce((sum, s) => sum + s.amount, 0);
        const monthExpenses = window.expenses.filter(e => e.date.startsWith(month) || e.forMonth === month);
        const totalExpenses = monthExpenses.reduce((sum, e) => sum + e.amount, 0);
        const totalExpenditure = totalSalary + totalExpenses;
        const netResult = totalFees - totalExpenditure;
        const isProfit = netResult >= 0;

        currentAccountsData = { month, monthPayments, monthSalaries, monthExpenses, totalFees, totalSalary, totalExpenses, totalExpenditure, netResult };

        document.getElementById('accTotalFees').textContent = '‚Çπ' + totalFees.toLocaleString();
        document.getElementById('accTotalSalary').textContent = '‚Çπ' + totalSalary.toLocaleString();
        document.getElementById('accTotalExpenses').textContent = '‚Çπ' + totalExpenses.toLocaleString();
        document.getElementById('accTotalExpenditure').textContent = '‚Çπ' + totalExpenditure.toLocaleString();

        const monthLabel = new Date(month + '-01').toLocaleDateString('en-IN', { month: 'long', year: 'numeric' });
        document.getElementById('netResultBanner').innerHTML = `
            <div class="net-result-banner ${isProfit ? 'profit-banner' : 'loss-banner'}">
                <div>
                    <div class="net-label">${monthLabel} ‚Äî ${isProfit ? 'üü¢ Net Profit' : 'üî¥ Net Loss'}</div>
                    <div class="net-formula">‚Çπ${totalFees.toLocaleString()} (Fees) ‚àí ‚Çπ${totalSalary.toLocaleString()} (Salary) ‚àí ‚Çπ${totalExpenses.toLocaleString()} (Expenses)</div>
                </div>
                <div class="net-value">${isProfit ? '+' : ''}‚Çπ${Math.abs(netResult).toLocaleString()}</div>
            </div>`;

        const feeBody = document.getElementById('feeBreakdownBody');
        feeBody.innerHTML = monthPayments.length === 0 ? '<div class="accounts-breakdown-empty">No fees this month</div>' :
            monthPayments.map(p => { const s = window.students.find(st => st.id === p.studentId); return `<div class="accounts-breakdown-row"><span class="row-label">${s?.name||'Unknown'} (${s?.rollNumber||'N/A'})</span><span class="row-amount green">‚Çπ${p.amount.toLocaleString()}</span></div>`; }).join('');
        document.getElementById('feeBreakdownTotal').textContent = '‚Çπ' + totalFees.toLocaleString();

        const expBody = document.getElementById('expenseBreakdownBody');
        expBody.innerHTML = monthExpenses.length === 0 ? '<div class="accounts-breakdown-empty">No expenses this month</div>' :
            monthExpenses.map(e => `<div class="accounts-breakdown-row"><span class="row-label">${e.description}</span><span class="row-amount red">‚Çπ${e.amount.toLocaleString()}</span></div>`).join('');
        document.getElementById('expenseBreakdownTotal').textContent = '‚Çπ' + totalExpenses.toLocaleString();

        const salBody = document.getElementById('salaryBreakdownBody');
        salBody.innerHTML = monthSalaries.length === 0 ? '<div class="accounts-breakdown-empty">No salary this month</div>' :
            monthSalaries.map(s => { const t = window.teachers.find(tc => tc.id === s.teacherId); return `<div class="accounts-breakdown-row"><span class="row-label">${t?.name||'Unknown'}</span><span class="row-amount orange">‚Çπ${s.amount.toLocaleString()}</span></div>`; }).join('');
        document.getElementById('salaryBreakdownTotal').textContent = '‚Çπ' + totalSalary.toLocaleString();

        const catMap = {};
        monthExpenses.forEach(e => { catMap[e.type] = (catMap[e.type] || 0) + e.amount; });
        const catBody = document.getElementById('categoryBreakdownBody');
        catBody.innerHTML = Object.keys(catMap).length === 0 ? '<div class="accounts-breakdown-empty">No expenses this month</div>' :
            Object.entries(catMap).map(([type, amount]) => `<div class="accounts-breakdown-row"><span class="row-label">${type}</span><span class="row-amount red">‚Çπ${amount.toLocaleString()}</span></div>`).join('');
        document.getElementById('categoryBreakdownTotal').textContent = '‚Çπ' + totalExpenses.toLocaleString();

        generateMonthlyHistory();

        document.getElementById('netResultBanner').style.display = 'block';
        document.getElementById('accountsSummaryGrid').style.display = 'grid';
        document.getElementById('accountsBreakdown').style.display = 'grid';
        document.getElementById('monthlyHistorySection').style.display = 'block';
        document.getElementById('exportAccountsBtn').style.display = 'inline-block';
    };

    function generateMonthlyHistory() {
        const allMonths = new Set();
        window.payments.forEach(p => allMonths.add(p.month));
        window.salaries.forEach(s => allMonths.add(s.month));
        window.expenses.forEach(e => { if (e.forMonth && e.forMonth !== '-') allMonths.add(e.forMonth); else allMonths.add(e.date.slice(0,7)); });
        const sorted = Array.from(allMonths).sort((a,b) => b.localeCompare(a));
        const tbody = document.getElementById('monthlyHistoryBody');
        if (sorted.length === 0) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;color:#999;">No data available</td></tr>'; return; }
        tbody.innerHTML = sorted.map(m => {
            const fees = window.payments.filter(p => p.month === m).reduce((sum, p) => sum + p.amount, 0);
            const salary = window.salaries.filter(s => s.month === m).reduce((sum, s) => sum + s.amount, 0);
            const expenses = window.expenses.filter(e => e.date.startsWith(m) || e.forMonth === m).reduce((sum, e) => sum + e.amount, 0);
            const exp = salary + expenses;
            const net = fees - exp;
            const isP = net >= 0;
            const label = new Date(m + '-01').toLocaleDateString('en-IN', { month: 'long', year: 'numeric' });
            return `<tr class="${isP ? 'profit-row' : 'loss-row'}">
                <td><strong>${label}</strong></td>
                <td style="color:#28a745;font-weight:600;">‚Çπ${fees.toLocaleString()}</td>
                <td style="color:#fd7e14;font-weight:600;">‚Çπ${salary.toLocaleString()}</td>
                <td style="color:#dc3545;font-weight:600;">‚Çπ${expenses.toLocaleString()}</td>
                <td style="color:#dc3545;font-weight:700;">‚Çπ${exp.toLocaleString()}</td>
                <td style="font-weight:700;color:${isP?'#28a745':'#dc3545'};">${isP?'üü¢ +':'üî¥ '}‚Çπ${Math.abs(net).toLocaleString()}</td>
            </tr>`;
        }).join('');
    }

    window.exportAccountsToExcel = function() {
        if (!currentAccountsData) { alert('Please generate a summary first.'); return; }
        const { month, monthPayments, monthSalaries, monthExpenses, totalFees, totalSalary, totalExpenses, totalExpenditure, netResult } = currentAccountsData;
        const monthLabel = new Date(month + '-01').toLocaleDateString('en-IN', { month: 'long', year: 'numeric' });
        const wb = XLSX.utils.book_new();
        const summaryData = [
            ['Vismaya Education - Monthly Accounts Summary'],
            ['Month:', monthLabel], ['Generated On:', new Date().toLocaleDateString('en-IN')], [],
            ['Category', 'Amount (‚Çπ)'],
            ['Total Fees Collected', totalFees], ['Salary Paid', totalSalary],
            ['Other Expenses', totalExpenses], ['Total Expenditure', totalExpenditure], ['Net Profit / Loss', netResult]
        ];
        const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
        wsSummary['!cols'] = [{ wch: 30 },{ wch: 20 }];
        XLSX.utils.book_append_sheet(wb, wsSummary, 'Summary');
        XLSX.writeFile(wb, `Accounts_${month}_${new Date().toISOString().slice(0,10)}.xlsx`);
    };

    // ---- Excel Exports ----
    window.exportStudentsToExcel = function() {
        const currentMonth = new Date().toISOString().slice(0,7);
        const data = window.students.map(s => ({
            'Roll Number': s.rollNumber, 'Name': s.name, 'Class': s.course, 'Syllabus': s.syllabus,
            'Phone': s.phone, 'Monthly Fee': s.monthlyFee, 'Admission Date': s.admissionDate,
            'Status': s.status, 'Fee Status (This Month)': window.payments.some(p => p.studentId === s.id && p.month === currentMonth) ? 'Paid' : 'Pending'
        }));
        const ws = XLSX.utils.json_to_sheet(data);
        ws['!cols'] = [{ wch:12 },{ wch:25 },{ wch:12 },{ wch:12 },{ wch:15 },{ wch:12 },{ wch:15 },{ wch:10 },{ wch:20 }];
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Students');
        XLSX.writeFile(wb, `Students_${new Date().toISOString().slice(0,10)}.xlsx`);
    };

    window.exportRecentPaymentsToExcel = function() {
        const data = window.payments.slice(0,20).map(p => {
            const s = window.students.find(st => st.id === p.studentId);
            return { 'Receipt No': p.receiptNo, 'Date': p.date, 'Roll Number': s?.rollNumber||'N/A', 'Student Name': s?.name||'Unknown', 'Class': s?.course||'N/A', 'Fee Month': p.month, 'Amount': p.amount, 'Payment Method': p.method };
        });
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Recent Payments');
        XLSX.writeFile(wb, `Recent_Payments_${new Date().toISOString().slice(0,10)}.xlsx`);
    };

    window.generatePaidStudentsReport = function() {
        const month = document.getElementById('paidReportMonth').value;
        const classFilter = document.getElementById('paidReportClass').value;
        const methodFilter = document.getElementById('paidReportMethod').value;
        let monthPayments = window.payments.filter(p => p.month === month);
        if (methodFilter) monthPayments = monthPayments.filter(p => p.method === methodFilter);
        const paidData = [];
        monthPayments.forEach(payment => {
            const student = window.students.find(s => s.id === payment.studentId);
            if (student && (!classFilter || student.course === classFilter)) paidData.push({ student, payment });
        });
        filteredPaidStudents = paidData;
        const total = paidData.length;
        const totalAmount = paidData.reduce((sum, item) => sum + item.payment.amount, 0);
        document.getElementById('paidReportCount').textContent = total;
        document.getElementById('paidReportTotal').textContent = '‚Çπ' + totalAmount.toLocaleString();
        document.getElementById('paidReportAverage').textContent = '‚Çπ' + Math.round(total > 0 ? totalAmount/total : 0).toLocaleString();
        document.getElementById('paidReportSummary').style.display = 'block';
        document.getElementById('paidStudentsTableContainer').style.display = 'block';
        document.getElementById('exportPaidReportBtn').style.display = 'inline-block';
        updatePaidStudentsTable(paidData);
    };

    function updatePaidStudentsTable(data) {
        const tbody = document.getElementById('paidStudentsTableBody');
        if (data.length === 0) { tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:30px;color:#999;">No students found.</td></tr>'; return; }
        tbody.innerHTML = data.map((item, i) => `<tr>
            <td>${i+1}</td><td>${item.student.rollNumber}</td><td>${item.student.name}</td>
            <td>${item.student.course}</td><td>${item.student.phone}</td>
            <td>‚Çπ${item.payment.amount}</td><td>${item.payment.date}</td>
            <td><span class="badge badge-active">${item.payment.method}</span></td>
            <td>${item.payment.receiptNo}</td>
        </tr>`).join('');
    }

    window.filterPaidStudentsTable = function() {
        const search = document.getElementById('paidStudentsSearch').value.toLowerCase();
        updatePaidStudentsTable(filteredPaidStudents.filter(item => item.student.name.toLowerCase().includes(search) || item.student.rollNumber.toLowerCase().includes(search)));
    };

    window.exportPaidStudentsReport = function() {
        if (filteredPaidStudents.length === 0) { alert('Generate a report first.'); return; }
        const month = document.getElementById('paidReportMonth').value;
        const data = filteredPaidStudents.map((item, i) => ({
            'S.No': i+1, 'Roll Number': item.student.rollNumber, 'Student Name': item.student.name,
            'Class': item.student.course, 'Syllabus': item.student.syllabus, 'Phone': item.student.phone,
            'Monthly Fee': item.student.monthlyFee, 'Amount Paid': item.payment.amount,
            'Payment Date': item.payment.date, 'Payment Method': item.payment.method, 'Receipt No': item.payment.receiptNo
        }));
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Paid Students');
        XLSX.writeFile(wb, `Paid_Students_${month}_${new Date().toISOString().slice(0,10)}.xlsx`);
    };

    window.exportTeachersToExcel = function() {
        const data = window.teachers.map(t => ({ 'Employee ID': t.employeeId, 'Name': t.name, 'Subject': t.subject, 'Phone': t.phone, 'Email': t.email, 'Monthly Salary': t.salary, 'Joining Date': t.joiningDate, 'Status': t.status }));
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Teachers');
        XLSX.writeFile(wb, `Teachers_${new Date().toISOString().slice(0,10)}.xlsx`);
    };

    window.exportSalaryPaymentsToExcel = function() {
        const data = window.salaries.map(s => {
            const t = window.teachers.find(tc => tc.id === s.teacherId);
            return { 'Receipt No': s.receiptNo, 'Date': s.date, 'Employee ID': t?.employeeId||'N/A', 'Teacher Name': t?.name||'Unknown', 'Month': s.month, 'Amount': s.amount, 'Payment Method': s.method };
        });
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Salary Payments');
        XLSX.writeFile(wb, `Salary_Payments_${new Date().toISOString().slice(0,10)}.xlsx`);
    };

    window.exportExpensesToExcel = function() {
        const data = window.expenses.map(e => ({ 'Date': e.date, 'Type': e.type, 'Description': e.description, 'Amount': e.amount, 'For Month': e.forMonth, 'Paid To': e.paidTo, 'Payment Method': e.paymentMethod, 'Notes': e.notes }));
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Expenses');
        XLSX.writeFile(wb, `Expenses_${new Date().toISOString().slice(0,10)}.xlsx`);
    };

    window.downloadTemplate = function() {
        const template = [
            ['Student Name','Roll Number','Class','Syllabus','Phone Number','Monthly Fee','Admission Date','Status'],
            ['John Doe','001','Class 10','CBSE','9876543210','5000','01/01/2024','Active'],
            ['Jane Smith','002','Class 11','Matric','9876543211','6000','','Active']
        ];
        const ws = XLSX.utils.aoa_to_sheet(template);
        ws['!cols'] = [{ wch:20 },{ wch:12 },{ wch:12 },{ wch:12 },{ wch:15 },{ wch:12 },{ wch:15 },{ wch:10 }];
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Students');
        XLSX.writeFile(wb, 'Student_Upload_Template.xlsx');
    };

    window.uploadExcel = async function() {
        if (userRole === 'staff') { alert('No permission.'); return; }
        const fileInput = document.getElementById('excelFile');
        const file = fileInput.files[0];
        if (!file) { alert('Please select an Excel file first.'); return; }
        const statusDiv = document.getElementById('uploadStatus');
        statusDiv.style.display = 'block';
        statusDiv.style.background = '#fff3cd'; statusDiv.style.color = '#856404';
        statusDiv.textContent = '‚è≥ Reading Excel file...';
        try {
            const data = await file.arrayBuffer();
            const workbook = XLSX.read(data);
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            if (jsonData.length < 2) throw new Error('Excel file is empty or has no data rows.');
            const rows = jsonData.slice(1);
            let successCount = 0, errorCount = 0;
            const errors = [];
            statusDiv.textContent = `‚è≥ Uploading ${rows.length} students...`;
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                if (!row || row.length === 0 || !row[0]) continue;
                try {
                    let admissionDate = row[6];
                    if (admissionDate) {
                        if (typeof admissionDate === 'number') {
                            const excelEpoch = new Date(1900, 0, 1);
                            admissionDate = new Date(excelEpoch.getTime() + (admissionDate - 2) * 86400000).toISOString().slice(0,10);
                        } else if (typeof admissionDate === 'string' && admissionDate.includes('/')) {
                            const parts = admissionDate.split('/');
                            if (parts.length === 3) admissionDate = `${parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`;
                        }
                    } else { admissionDate = '-'; }
                    const student = {
                        name: String(row[0]||'').trim(), rollNumber: String(row[1]||'').trim(),
                        course: String(row[2]||'').trim(), syllabus: String(row[3]||'').trim() || '-',
                        phone: String(row[4]||'').trim(), monthlyFee: parseFloat(row[5]) || 0,
                        admissionDate, status: String(row[7]||'').trim() || 'Active', createdAt: new Date().toISOString()
                    };
                    if (!student.name || !student.rollNumber || !student.course || !student.phone || !student.monthlyFee || !student.status) {
                        errors.push(`Row ${i+2}: Missing required fields`); errorCount++; continue;
                    }
                    if (student.status !== 'Active' && student.status !== 'Inactive') {
                        errors.push(`Row ${i+2}: Status must be "Active" or "Inactive"`); errorCount++; continue;
                    }
                    if (window.students.find(s => s.rollNumber === student.rollNumber)) {
                        errors.push(`Row ${i+2}: Roll number ${student.rollNumber} already exists`); errorCount++; continue;
                    }
                    await addDoc(collection(db, 'students'), student);
                    successCount++;
                    statusDiv.textContent = `‚è≥ Uploaded ${successCount} of ${rows.length} students...`;
                } catch (error) { errors.push(`Row ${i+2}: ${error.message}`); errorCount++; }
            }
            if (successCount > 0 && errorCount === 0) {
                statusDiv.style.background = '#d4edda'; statusDiv.style.color = '#155724';
                statusDiv.innerHTML = `‚úÖ Successfully uploaded ${successCount} student(s)!`;
            } else if (successCount > 0) {
                statusDiv.style.background = '#fff3cd'; statusDiv.style.color = '#856404';
                statusDiv.innerHTML = `‚ö†Ô∏è Uploaded ${successCount}. ${errorCount} failed.<details style="margin-top:10px;"><summary>View Errors</summary><pre style="margin-top:5px;font-size:0.85em;">${errors.join('\n')}</pre></details>`;
            } else {
                statusDiv.style.background = '#f8d7da'; statusDiv.style.color = '#721c24';
                statusDiv.innerHTML = `‚ùå Upload failed. ${errorCount} error(s).<details style="margin-top:10px;"><summary>View Errors</summary><pre>${errors.join('\n')}</pre></details>`;
            }
            fileInput.value = '';
        } catch (error) {
            statusDiv.style.background = '#f8d7da'; statusDiv.style.color = '#721c24';
            statusDiv.textContent = `‚ùå Error: ${error.message}`;
        }
    };

    function getErrorMessage(code) {
        const messages = {
            'auth/email-already-in-use': 'This email is already registered.',
            'auth/invalid-email': 'Invalid email address.',
            'auth/weak-password': 'Password should be at least 6 characters.',
            'auth/user-disabled': 'This account has been disabled.',
            'auth/user-not-found': 'No account found with this email.',
            'auth/wrong-password': 'Incorrect password.',
            'auth/invalid-credential': 'Invalid email or password.',
            'auth/too-many-requests': 'Too many attempts. Please try again later.'
        };
        return messages[code] || 'An error occurred. Please try again.';
    }
</script>
</body>
</html>
